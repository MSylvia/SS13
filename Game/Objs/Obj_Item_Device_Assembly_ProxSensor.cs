// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Item_Device_Assembly_ProxSensor : Obj_Item_Device_Assembly {

		public double? scanning = 0;
		public double? timing = 0;
		public dynamic time = 10;
		public int sensitivity = 1;
		public dynamic oldloc = null;
		public ByTable turfs_around = new ByTable();

		protected override void __FieldInit() {
			base.__FieldInit();

			this.materials = new ByTable().Set( "$metal", 800 ).Set( "$glass", 200 );
			this.attachable = true;
			this.icon_state = "prox";
		}

		// Function from file: proximity.dm
		public Obj_Item_Device_Assembly_ProxSensor ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			GlobalVars.SSobj.processing.Or( this );
			this.oldloc = this.loc;
			return;
		}

		// Function from file: proximity.dm
		public override dynamic Topic( string href = null, ByTable href_list = null, dynamic hsrc = null ) {
			double? tp = null;

			base.Topic( href, href_list, (object)(hsrc) );

			if ( Task13.User.incapacitated() || !( Map13.GetDistance( this.loc, Task13.User ) <= 1 ) ) {
				Interface13.Browse( Task13.User, null, "window=prox" );
				GlobalFuncs.onclose( Task13.User, "prox" );
				return null;
			}

			if ( Lang13.Bool( href_list["sense"] ) ) {
				this.sensitivity_change( ( href_list["sense"] == "up" ? 1 : -1 ) );
			}

			if ( Lang13.Bool( href_list["scanning"] ) ) {
				this.toggle_scan( String13.ParseNumber( href_list["scanning"] ) );
			}

			if ( Lang13.Bool( href_list["time"] ) ) {
				this.timing = String13.ParseNumber( href_list["time"] );
				this.update_icon();
			}

			if ( Lang13.Bool( href_list["tp"] ) ) {
				tp = String13.ParseNumber( href_list["tp"] );
				this.time += tp;
				this.time = Num13.MinInt( Num13.MaxInt( Num13.Floor( Convert.ToDouble( this.time ) ), 0 ), 600 );
			}

			if ( Lang13.Bool( href_list["close"] ) ) {
				Interface13.Browse( Task13.User, null, "window=prox" );
				return null;
			}

			if ( Task13.User != null ) {
				this.attack_self( Task13.User );
			}
			return null;
		}

		// Function from file: proximity.dm
		public override dynamic interact( dynamic user = null, bool? flag1 = null ) {
			dynamic second = null;
			dynamic minute = null;
			string dat = null;

			
			if ( this.is_secured( user ) ) {
				second = this.time % 60;
				minute = ( this.time - second ) / 60;
				dat = new Txt( "<TT><B>Proximity Sensor</B>\n" ).item( ( Lang13.Bool( this.timing ) ? new Txt( "<A href='?src=" ).Ref( this ).str( ";time=0'>Arming</A>" ).ToString() : new Txt( "<A href='?src=" ).Ref( this ).str( ";time=1'>Not Arming</A>" ).ToString() ) ).str( " " ).item( minute ).str( ":" ).item( second ).str( "\n<A href='?src=" ).Ref( this ).str( ";tp=-30'>-</A> <A href='?src=" ).Ref( this ).str( ";tp=-1'>-</A> <A href='?src=" ).Ref( this ).str( ";tp=1'>+</A> <A href='?src=" ).Ref( this ).str( ";tp=30'>+</A>\n</TT>" ).ToString();
				dat += new Txt( "<BR><A href='?src=" ).Ref( this ).str( ";scanning=" ).item( ( Lang13.Bool( this.scanning ) ? "0'>Armed" : "1'>Unarmed" ) ).str( "</A> (Movement sensor active when armed!)" ).ToString();
				dat += new Txt( "<BR>Detection range: <A href='?src=" ).Ref( this ).str( ";sense=down'>-</A> " ).item( this.sensitivity ).str( " <A href='?src=" ).Ref( this ).str( ";sense=up'>+</A>" ).ToString();
				dat += new Txt( "<BR><BR><A href='?src=" ).Ref( this ).str( ";refresh=1'>Refresh</A>" ).ToString();
				dat += new Txt( "<BR><BR><A href='?src=" ).Ref( this ).str( ";close=1'>Close</A>" ).ToString();
				Interface13.Browse( user, dat, "window=prox" );
				GlobalFuncs.onclose( user, "prox" );
				return null;
			}
			return null;
		}

		// Function from file: proximity.dm
		public override bool Move( dynamic NewLoc = null, int? Dir = null, int step_x = 0, int step_y = 0 ) {
			base.Move( (object)(NewLoc), Dir, step_x, step_y );
			this.handle_move( NewLoc );
			return false;
		}

		// Function from file: proximity.dm
		public override bool update_icon( dynamic new_state = null, dynamic new_icon = null, int? new_px = null, int? new_py = null ) {
			this.overlays.Cut();
			this.attached_overlays = new ByTable();

			if ( Lang13.Bool( this.timing ) ) {
				this.overlays.Add( "prox_timing" );
				this.attached_overlays.Add( "prox_timing" );
			}

			if ( Lang13.Bool( this.scanning ) ) {
				this.overlays.Add( "prox_scanning" );
				this.attached_overlays.Add( "prox_scanning" );
			}

			if ( this.holder != null ) {
				this.holder.update_icon();
			}
			return false;
		}

		// Function from file: proximity.dm
		public bool toggle_scan( double? scan = null ) {
			
			if ( !this.secured ) {
				return false;
			}
			this.scanning = scan;

			if ( Lang13.Bool( this.scanning ) ) {
				GlobalFuncs.add_to_proximity_list( this, this.sensitivity );
			} else {
				GlobalFuncs.remove_from_proximity_list( this, this.sensitivity );
			}
			this.oldloc = GlobalFuncs.get_turf( this.loc );
			this.update_icon();
			return false;
		}

		// Function from file: proximity.dm
		public override bool dropped( dynamic user = null ) {
			
			if ( Lang13.Bool( this.scanning ) ) {
				Task13.Schedule( 0, (Task13.Closure)(() => {
					this.sense();
					return;
				}));
			}
			return false;
		}

		// Function from file: proximity.dm
		public override int? process( dynamic seconds = null ) {
			
			if ( Lang13.Bool( this.timing ) ) {
				this.time--;

				if ( Convert.ToDouble( this.time ) <= 0 ) {
					this.timing = 0;
					this.toggle_scan( 1 );
					this.time = Lang13.Initial( this, "time" );
				}
			}
			this.handle_move( GlobalFuncs.get_turf( this.loc ) );
			return null;
		}

		// Function from file: proximity.dm
		public bool sense(  ) {
			
			if ( !this.secured || this.cooldown > 0 ) {
				return false;
			}
			this.pulse( false );
			this.audible_message( new Txt().icon( this ).str( " *beep* *beep*" ).ToString(), null, 3 );
			this.cooldown = 2;
			Task13.Schedule( 10, (Task13.Closure)(() => {
				this.process_cooldown();
				return;
			}));
			return false;
		}

		// Function from file: proximity.dm
		public override bool HasProximity( dynamic AM = null ) {
			
			if ( AM is Obj_Effect_Beam ) {
				return false;
			}
			this.sense();
			return false;
		}

		// Function from file: proximity.dm
		public override bool toggle_secure(  ) {
			this.secured = !this.secured;

			if ( !this.secured ) {
				this.scanning = 0;
				this.timing = 0;
			}
			this.update_icon();
			return this.secured;
		}

		// Function from file: proximity.dm
		public override bool activate(  ) {
			
			if ( !base.activate() ) {
				return false;
			}
			this.timing = !Lang13.Bool( this.timing ) ?1:0;
			this.update_icon();
			return true;
		}

		// Function from file: proximity.dm
		public override void on_detach( dynamic w = null ) {
			this.handle_move( w.holder.loc );
			return;
		}

		// Function from file: proximity.dm
		public override void on_attach( dynamic w = null ) {
			this.handle_move( w.holder );
			return;
		}

		// Function from file: proximity.dm
		public override string describe(  ) {
			
			if ( Lang13.Bool( this.timing ) ) {
				return "<span class='notice'>The proximity sensor is arming.</span>";
			}
			return "The proximity sensor is " + ( Lang13.Bool( this.scanning ) ? "armed" : "disarmed" ) + ".";
		}

		// Function from file: proximity.dm
		public void handle_move( dynamic newloc = null ) {
			
			if ( Lang13.Bool( this.scanning ) ) {
				
				if ( GlobalFuncs.shift_proximity( this, this.oldloc, this.sensitivity, newloc, this.sensitivity ) ) {
					this.sense();
					this.oldloc = newloc;
				}
			}
			return;
		}

		// Function from file: proximity.dm
		public void sensitivity_change( int value = 0 ) {
			int sense = 0;

			sense = Num13.MinInt( Num13.MaxInt( this.sensitivity + value, 0 ), 5 );

			if ( Lang13.Bool( this.scanning ) ) {
				GlobalFuncs.shift_proximity( this, this.oldloc, this.sensitivity, this.loc, sense );
			}
			this.sensitivity = sense;
			return;
		}

		// Function from file: proximity.dm
		[VerbInfo( name: "sense" )]
		public void _internal_sense(  ) {
			return;
		}

		// Function from file: proximity.dm
		[VerbInfo( name: "toggle scan" )]
		public void _internal_toggle_scan(  ) {
			return;
		}

	}

}