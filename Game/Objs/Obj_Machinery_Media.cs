// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Machinery_Media : Obj_Machinery {

		public double playing = 0;
		public string media_url = "";
		public int? media_start_time = 0;
		public dynamic volume = 1;
		public dynamic master_area = null;
		public ByTable hooked = new ByTable();
		public Obj_Machinery_Media_Transmitter_Broadcast exclusive_hook = null;
		public string id_tag = "???";

		// Function from file: machinery.dm
		public Obj_Machinery_Media ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;

			if ( this is Obj_Machinery_Media_Jukebox_Superjuke_Adminbus ) {
				return;
			}
			this.update_media_source();
			return;
		}

		// Function from file: machinery.dm
		public override dynamic Destroy( dynamic brokenup = null ) {
			this.disconnect_media_source();
			base.Destroy( (object)(brokenup) );
			return null;
		}

		// Function from file: machinery.dm
		public override bool forceMove( dynamic destination = null, int? no_tp = null ) {
			this.disconnect_media_source();
			base.forceMove( (object)(destination), no_tp );

			if ( Lang13.Bool( this.anchored ) ) {
				this.update_music();
			}
			return false;
		}

		// Function from file: machinery.dm
		public override bool Move( dynamic NewLoc = null, int? Dir = null, int step_x = 0, int step_y = 0 ) {
			base.Move( (object)(NewLoc), Dir, step_x, step_y );

			if ( Lang13.Bool( this.anchored ) ) {
				this.update_music();
			}
			return false;
		}

		// Function from file: machinery.dm
		public void disconnect_media_source(  ) {
			dynamic A = null;
			dynamic M = null;

			A = GlobalFuncs.get_area_master( this );

			if ( !Lang13.Bool( A ) ) {
				this.master_area = null;
				return;
			}

			if ( Lang13.Bool( A ) && A.media_source != null && A.media_source != this ) {
				this.master_area = null;
				return;
			}
			A.media_source = null;

			foreach (dynamic _a in Lang13.Enumerate( GlobalFuncs.mobs_in_area( A ) )) {
				M = _a;
				

				if ( Lang13.Bool( M ) && Lang13.Bool( M.client ) ) {
					M.update_music();
				}
			}
			this.master_area = null;
			return;
		}

		// Function from file: machinery.dm
		public void update_media_source(  ) {
			dynamic A = null;

			A = GlobalFuncs.get_area_master( this );

			if ( !Lang13.Bool( A ) ) {
				return;
			}

			if ( A.media_source != null && A.media_source != this ) {
				A.media_source.disconnect_media_source();
				A.media_source = this;
				this.master_area = A;
				return;
			}

			if ( !( A.media_source != null ) ) {
				A.media_source = this;
			}
			this.master_area = A;
			return;
		}

		// Function from file: machinery.dm
		public virtual void update_music(  ) {
			Obj_Machinery_Media_Transmitter T = null;
			dynamic M = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.hooked, typeof(Obj_Machinery_Media_Transmitter) )) {
				T = _a;
				
				Game13.log.WriteMsg( "## TESTING: " + ( "" + this + " Writing media to " + T + "." ) );
				T.broadcast( this.media_url, this.media_start_time );
			}

			if ( this.exclusive_hook != null ) {
				this.disconnect_media_source();
				return;
			}
			this.update_media_source();

			if ( !Lang13.Bool( this.master_area ) ) {
				return;
			}

			foreach (dynamic _b in Lang13.Enumerate( GlobalFuncs.mobs_in_area( this.master_area ) )) {
				M = _b;
				

				if ( Lang13.Bool( M ) && Lang13.Bool( M.client ) ) {
					M.update_music();
				}
			}
			return;
		}

		// Function from file: machinery.dm
		public bool unhookMediaOutput( Obj_Machinery_Media_Transmitter_Broadcast T = null ) {
			
			if ( this.exclusive_hook == T ) {
				this.exclusive_hook = null;
			}
			this.hooked.Remove( T );
			return true;
		}

		// Function from file: machinery.dm
		public bool hookMediaOutput( Obj_Machinery_Media_Transmitter_Broadcast T = null, bool? exclusive = null ) {
			exclusive = exclusive ?? false;

			
			if ( exclusive == true ) {
				this.exclusive_hook = T;
			}
			this.hooked.Add( T );
			return true;
		}

		// Function from file: trash_machinery.dm
		public override dynamic cultify(  ) {
			GlobalFuncs.qdel( this );
			return null;
		}

	}

}