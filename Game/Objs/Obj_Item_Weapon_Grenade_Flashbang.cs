// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Item_Weapon_Grenade_Flashbang : Obj_Item_Weapon_Grenade {

		public bool banglet = false;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.origin_tech = "materials=2;combat=1";
			this.icon_state = "flashbang";
		}

		public Obj_Item_Weapon_Grenade_Flashbang ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: flashbang.dm
		public void bang( dynamic T = null, Mob_Living_Carbon M = null ) {
			Obj_Item_Weapon_CloakingDevice S = null;
			dynamic eye_safety = null;
			int ear_safety = 0;
			Mob_Living_Carbon H = null;
			Mob_Living_Carbon H2 = null;
			Organ_Internal E = null;

			
			if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Item_Weapon_CloakingDevice), M ) ) ) {
				
				foreach (dynamic _a in Lang13.Enumerate( M, typeof(Obj_Item_Weapon_CloakingDevice) )) {
					S = _a;
					
					S.active = false;
					S.icon_state = "shield0";
				}
			}
			GlobalFuncs.to_chat( M, "<span class='danger'>BANG</span>" );
			GlobalFuncs.playsound( GlobalFuncs.get_turf( this ), "sound/effects/bang.ogg", 25, 1 );
			eye_safety = 0;
			ear_safety = 0;

			if ( M is Mob_Living_Carbon ) {
				eye_safety = M.eyecheck();

				if ( M is Mob_Living_Carbon_Human ) {
					H = M;

					if ( Lang13.Bool( ((dynamic)H).earprot() ) ) {
						ear_safety += 2;
					}

					if ( M.mutations.Contains( 4 ) ) {
						ear_safety += 1;
					}

					if ( ((dynamic)M).head is Obj_Item_Clothing_Head_Helmet ) {
						ear_safety += 1;
					}
				}
			}

			if ( Convert.ToDouble( eye_safety ) < 1 ) {
				Icon13.Flick( "e_flash", M.flash );
				M.Stun( 2 );
				M.Weaken( 10 );
			}

			if ( Map13.GetDistance( M, T ) <= 2 || this.loc == M.loc || this.loc == M ) {
				
				if ( ear_safety > 0 ) {
					M.Stun( 2 );
					M.Weaken( 1 );
				} else {
					M.Stun( 10 );
					M.Weaken( 3 );

					if ( Rand13.PercentChance( 14 ) || M == this.loc && Rand13.PercentChance( 70 ) ) {
						M.ear_damage += Rand13.Int( 1, 10 );
					} else {
						M.ear_damage += Rand13.Int( 0, 5 );
						M.ear_deaf = Num13.MaxInt( M.ear_deaf, 15 );
					}
				}
			} else if ( Map13.GetDistance( M, T ) <= 5 ) {
				
				if ( !( ear_safety != 0 ) ) {
					M.Stun( 8 );
					M.ear_damage += Rand13.Int( 0, 3 );
					M.ear_deaf = Num13.MaxInt( M.ear_deaf, 10 );
				}
			} else if ( !( ear_safety != 0 ) ) {
				M.Stun( 4 );
				M.ear_damage += Rand13.Int( 0, 1 );
				M.ear_deaf = Num13.MaxInt( M.ear_deaf, 5 );
			}

			if ( M is Mob_Living_Carbon_Human ) {
				H2 = M;
				E = ((dynamic)H2).internal_organs_by_name["eyes"];

				if ( E != null && E.damage >= E.min_bruised_damage ) {
					GlobalFuncs.to_chat( M, "<span class='warning'>Your eyes start to burn badly!</span>" );

					if ( !this.banglet && !( this is Obj_Item_Weapon_Grenade_Flashbang_Clusterbang ) ) {
						
						if ( E.damage >= E.min_broken_damage ) {
							GlobalFuncs.to_chat( M, "<span class='warning'>You can't see anything!</span>" );
						}
					}
				}
			}

			if ( M.ear_damage >= 15 ) {
				GlobalFuncs.to_chat( M, "<span class='warning'>Your ears start to ring badly!</span>" );

				if ( !this.banglet && !( this is Obj_Item_Weapon_Grenade_Flashbang_Clusterbang ) ) {
					
					if ( Rand13.PercentChance( ((int)( M.ear_damage - 10 + 5 )) ) ) {
						GlobalFuncs.to_chat( M, "<span class='warning'>You can't hear anything!</span>" );
						M.sdisabilities |= 4;
					}
				}
			} else if ( M.ear_damage >= 5 ) {
				GlobalFuncs.to_chat( M, "<span class='warning'>Your ears start to ring!</span>" );
			}
			M.update_icons();
			return;
		}

		// Function from file: flashbang.dm
		public override void prime( dynamic L = null ) {
			dynamic flashbang_turf = null;
			Mob_Living_Carbon M = null;
			Obj_Effect_Blob B = null;
			int damage = 0;

			this.update_mob();
			flashbang_turf = GlobalFuncs.get_turf( this );

			if ( !Lang13.Bool( flashbang_turf ) ) {
				return;
			}

			foreach (dynamic _a in Lang13.Enumerate( GlobalFuncs.get_hearers_in_view( 7, flashbang_turf ), typeof(Mob_Living_Carbon) )) {
				M = _a;
				

				if ( M is Mob_Living_Carbon_Brain || !( M is Mob_Living_Carbon ) ) {
					continue;
				}
				this.bang( GlobalFuncs.get_turf( M ), M );
			}

			foreach (dynamic _b in Lang13.Enumerate( GlobalFuncs.get_hear( 8, flashbang_turf ), typeof(Obj_Effect_Blob) )) {
				B = _b;
				
				damage = Num13.Floor( 15 / ( Map13.GetDistance( B, GlobalFuncs.get_turf( this ) ) + 1 ) );
				B.health -= damage;
				B.update_icon();
			}
			GlobalFuncs.qdel( this );
			return;
		}

	}

}