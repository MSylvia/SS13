// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Structure_Safe : Obj_Structure {

		public bool open = false;
		public int tumbler_1_pos = 0;
		public int tumbler_1_open = 0;
		public int tumbler_2_pos = 0;
		public int tumbler_2_open = 0;
		public int dial = 0;
		public double space = 0;
		public double maxspace = 24;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.anchored = 1;
			this.icon_state = "safe";
		}

		// Function from file: safe.dm
		public Obj_Structure_Safe ( dynamic loc = null ) : base( (object)(loc) ) {
			this.tumbler_1_pos = Rand13.Int( 0, 71 );
			this.tumbler_1_open = Rand13.Int( 0, 71 );
			this.tumbler_2_pos = Rand13.Int( 0, 71 );
			this.tumbler_2_open = Rand13.Int( 0, 71 );
			return;
		}

		// Function from file: safe.dm
		public override bool ex_act( double? severity = null, dynamic target = null ) {
			return false;
		}

		// Function from file: safe.dm
		public override bool blob_act( dynamic severity = null ) {
			return false;
		}

		// Function from file: safe.dm
		public override dynamic attackby( dynamic A = null, dynamic user = null, string _params = null, bool? silent = null, bool? replace_spent = null ) {
			
			if ( this.open ) {
				
				if ( Convert.ToDouble( A.w_class + this.space ) <= this.maxspace ) {
					this.space += Convert.ToDouble( A.w_class );

					if ( !Lang13.Bool( user.drop_item() ) ) {
						user.WriteMsg( new Txt( "<span class='warning'>" ).The( A ).item().str( " is stuck to your hand, you cannot put it in the safe!</span>" ).ToString() );
						return null;
					}
					A.loc = this;
					user.WriteMsg( "<span class='notice'>You put " + A + " in " + this + ".</span>" );
					this.updateUsrDialog();
					return null;
				} else {
					user.WriteMsg( "<span class='notice'>" + A + " won't fit in " + this + ".</span>" );
					return null;
				}
			} else if ( A is Obj_Item_Clothing_Tie_Stethoscope ) {
				user.WriteMsg( "<span class='warning'>Hold " + A + " in one of your hands while you manipulate the dial!</span>" );
				return null;
			}
			return null;
		}

		// Function from file: safe.dm
		public override dynamic Topic( string href = null, ByTable href_list = null, dynamic hsrc = null ) {
			Mob user = null;
			bool? canhear = null;
			dynamic P = null;

			
			if ( !( Task13.User is Mob_Living_Carbon_Human ) ) {
				return null;
			}
			user = Task13.User;
			canhear = false;

			if ( user.l_hand is Obj_Item_Clothing_Tie_Stethoscope || user.r_hand is Obj_Item_Clothing_Tie_Stethoscope ) {
				canhear = true;
			}

			if ( Lang13.Bool( href_list["open"] ) ) {
				
				if ( this.check_unlocked() ) {
					user.WriteMsg( "<span class='notice'>You " + ( this.open ? "close" : "open" ) + " " + this + ".</span>" );
					this.open = !this.open;
					this.update_icon();
					this.updateUsrDialog();
					return null;
				} else {
					user.WriteMsg( "<span class='warning'>You can't " + ( this.open ? "close" : "open" ) + " " + this + ", the lock is engaged!</span>" );
					return null;
				}
			}

			if ( Lang13.Bool( href_list["decrement"] ) ) {
				this.dial = this.decrement( this.dial );

				if ( this.dial == this.tumbler_1_pos + 1 || this.dial == this.tumbler_1_pos - 71 ) {
					this.tumbler_1_pos = this.decrement( this.tumbler_1_pos );

					if ( canhear == true ) {
						user.WriteMsg( "<span class='italics'>You hear a " + Rand13.Pick(new object [] { "clack", "scrape", "clank" }) + " from " + this + ".</span>" );
					}

					if ( this.tumbler_1_pos == this.tumbler_2_pos + 37 || this.tumbler_1_pos == this.tumbler_2_pos - 35 ) {
						this.tumbler_2_pos = this.decrement( this.tumbler_2_pos );

						if ( canhear == true ) {
							user.WriteMsg( "<span class='italics'>You hear a " + Rand13.Pick(new object [] { "click", "chink", "clink" }) + " from " + this + ".</span>" );
						}
					}
					this.check_unlocked( user, canhear );
				}
				this.updateUsrDialog();
				return null;
			}

			if ( Lang13.Bool( href_list["increment"] ) ) {
				this.dial = this.increment( this.dial );

				if ( this.dial == this.tumbler_1_pos - 1 || this.dial == this.tumbler_1_pos + 71 ) {
					this.tumbler_1_pos = this.increment( this.tumbler_1_pos );

					if ( canhear == true ) {
						user.WriteMsg( "<span class='italics'>You hear a " + Rand13.Pick(new object [] { "clack", "scrape", "clank" }) + " from " + this + ".</span>" );
					}

					if ( this.tumbler_1_pos == this.tumbler_2_pos - 37 || this.tumbler_1_pos == this.tumbler_2_pos + 35 ) {
						this.tumbler_2_pos = this.increment( this.tumbler_2_pos );

						if ( canhear == true ) {
							user.WriteMsg( "<span class='italics'>You hear a " + Rand13.Pick(new object [] { "click", "chink", "clink" }) + " from " + this + ".</span>" );
						}
					}
					this.check_unlocked( user, canhear );
				}
				this.updateUsrDialog();
				return null;
			}

			if ( Lang13.Bool( href_list["retrieve"] ) ) {
				Interface13.Browse( user, "", "window=safe" );
				P = Lang13.FindIn( href_list["retrieve"], this );

				if ( this.open ) {
					
					if ( Lang13.Bool( P ) && Map13.GetDistance( this, user ) <= 1 ) {
						user.put_in_hands( P );
						this.updateUsrDialog();
					}
				}
			}
			return null;
		}

		// Function from file: safe.dm
		public override dynamic attack_hand( dynamic a = null, bool? b = null, bool? c = null ) {
			string dat = null;
			int? i = null;
			dynamic P = null;

			((Mob)a).set_machine( this );
			dat = "<center>";
			dat += new Txt( "<a href='?src=" ).Ref( this ).str( ";open=1'>" ).item( ( this.open ? "Close" : "Open" ) ).str( " " ).item( this ).str( "</a> | <a href='?src=" ).Ref( this ).str( ";decrement=1'>-</a> " ).item( this.dial * 5 ).str( " <a href='?src=" ).Ref( this ).str( ";increment=1'>+</a>" ).ToString();

			if ( this.open ) {
				dat += "<table>";
				i = null;
				i = this.contents.len;

				while (( i ??0) >= 1) {
					P = this.contents[i];
					dat += new Txt( "<tr><td><a href='?src=" ).Ref( this ).str( ";retrieve=" ).Ref( P ).str( "'>" ).item( P.name ).str( "</a></td></tr>" ).ToString();
					i--;
				}
				dat += "</table></center>";
			}
			Interface13.Browse( a, "<html><head><title>" + this.name + "</title></head><body>" + dat + "</body></html>", "window=safe;size=350x300" );
			return null;
		}

		// Function from file: safe.dm
		public override bool update_icon( dynamic new_state = null, dynamic new_icon = null, int? new_px = null, int? new_py = null ) {
			
			if ( this.open ) {
				this.icon_state = "" + Lang13.Initial( this, "icon_state" ) + "-open";
			} else {
				this.icon_state = Lang13.Initial( this, "icon_state" );
			}
			return false;
		}

		// Function from file: safe.dm
		public int increment( int num = 0 ) {
			num += 1;

			if ( num > 71 ) {
				num = 0;
			}
			return num;
		}

		// Function from file: safe.dm
		public int decrement( int num = 0 ) {
			num -= 1;

			if ( num < 0 ) {
				num = 71;
			}
			return num;
		}

		// Function from file: safe.dm
		public bool check_unlocked( Mob user = null, bool? canhear = null ) {
			
			if ( user != null && canhear == true ) {
				
				if ( this.tumbler_1_pos == this.tumbler_1_open ) {
					user.WriteMsg( "<span class='italics'>You hear a " + Rand13.Pick(new object [] { "tonk", "krunk", "plunk" }) + " from " + this + ".</span>" );
				}

				if ( this.tumbler_2_pos == this.tumbler_2_open ) {
					user.WriteMsg( "<span class='italics'>You hear a " + Rand13.Pick(new object [] { "tink", "krink", "plink" }) + " from " + this + ".</span>" );
				}
			}

			if ( this.tumbler_1_pos == this.tumbler_1_open && this.tumbler_2_pos == this.tumbler_2_open ) {
				
				if ( user != null ) {
					this.visible_message( "<i><b>" + Rand13.Pick(new object [] { "Spring", "Sprang", "Sproing", "Clunk", "Krunk" }) + "!</b></i>" );
				}
				return true;
			}
			return false;
		}

		// Function from file: safe.dm
		public override void initialize(  ) {
			Obj_Item I = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.loc, typeof(Obj_Item) )) {
				I = _a;
				

				if ( this.space >= this.maxspace ) {
					return;
				}

				if ( Convert.ToDouble( I.w_class + this.space ) <= this.maxspace ) {
					this.space += Convert.ToDouble( I.w_class );
					I.loc = this;
				}
			}
			return;
		}

	}

}