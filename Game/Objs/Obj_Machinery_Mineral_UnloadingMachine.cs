// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Machinery_Mineral_UnloadingMachine : Obj_Machinery_Mineral {

		public dynamic input = null;
		public dynamic output = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.anchored = 1;
			this.icon = "icons/obj/machines/mining_machines.dmi";
			this.icon_state = "unloader";
		}

		// Function from file: machine_unloading.dm
		public Obj_Machinery_Mineral_UnloadingMachine ( dynamic loc = null ) : base( (object)(loc) ) {
			dynamic dir = null;
			dynamic dir2 = null;

			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			Task13.Schedule( 5, (Task13.Closure)(() => {
				
				foreach (dynamic _a in Lang13.Enumerate( GlobalVars.cardinal )) {
					dir = _a;
					
					this.input = Lang13.FindIn( typeof(Obj_Machinery_Mineral_Input), Map13.GetStep( this, Convert.ToInt32( dir ) ) );

					if ( Lang13.Bool( this.input ) ) {
						break;
					}
				}

				foreach (dynamic _b in Lang13.Enumerate( GlobalVars.cardinal )) {
					dir2 = _b;
					
					this.output = Lang13.FindIn( typeof(Obj_Machinery_Mineral_Output), Map13.GetStep( this, Convert.ToInt32( dir2 ) ) );

					if ( Lang13.Bool( this.output ) ) {
						break;
					}
				}
				return;
				return;
			}));
			return;
		}

		// Function from file: machine_unloading.dm
		public override dynamic process(  ) {
			dynamic BOX = null;
			int p = 0;
			dynamic ore_id = null;
			dynamic mat = null;
			int? n = null;
			int? i = null;
			dynamic O = null;
			int? i2 = null;

			
			if ( Lang13.Bool( this.output ) && Lang13.Bool( this.input ) ) {
				
				if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Structure_OreBox), this.input.loc ) ) ) {
					BOX = Lang13.FindIn( typeof(Obj_Structure_OreBox), this.input.loc );
					p = 0;

					foreach (dynamic _a in Lang13.Enumerate( BOX.materials.storage )) {
						ore_id = _a;
						
						mat = ((Materials)BOX.materials).getMaterial( ore_id );
						n = Lang13.IntNullable( BOX.materials.storage[ore_id] );

						if ( ( n ??0) <= 0 || !( mat.oretype != null ) ) {
							continue;
						}
						i = null;
						i = 0;

						while (( i ??0) < ( n ??0)) {
							Lang13.Call( mat.oretype, GlobalFuncs.get_turf( this.output ) );
							BOX.materials.storage[ore_id]--;
							p++;

							if ( p >= 100 ) {
								return null;
							}
							i++;
						}
					}
				}

				if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Item), this.input.loc ) ) ) {
					O = null;
					i2 = null;
					i2 = 0;

					while (( i2 ??0) < 100) {
						O = Lang13.FindIn( typeof(Obj_Item), this.input.loc );

						if ( Lang13.Bool( O ) ) {
							O.loc = this.output.loc;
						} else {
							return null;
						}
						i2++;
					}
				}
			}
			return null;
		}

	}

}