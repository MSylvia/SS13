// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Item_Device_Chameleon : Obj_Item_Device {

		public bool cham_proj_scan = true;
		public bool can_use = true;
		public Obj_Effect_Dummy_Chameleon active_dummy = null;
		public Type saved_item = typeof(Obj_Item_Weapon_Cigbutt);
		public string saved_icon = "icons/obj/clothing/masks.dmi";
		public string saved_icon_state = "cigbutt";
		public ByTable saved_overlays = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.slot_flags = 512;
			this.item_state = "electronic";
			this.throwforce = 5;
			this.throw_speed = 1;
			this.throw_range = 5;
			this.w_class = 2;
			this.origin_tech = "syndicate=4;magnets=4";
			this.icon_state = "shield0";
		}

		public Obj_Item_Device_Chameleon ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: chameleonproj.dm
		public void eject_all(  ) {
			Ent_Dynamic A = null;
			Ent_Dynamic M = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.active_dummy, typeof(Ent_Dynamic) )) {
				A = _a;
				
				A.loc = this.active_dummy.loc;

				if ( A is Mob ) {
					M = A;
					((dynamic)M).reset_view( null );
					M.layer = GlobalVars.MOB_LAYER;
				}
			}
			return;
		}

		// Function from file: chameleonproj.dm
		public void disrupt( bool? delete_dummy = null ) {
			delete_dummy = delete_dummy ?? true;

			Effect_Effect_System_SparkSpread spark_system = null;

			
			if ( this.active_dummy != null ) {
				spark_system = new Effect_Effect_System_SparkSpread();
				spark_system.set_up( 5, 0, this );
				spark_system.attach( this );
				spark_system.start();
				this.eject_all();

				if ( delete_dummy == true ) {
					GlobalFuncs.qdel( this.active_dummy );
				}
				this.active_dummy = null;
				this.can_use = false;
				Task13.Schedule( 50, (Task13.Closure)(() => {
					this.can_use = true;
					return;
				}));
			}
			return;
		}

		// Function from file: chameleonproj.dm
		public void toggle(  ) {
			Obj_Effect_Overlay T = null;
			dynamic O = null;
			Obj_Effect_Dummy_Chameleon C = null;
			Obj_Effect_Overlay T2 = null;

			
			if ( !this.can_use || !( this.saved_item != null ) ) {
				return;
			}

			if ( this.active_dummy != null ) {
				this.eject_all();
				Lang13.Delete( this.active_dummy );
				this.active_dummy = null;
				this.active_dummy = null;
				GlobalFuncs.to_chat( Task13.User, "<span class='notice'>You deactivate " + this + ".</span>" );
				T = new Obj_Effect_Overlay( GlobalFuncs.get_turf( this ) );
				T.icon = "icons/effects/effects.dmi";
				Icon13.Flick( "emppulse", T );
				Task13.Schedule( 8, (Task13.Closure)(() => {
					GlobalFuncs.qdel( T );
					return;
				}));
				this.can_use = false;
				Task13.Schedule( 20, (Task13.Closure)(() => {
					this.can_use = true;
					return;
				}));
			} else {
				O = Lang13.Call( this.saved_item, this );

				if ( !Lang13.Bool( O ) ) {
					return;
				}
				C = new Obj_Effect_Dummy_Chameleon( Task13.User.loc );
				C.activate( O, Task13.User, this.saved_icon, this.saved_icon_state, this.saved_overlays, this );
				GlobalFuncs.qdel( O );
				O = null;
				GlobalFuncs.to_chat( Task13.User, "<span class='notice'>You activate " + this + ".</span>" );
				T2 = new Obj_Effect_Overlay( GlobalFuncs.get_turf( this ) );
				T2.icon = "icons/effects/effects.dmi";
				Icon13.Flick( "emppulse", T2 );
				Task13.Schedule( 8, (Task13.Closure)(() => {
					GlobalFuncs.qdel( T2 );
					return;
				}));
				this.can_use = false;
				Task13.Schedule( 20, (Task13.Closure)(() => {
					this.can_use = true;
					return;
				}));
			}
			return;
		}

		// Function from file: chameleonproj.dm
		public override bool preattack( dynamic target = null, dynamic user = null, bool? proximity_flag = null, dynamic click_parameters = null ) {
			
			if ( !( proximity_flag == true ) ) {
				return false;
			}

			if ( !this.cham_proj_scan ) {
				return false;
			}

			if ( !( this.active_dummy != null ) ) {
				
				if ( target is Obj_Item && !( target is Obj_Item_Weapon_Disk_Nuclear ) || target is Mob ) {
					GlobalFuncs.playsound( GlobalFuncs.get_turf( this ), "sound/weapons/flash.ogg", 100, 1, -6 );
					GlobalFuncs.to_chat( user, "<span class='notice'>Scanned " + target + ".</span>" );
					this.saved_item = target.type;
					this.saved_icon = target.icon;
					this.saved_icon_state = target.icon_state;
					this.saved_overlays = target.overlays;
					return true;
				}
			}
			return false;
		}

		// Function from file: chameleonproj.dm
		public override dynamic attack_self( dynamic user = null, dynamic flag = null, bool? emp = null ) {
			this.toggle();
			return null;
		}

		// Function from file: chameleonproj.dm
		public override dynamic equipped( dynamic user = null, dynamic slot = null ) {
			this.disrupt();
			return null;
		}

		// Function from file: chameleonproj.dm
		public override dynamic dropped( dynamic user = null ) {
			Task13.Schedule( 0, (Task13.Closure)(() => {
				this.disrupt();
				return;
			}));
			return null;
		}

		// Function from file: chameleonproj.dm
		[Verb]
		[VerbInfo( name: "Toggle Chameleon Projector Scanning", group: "Object" )]
		public void toggle_scaning(  ) {
			
			if ( Task13.User.isUnconscious() ) {
				return;
			}
			this.cham_proj_scan = !this.cham_proj_scan;
			GlobalFuncs.to_chat( Task13.User, "You " + ( this.cham_proj_scan ? "activate" : "deactivate" ) + " " + this + "'s scanning function" );
			return;
		}

	}

}