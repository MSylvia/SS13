// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Item_Device_Chameleon : Obj_Item_Device {

		public bool can_use = true;
		public Obj_Effect_Dummy_Chameleon active_dummy = null;
		public dynamic saved_appearance = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.flags = 64;
			this.slot_flags = 512;
			this.item_state = "electronic";
			this.throwforce = 5;
			this.throw_speed = 3;
			this.throw_range = 5;
			this.w_class = 2;
			this.origin_tech = "syndicate=4;magnets=4";
			this.icon_state = "shield0";
		}

		// Function from file: chameleonproj.dm
		public Obj_Item_Device_Chameleon ( dynamic loc = null ) : base( (object)(loc) ) {
			Type butt = null;

			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			butt = typeof(Obj_Item_Weapon_Cigbutt);
			this.saved_appearance = Lang13.Initial( butt, "appearance" );
			return;
		}

		// Function from file: chameleonproj.dm
		public void eject_all(  ) {
			Ent_Dynamic A = null;
			Ent_Dynamic M = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.active_dummy, typeof(Ent_Dynamic) )) {
				A = _a;
				
				A.loc = this.active_dummy.loc;

				if ( A is Mob ) {
					M = A;
					((dynamic)M).reset_perspective( null );
				}
			}
			return;
		}

		// Function from file: chameleonproj.dm
		public void disrupt( bool? delete_dummy = null ) {
			delete_dummy = delete_dummy ?? true;

			dynamic M = null;
			EffectSystem_SparkSpread spark_system = null;

			
			if ( this.active_dummy != null ) {
				
				foreach (dynamic _a in Lang13.Enumerate( this.active_dummy )) {
					M = _a;
					
					M.WriteMsg( "<span class='danger'>Your chameleon-projector deactivates.</span>" );
				}
				spark_system = new EffectSystem_SparkSpread();
				spark_system.set_up( 5, 0, this );
				spark_system.attach( this );
				spark_system.start();
				this.eject_all();

				if ( delete_dummy == true ) {
					GlobalFuncs.qdel( this.active_dummy );
				}
				this.active_dummy = null;
				this.can_use = false;
				Task13.Schedule( 50, (Task13.Closure)(() => {
					this.can_use = true;
					return;
				}));
			}
			return;
		}

		// Function from file: chameleonproj.dm
		public void toggle(  ) {
			Obj_Effect_Dummy_Chameleon C = null;

			
			if ( !this.can_use || !Lang13.Bool( this.saved_appearance ) ) {
				return;
			}

			if ( this.active_dummy != null ) {
				this.eject_all();
				GlobalFuncs.playsound( GlobalFuncs.get_turf( this ), "sound/effects/pop.ogg", 100, 1, -6 );
				GlobalFuncs.qdel( this.active_dummy );
				this.active_dummy = null;
				Task13.User.WriteMsg( new Txt( "<span class='notice'>You deactivate " ).the( this ).item().str( ".</span>" ).ToString() );
				GlobalFuncs.PoolOrNew( typeof(Obj_Effect_Overlay_Temp_Emp_Pulse), GlobalFuncs.get_turf( this ) );
			} else {
				GlobalFuncs.playsound( GlobalFuncs.get_turf( this ), "sound/effects/pop.ogg", 100, 1, -6 );
				C = new Obj_Effect_Dummy_Chameleon( Task13.User.loc );
				C.activate( Task13.User, this.saved_appearance, this );
				Task13.User.WriteMsg( new Txt( "<span class='notice'>You activate " ).the( this ).item().str( ".</span>" ).ToString() );
				GlobalFuncs.PoolOrNew( typeof(Obj_Effect_Overlay_Temp_Emp_Pulse), GlobalFuncs.get_turf( this ) );
			}
			return;
		}

		// Function from file: chameleonproj.dm
		public override bool afterattack( dynamic target = null, dynamic user = null, bool? proximity_flag = null, string click_parameters = null ) {
			Obj temp = null;

			
			if ( !( proximity_flag == true ) ) {
				return false;
			}

			if ( !( this.active_dummy != null ) ) {
				
				if ( target is Obj_Item && !( target is Obj_Item_Weapon_Disk_Nuclear ) ) {
					GlobalFuncs.playsound( GlobalFuncs.get_turf( this ), "sound/weapons/flash.ogg", 100, 1, -6 );
					user.WriteMsg( "<span class='notice'>Scanned " + target + ".</span>" );
					temp = new Obj();
					temp.appearance = target.appearance;
					temp.layer = Convert.ToDouble( Lang13.Initial( target, "layer" ) );
					this.saved_appearance = temp.appearance;
				}
			}
			return false;
		}

		// Function from file: chameleonproj.dm
		public override dynamic attack_self( dynamic user = null, dynamic flag = null, bool? emp = null ) {
			this.toggle();
			return null;
		}

		// Function from file: chameleonproj.dm
		public override void equipped( Mob user = null, dynamic slot = null ) {
			this.disrupt();
			return;
		}

		// Function from file: chameleonproj.dm
		public override bool dropped( dynamic user = null ) {
			this.disrupt();
			return false;
		}

	}

}