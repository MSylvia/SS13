// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Effect_Portal : Obj_Effect {

		public dynamic target = null;
		public Obj_Item_Weapon creator = null;
		public bool undergoing_deletion = false;
		public ByTable exit_beams = new ByTable();

		protected override void __FieldInit() {
			base.__FieldInit();

			this.unacidable = true;
			this.anchored = 1;
			this.icon = "icons/obj/stationobjs.dmi";
			this.icon_state = "portal0";
		}

		// Function from file: portals.dm
		public Obj_Effect_Portal ( dynamic loc = null, int? lifespan = null ) : base( (object)(loc) ) {
			lifespan = lifespan ?? 300;

			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			GlobalFuncs.playsound( loc, "sound/effects/portal_open.ogg", 60, 1 );
			Task13.Schedule( lifespan ??0, (Task13.Closure)(() => {
				GlobalFuncs.qdel( this );
				return;
			}));
			return;
		}

		// Function from file: portals.dm
		public override bool handle_beams(  ) {
			dynamic PE = null;

			
			if ( Lang13.Bool( this.target ) && this.target is Obj_Effect_Portal ) {
				PE = this.target;
				((Obj_Effect_Portal)PE).purge_beams();
			}
			this.add_beams();
			return false;
		}

		// Function from file: portals.dm
		public override void beam_disconnect( Obj_Effect_Beam B = null ) {
			
			if ( B is Obj_Effect_Beam ) {
				
				if ( Lang13.Bool( B.HasSource( this ) ) ) {
					return;
				}
				base.beam_disconnect( B );
			}
			this.handle_beams();
			return;
		}

		// Function from file: portals.dm
		public override bool beam_connect( Obj_Effect_Beam B = null ) {
			
			if ( B is Obj_Effect_Beam ) {
				
				if ( Lang13.Bool( B.HasSource( this ) ) ) {
					return false;
				}
				base.beam_connect( B );
			}
			this.handle_beams();
			return false;
		}

		// Function from file: portals.dm
		public void add_beams(  ) {
			dynamic PE = null;
			Obj_Effect_Beam_Emitter BE = null;
			ByTable spawners = null;
			Obj_Effect_Beam_Emitter beam = null;

			
			if ( !( this.beams != null ) || !( this.beams.len != 0 ) || !Lang13.Bool( this.target ) || !( this.target is Obj_Effect_Portal ) ) {
				return;
			}
			PE = this.target;

			foreach (dynamic _a in Lang13.Enumerate( this.beams, typeof(Obj_Effect_Beam_Emitter) )) {
				BE = _a;
				
				spawners = new ByTable(new object [] { this });
				spawners.Or( BE.sources );
				beam = new Obj_Effect_Beam_Emitter( PE.loc );
				beam.dir = BE.dir;
				beam.power = BE.power;
				beam.steps = BE.steps + 1;
				beam.emit( spawners );
				PE.exit_beams.Add( beam );
			}
			return;
		}

		// Function from file: portals.dm
		public void purge_beams(  ) {
			Obj_Effect_Beam BE = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.exit_beams, typeof(Obj_Effect_Beam) )) {
				BE = _a;
				
				this.exit_beams.Remove( BE );
				GlobalFuncs.qdel( BE );
			}
			return;
		}

		// Function from file: portals.dm
		public virtual void teleport( dynamic M = null ) {
			dynamic A = null;

			
			if ( M is Obj_Effect ) {
				return;
			}

			if ( Lang13.Bool( M.anchored ) && M is Obj_Mecha ) {
				return;
			}

			if ( !Lang13.Bool( this.target ) ) {
				this.visible_message( "<span class='warning'>The portal fails to find a destination and dissipates into thin air.</span>" );
				GlobalFuncs.qdel( this );
				return;
			}

			if ( M is Ent_Dynamic ) {
				A = GlobalFuncs.get_area( this.target );

				if ( Lang13.Bool( A ) && A.anti_ethereal ) {
					this.visible_message( "<span class='sinister'>A dark form vaguely ressembling a hand reaches through the portal and tears it apart before anything can go through.</span>" );
					GlobalFuncs.qdel( this );
				} else {
					GlobalFuncs.do_teleport( M, this.target, 0, true, true, true, "sound/effects/portal_enter.ogg", "sound/effects/portal_exit.ogg" );
				}
			}
			return;
		}

		// Function from file: portals.dm
		public void blend_icon( Obj_Effect_Portal P = null ) {
			Ent_Static T = null;
			Icon I1 = null;
			Icon I2 = null;

			T = P.loc;

			if ( !GlobalVars.portal_cache.Contains( "icon" + Lang13.Initial( T, "icon" ) + "_iconstate" + T.icon_state ) ) {
				I1 = new Icon( this.icon, "portal_mask" );
				I2 = new Icon( Lang13.Initial( T, "icon" ), T.icon_state );
				I1.Blend( I2, 2 );
				GlobalVars.portal_cache["icon" + Lang13.Initial( T, "icon" ) + "_iconstate" + T.icon_state] = I1;
			}
			this.overlays.Add( GlobalVars.portal_cache["icon" + Lang13.Initial( T, "icon" ) + "_iconstate" + T.icon_state] );
			return;
		}

		// Function from file: portals.dm
		public override bool singularity_pull( Obj S = null, double? current_size = null, int? radiations = null ) {
			return false;
		}

		// Function from file: portals.dm
		public override double singularity_act( double? current_size = null, Obj_Machinery_Singularity S = null ) {
			return 0;
		}

		// Function from file: portals.dm
		public override bool singuloCanEat(  ) {
			return false;
		}

		// Function from file: portals.dm
		public override dynamic cultify(  ) {
			return null;
		}

		// Function from file: portals.dm
		public override dynamic Destroy( dynamic brokenup = null ) {
			Obj_Item_Weapon H = null;
			Obj_Item_Weapon P = null;
			Effect_Effect_System_SparkSpread aeffect = null;

			
			if ( this.undergoing_deletion ) {
				return null;
			}
			this.undergoing_deletion = true;
			GlobalFuncs.playsound( this.loc, "sound/effects/portal_close.ogg", 60, 1 );
			this.purge_beams();

			if ( Lang13.Bool( this.target ) ) {
				
				if ( this.target is Obj_Effect_Portal && !( this.creator is Obj_Item_Weapon_Gun_Portalgun ) ) {
					GlobalFuncs.qdel( this.target );
				}
				this.target = null;
			}

			if ( this.creator != null ) {
				
				if ( this.creator is Obj_Item_Weapon_HandTele ) {
					H = this.creator;
					((dynamic)H).portals -= this;
					this.creator = null;
				} else if ( this.creator is Obj_Item_Weapon_Gun_Portalgun ) {
					P = this.creator;

					if ( this == ((dynamic)P).blue_portal ) {
						((dynamic)P).blue_portal = null;
						((Obj_Item_Weapon_Gun_Portalgun)P).sync_portals();
					} else if ( this == ((dynamic)P).red_portal ) {
						((dynamic)P).red_portal = null;
						((Obj_Item_Weapon_Gun_Portalgun)P).sync_portals();
					}
				}
			}
			aeffect = new Effect_Effect_System_SparkSpread();
			aeffect.set_up( 5, 1, this.loc );
			aeffect.start();
			base.Destroy( (object)(brokenup) );
			return null;
		}

		// Function from file: portals.dm
		public override bool CanPass( dynamic mover = null, dynamic target = null, double? height = null, bool? air_group = null ) {
			height = height ?? 1.5;
			air_group = air_group ?? false;

			
			if ( mover is Obj_Effect_Beam ) {
				return false;
			} else {
				return base.CanPass( (object)(mover), (object)(target), height, air_group );
			}
		}

		// Function from file: portals.dm
		public override dynamic Crossed( Ent_Dynamic O = null, dynamic X = null ) {
			X = X ?? 0;

			Ent_Dynamic B = null;

			
			if ( Lang13.Bool( X ) ) {
				return null;
			}

			if ( O is Obj_Item_Projectile_Beam ) {
				B = O;
				((dynamic)B).wait = 1;
			}
			Task13.Schedule( 0, (Task13.Closure)(() => {
				this.teleport( O );
				return;
			}));
			return null;
		}

		// Function from file: portals.dm
		public override dynamic attackby( dynamic a = null, dynamic b = null, dynamic c = null ) {
			
			if ( a == this.creator ) {
				GlobalFuncs.to_chat( b, "<span class='warning'>You close the portal prematurely.</span>" );
				GlobalFuncs.qdel( this );
			} else {
				Task13.Schedule( 0, (Task13.Closure)(() => {
					this.teleport( b );
					return;
				}));
			}
			return null;
		}

		// Function from file: portals.dm
		public override dynamic attack_hand( dynamic a = null, dynamic b = null, dynamic c = null ) {
			Task13.Schedule( 0, (Task13.Closure)(() => {
				this.teleport( a );
				return;
			}));
			return null;
		}

		// Function from file: observer.dm
		public override dynamic attack_ghost( Mob_Dead_Observer user = null ) {
			
			if ( Lang13.Bool( this.target ) ) {
				user.loc = GlobalFuncs.get_turf( this.target );
			}
			return null;
		}

	}

}