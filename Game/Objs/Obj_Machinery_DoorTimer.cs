// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Machinery_DoorTimer : Obj_Machinery {

		public string id_tag = null;
		public double releasetime = 0;
		public double? timing = 1;
		public string picture_state = null;
		public ByTable targets = new ByTable();

		protected override void __FieldInit() {
			base.__FieldInit();

			this.req_access = new ByTable(new object [] { 2 });
			this.anchored = 1;
			this.icon = "icons/obj/status_display.dmi";
			this.icon_state = "frame";
		}

		// Function from file: brigdoors.dm
		public Obj_Machinery_DoorTimer ( dynamic loc = null ) : base( (object)(loc) ) {
			Obj_Machinery_Door_Window_Brigdoor M = null;
			Obj_Machinery_Flasher F = null;
			Obj_Structure_Closet_SecureCloset_Brig C = null;

			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			this.pixel_x = ( ( this.dir & 3 ) != 0 ? 0 : ( this.dir == 4 ? 32 : -32 ) );
			this.pixel_y = ( ( this.dir & 3 ) != 0 ? ( this.dir == 1 ? 24 : -32 ) : 0 );
			Task13.Schedule( 20, (Task13.Closure)(() => {
				
				foreach (dynamic _a in Lang13.Enumerate( GlobalVars.all_doors, typeof(Obj_Machinery_Door_Window_Brigdoor) )) {
					M = _a;
					

					if ( M.id_tag == this.id_tag ) {
						this.targets.Add( M );
					}
				}

				foreach (dynamic _b in Lang13.Enumerate( GlobalVars.flashers, typeof(Obj_Machinery_Flasher) )) {
					F = _b;
					

					if ( F.id_tag == this.id_tag ) {
						this.targets.Add( F );
					}
				}

				foreach (dynamic _c in Lang13.Enumerate( typeof(Game13), typeof(Obj_Structure_Closet_SecureCloset_Brig) )) {
					C = _c;
					

					if ( C.id_tag == this.id_tag ) {
						this.targets.Add( C );
					}
				}

				if ( this.targets.len == 0 ) {
					this.stat |= 1;
				}
				this.update_icon();
				return;
				return;
			}));
			return;
		}

		// Function from file: brigdoors.dm
		public override bool? update_icon( dynamic location = null, dynamic target = null ) {
			string disp1 = null;
			double timeleft = 0;
			string disp2 = null;

			
			if ( ( this.stat & 2 ) != 0 ) {
				this.icon_state = "frame";
				return null;
			}

			if ( ( this.stat & 1 ) != 0 ) {
				this.set_picture( "ai_bsod" );
				return null;
			}

			if ( Lang13.Bool( this.timing ) ) {
				disp1 = String13.ToUpper( this.id_tag );
				timeleft = this.timeleft();
				disp2 = "" + GlobalFuncs.add_zero( String13.NumberToString( timeleft / 60 % 60 ), 2 ) + "~" + GlobalFuncs.add_zero( String13.NumberToString( timeleft % 60 ), 2 );
				Task13.Schedule( 5, (Task13.Closure)(() => {
					this.update_display( disp1, disp2 );
					return;
				}));
			} else {
				this.update_display( "SET", "TIME" );
			}
			return null;
		}

		// Function from file: brigdoors.dm
		public override dynamic Topic( string href = null, ByTable href_list = null, dynamic hclient = null, HtmlInterface currui = null ) {
			double? tp = null;
			double timeleft = 0;
			Obj_Machinery_Flasher F = null;

			
			if ( Lang13.Bool( base.Topic( href, href_list, (object)(hclient) ) ) ) {
				return null;
			}

			if ( !this.allowed( Task13.User ) ) {
				return null;
			}
			Task13.User.set_machine( this );

			if ( Lang13.Bool( href_list["timing"] ) ) {
				this.timing = String13.ParseNumber( href_list["timing"] );
			} else {
				
				if ( Lang13.Bool( href_list["tp"] ) ) {
					tp = String13.ParseNumber( href_list["tp"] );
					timeleft = this.timeleft();
					timeleft += tp ??0;
					timeleft = Num13.MinInt( Num13.MaxInt( Num13.Floor( timeleft ), 0 ), 3600 );
					this.timeset( timeleft );
				}

				if ( Lang13.Bool( href_list["fc"] ) ) {
					
					foreach (dynamic _a in Lang13.Enumerate( this.targets, typeof(Obj_Machinery_Flasher) )) {
						F = _a;
						
						F.flash();
					}
				}
			}
			this.add_fingerprint( Task13.User );
			this.updateUsrDialog();
			this.update_icon();

			if ( Lang13.Bool( this.timing ) ) {
				this.timer_start();
			} else {
				this.timer_end();
			}
			return null;
		}

		// Function from file: brigdoors.dm
		public override dynamic attack_hand( dynamic a = null, dynamic b = null, dynamic c = null ) {
			int second = 0;
			int minute = 0;
			string dat = null;
			Obj_Machinery_Flasher F = null;

			
			if ( Lang13.Bool( base.attack_hand( (object)(a), (object)(b), (object)(c) ) ) ) {
				return null;
			}
			second = Num13.Floor( this.timeleft() % 60 );
			minute = Num13.Floor( ( this.timeleft() - second ) / 60 );
			((Mob)a).set_machine( this );
			dat = "<HTML><BODY><TT>";
			dat += "<HR>Timer System:</hr>\n			<b>Door " + this.id_tag + " controls</b><br/>";

			if ( Lang13.Bool( this.timing ) ) {
				dat += new Txt( "<a href='?src=" ).Ref( this ).str( ";timing=0'>Stop Timer and open door</a><br/>" ).ToString();
			} else {
				dat += new Txt( "<a href='?src=" ).Ref( this ).str( ";timing=1'>Activate Timer and close door</a><br/>" ).ToString();
			}
			dat += new Txt( "Time Left: " ).item( ( minute != 0 ? "" + minute + ":" : null ) ).item( second ).str( " <br/>\n			<a href='?src=" ).Ref( this ).str( ";tp=-60'>-</a> <a href='?src=" ).Ref( this ).str( ";tp=-1'>-</a> <a href='?src=" ).Ref( this ).str( ";tp=1'>+</a> <A href='?src=" ).Ref( this ).str( ";tp=60'>+</a><br/>" ).ToString();

			foreach (dynamic _a in Lang13.Enumerate( this.targets, typeof(Obj_Machinery_Flasher) )) {
				F = _a;
				

				if ( F.last_flash != 0 && F.last_flash + 150 > Game13.time ) {
					dat += new Txt( "<br/><A href='?src=" ).Ref( this ).str( ";fc=1'>Flash Charging</A>" ).ToString();
				} else {
					dat += new Txt( "<br/><A href='?src=" ).Ref( this ).str( ";fc=1'>Activate Flash</A>" ).ToString();
				}
			}
			dat += new Txt( "<br/><br/><a href='?src=" ).Ref( a ).str( ";mach_close=computer'>Close</a>\n			</TT></BODY></HTML>" ).ToString();
			Interface13.Browse( a, dat, "window=computer;size=400x500" );
			GlobalFuncs.onclose( a, "computer" );
			return null;
		}

		// Function from file: brigdoors.dm
		public override dynamic attack_ai( dynamic user = null ) {
			this.add_hiddenprint( user );
			return this.attack_hand( user );
		}

		// Function from file: brigdoors.dm
		public Image texticon( string tn = null, int? px = null, int? py = null ) {
			px = px ?? 0;
			py = py ?? 0;

			Image I = null;
			int len = 0;
			double d = 0;
			string _char = null;
			Image ID = null;

			I = new Image( "icons/obj/status_display.dmi", "blank" );
			len = Lang13.Length( tn );

			foreach (dynamic _a in Lang13.IterateRange( 1, len )) {
				d = _a;
				
				_char = String13.SubStr( tn, ((int)( len - d + 1 )), ((int)( len - d + 2 )) );

				if ( _char == " " ) {
					continue;
				}
				ID = new Image( "icons/obj/status_display.dmi", null, _char );
				ID.pixel_x = ((int)( -( d - 1 ) * 5 + ( px ??0) ));
				ID.pixel_y = py ??0;
				I.overlays.Add( ID );
			}
			return I;
		}

		// Function from file: brigdoors.dm
		public void update_display( string line1 = null, string line2 = null ) {
			
			if ( line2 == null ) {
				this.overlays.len = 0;
				this.overlays.Add( this.texticon( line1, 23, -13 ) );
			} else {
				this.overlays.len = 0;
				this.overlays.Add( this.texticon( line1, 23, -9 ) );
				this.overlays.Add( this.texticon( line2, 23, -17 ) );
			}
			return;
		}

		// Function from file: brigdoors.dm
		public void set_picture( string state = null ) {
			this.picture_state = state;
			this.overlays.len = 0;
			this.overlays.Add( new Image( "icons/obj/status_display.dmi", null, this.picture_state ) );
			return;
		}

		// Function from file: brigdoors.dm
		public void timeset( double seconds = 0 ) {
			this.releasetime = Game13.time + seconds * 10;
			return;
		}

		// Function from file: brigdoors.dm
		public double timeleft(  ) {
			double _default = 0;

			_default = ( this.releasetime - Game13.time ) / 10;

			if ( _default < 0 ) {
				_default = 0;
			}
			return _default;
		}

		// Function from file: brigdoors.dm
		public bool timer_end(  ) {
			Obj_Machinery_Door_Window_Brigdoor door = null;
			Obj_Structure_Closet_SecureCloset_Brig C = null;

			
			if ( ( this.stat & 3 ) != 0 ) {
				return false;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.targets, typeof(Obj_Machinery_Door_Window_Brigdoor) )) {
				door = _a;
				

				if ( !door.density ) {
					continue;
				}
				Task13.Schedule( 0, (Task13.Closure)(() => {
					door.open();
					return;
				}));
			}

			foreach (dynamic _b in Lang13.Enumerate( this.targets, typeof(Obj_Structure_Closet_SecureCloset_Brig) )) {
				C = _b;
				

				if ( C.broken ) {
					continue;
				}

				if ( C.opened ) {
					continue;
				}
				C.locked = false;
				C.icon_state = C.icon_closed;
			}
			return true;
		}

		// Function from file: brigdoors.dm
		public bool timer_start(  ) {
			Obj_Machinery_Door_Window_Brigdoor door = null;
			Obj_Structure_Closet_SecureCloset_Brig C = null;

			
			if ( ( this.stat & 3 ) != 0 ) {
				return false;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.targets, typeof(Obj_Machinery_Door_Window_Brigdoor) )) {
				door = _a;
				

				if ( door.density ) {
					continue;
				}
				Task13.Schedule( 0, (Task13.Closure)(() => {
					door.close();
					return;
				}));
			}

			foreach (dynamic _b in Lang13.Enumerate( this.targets, typeof(Obj_Structure_Closet_SecureCloset_Brig) )) {
				C = _b;
				

				if ( C.broken ) {
					continue;
				}

				if ( C.opened && !C.close() ) {
					continue;
				}
				C.locked = true;
				C.icon_state = C.icon_locked;
			}
			return true;
		}

		// Function from file: brigdoors.dm
		public override dynamic power_change(  ) {
			base.power_change();
			this.update_icon();
			return null;
		}

		// Function from file: brigdoors.dm
		public override dynamic process(  ) {
			
			if ( ( this.stat & 3 ) != 0 ) {
				return null;
			}

			if ( Lang13.Bool( this.timing ) ) {
				
				if ( Game13.time > this.releasetime ) {
					this.timer_end();
					this.timing = 0;
				}
				this.updateUsrDialog();
				this.update_icon();
			} else {
				this.timer_end();
			}
			return null;
		}

	}

}