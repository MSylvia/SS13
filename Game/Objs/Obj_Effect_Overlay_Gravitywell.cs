// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Effect_Overlay_Gravitywell : Obj_Effect_Overlay {

		public double size = 2;
		public int xp = 6;
		public int xlevel = 4;
		public Obj_Effect_Overlay_Gravitygrid GG = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.pixel_x = -64;
			this.pixel_y = -64;
			this.alpha = 255;
			this.anchored = 1;
			this.icon = "icons/effects/160x160.dmi";
			this.icon_state = "gravitywell_shadow";
			this.layer = 2.1;
		}

		// Function from file: gravitywell.dm
		public Obj_Effect_Overlay_Gravitywell ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			this.GG = new Obj_Effect_Overlay_Gravitygrid( this.loc );
			GlobalFuncs.playsound( this.loc, "sound/weapons/emp.ogg", 75, 1 );
			Icon13.Animate( new ByTable().Set( 1, this.GG ).Set( "alpha", 255 ).Set( "time", 10 ).Set( "easing", 1 ) );
			Task13.Schedule( 0, (Task13.Closure)(() => {
				this.Pulse();
				return;
			}));
			this.overlays.Add( new Image( this.icon, "gravitywell_shadow", 201 ) );
			return;
		}

		// Function from file: gravitywell.dm
		public void Pulse(  ) {
			int outter_size = 0;
			Ent_Static A = null;
			double dist = 0;
			double pull_force = 0;
			Ent_Static AM = null;
			Ent_Static M = null;
			Mob_Living L = null;

			this.xp--;

			if ( this.xp <= 0 ) {
				this.xp = 6;
				this.xlevel--;

				if ( this.xlevel <= -4 ) {
					GlobalFuncs.empulse( this.loc, this.size, this.size + 2 );

					if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Machinery_TheSingularitygen), this.loc ) ) ) {
						new Obj_Machinery_Singularity( this.loc );
					}
					GlobalFuncs.qdel( this );
					return;
				} else if ( this.xlevel > 0 ) {
					this.size++;

					if ( this.GG != null ) {
						this.GG.LevelUp();
						this.transform *= ( this.size * 2 + 1 ) / ( ( this.size - 1 ) * 2 + 1 );
					}
				}
			}
			outter_size = Num13.Floor( this.size + 1 );

			foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInRange( outter_size, this ), typeof(Ent_Static) )) {
				A = _a;
				
				dist = GlobalFuncs.get_dist_euclidian( this, A );
				pull_force = this.size / Num13.MaxInt( 1, Num13.Floor( dist ) );

				if ( A is Ent_Dynamic && this.size >= 4 && Map13.GetDistance( this, A ) == 1 ) {
					A.singularity_pull( this, pull_force * 3, 1 );
					AM = A;
					((dynamic)AM).forceMove( this.loc );
				} else if ( Map13.GetDistance( this, A ) >= 1 ) {
					
					if ( dist <= this.size ) {
						A.singularity_pull( this, pull_force * 3, 1 );

						if ( A is Mob_Living ) {
							M = A;
							((dynamic)M).take_overall_damage( 5, 0 );
							GlobalFuncs.to_chat( M, "<span class='warning'>The " + this + "'s tidal force rips your skin!</span>" );
						}
					}
				}
			}

			foreach (dynamic _b in Lang13.Enumerate( this.loc, typeof(Mob_Living) )) {
				L = _b;
				

				if ( L.stat == 2 && Rand13.PercentChance( 5 ) ) {
					L.gib();
				}
				L.take_overall_damage( 3, 0 );
				GlobalFuncs.to_chat( L, "<span class='danger'>The " + this + "'s tidal force is crushing you!</span>" );
			}
			Task13.Sleep( 10 );
			this.Pulse();
			return;
		}

		// Function from file: gravitywell.dm
		public override dynamic Destroy( dynamic brokenup = null ) {
			
			if ( this.GG != null ) {
				GlobalFuncs.qdel( this.GG );
			}
			base.Destroy( (object)(brokenup) );
			return null;
		}

	}

}