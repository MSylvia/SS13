// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Machinery_RND_ReverseEngine : Obj_Machinery_RND {

		public ByTable research_queue = new ByTable();
		public ByTable ready_queue = new ByTable();
		public int max_queue_len = 0;
		public double scan_rating = 1;
		public double cap_rating = 1;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.research_flags = 8;
			this.icon = "icons/obj/machines/mechanic.dmi";
			this.icon_state = "reverse-engine";
		}

		// Function from file: reverse_engine.dm
		public Obj_Machinery_RND_ReverseEngine ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			this.component_parts = new ByTable(new object [] { 
				new Obj_Item_Weapon_Circuitboard_ReverseEngine(), 
				new Obj_Item_Weapon_StockParts_ScanningModule(), 
				new Obj_Item_Weapon_StockParts_ScanningModule(), 
				new Obj_Item_Weapon_StockParts_Capacitor(), 
				new Obj_Item_Weapon_StockParts_Capacitor(), 
				new Obj_Item_Weapon_StockParts_Manipulator(), 
				new Obj_Item_Weapon_StockParts_ConsoleScreen()
			 });
			this.RefreshParts();
			return;
		}

		// Function from file: reverse_engine.dm
		public override dynamic Topic( string href = null, ByTable href_list = null, dynamic hclient = null, HtmlInterface currui = null ) {
			dynamic design = null;
			dynamic design2 = null;
			dynamic design3 = null;
			dynamic design4 = null;
			dynamic design5 = null;

			
			if ( Lang13.Bool( base.Topic( href, href_list, (object)(hclient) ) ) ) {
				return null;
			}

			if ( Lang13.Bool( href_list["close"] ) ) {
				
				if ( Task13.User.machine == this ) {
					Task13.User.unset_machine();
				}
				return 1;
			}

			if ( Lang13.Bool( href_list["remove_tosearch"] ) ) {
				design = this.research_queue[String13.ParseNumber( href_list["remove_tosearch"] )];

				if ( Lang13.Bool( design ) ) {
					this.research_queue.Remove( design );
					GlobalFuncs.qdel( design );
					design = null;
				}
				this.ui_interact( Task13.User );
				return 1;
			}

			if ( Lang13.Bool( href_list["remove_researched"] ) ) {
				design2 = this.ready_queue[String13.ParseNumber( href_list["remove_researched"] )];

				if ( Lang13.Bool( design2 ) ) {
					this.ready_queue.Remove( design2 );
					GlobalFuncs.qdel( design2 );
					design2 = null;
				}
				this.ui_interact( Task13.User );
				return 1;
			}

			if ( Lang13.Bool( href_list["research"] ) ) {
				design3 = this.research_queue[String13.ParseNumber( href_list["research"] )];

				if ( Lang13.Bool( design3 ) ) {
					this.researchDesign( design3 );
				}
				this.ui_interact( Task13.User );
				return 1;
			}

			if ( Lang13.Bool( href_list["research_all"] ) ) {
				this.researchQueue();
				this.ui_interact( Task13.User );
				return 1;
			}

			if ( Lang13.Bool( href_list["print_design"] ) ) {
				design4 = this.ready_queue[String13.ParseNumber( href_list["print_design"] )];

				if ( Lang13.Bool( design4 ) ) {
					this.PrintDesign( design4, false );
				}
				return 1;
			}

			if ( Lang13.Bool( href_list["nanoprint_design"] ) ) {
				design5 = this.ready_queue[String13.ParseNumber( href_list["nanoprint_design"] )];

				if ( Lang13.Bool( design5 ) ) {
					this.PrintDesign( design5, true );
				}
				return 1;
			}
			return null;
		}

		// Function from file: reverse_engine.dm
		public override void ui_interact( dynamic user = null, string ui_key = null, Nanoui ui = null, bool? force_open = null ) {
			ui_key = ui_key ?? "main";

			ByTable data = null;
			ByTable todo_queue = null;
			ByTable done_queue = null;
			int? i = null;
			dynamic research_item = null;
			int? i2 = null;
			dynamic ready_item = null;

			
			if ( ( this.stat & 3 ) != 0 ) {
				return;
			}

			if ( Lang13.Bool( user.stat ) && !( user is Mob_Dead_Observer ) || ((Mob)user).restrained() || !this.allowed( user ) || !this.Adjacent( user ) ) {
				return;
			}
			data = new ByTable( 0 );
			todo_queue = new ByTable();
			done_queue = new ByTable();
			i = null;
			i = 1;

			while (( i ??0) <= this.research_queue.len) {
				research_item = this.research_queue[i];

				if ( research_item is Design ) {
					todo_queue.Add( new ByTable(new object [] { new ByTable().Set( "name", research_item.name ).Set( "command1", new ByTable().Set( "research", i ) ).Set( "command2", new ByTable().Set( "remove_tosearch", i ) ) }) );
				}
				i++;
			}
			i2 = null;
			i2 = 1;

			while (( i2 ??0) <= this.ready_queue.len) {
				ready_item = this.ready_queue[i2];

				if ( ready_item is Design ) {
					done_queue.Add( new ByTable(new object [] { 
						new ByTable()
							.Set( "name", ready_item.name )
							.Set( "command1", new ByTable().Set( "print_design", i2 ) )
							.Set( "command2", new ByTable().Set( "nanoprint_design", i2 ) )
							.Set( "command3", new ByTable().Set( "remove_researched", i2 ) )
						
					 }) );
				}
				i2++;
			}
			data["research_queue"] = todo_queue;
			data["ready_queue"] = done_queue;
			ui = GlobalVars.nanomanager.try_update_ui( user, this, ui_key, ui, data );

			if ( !( ui != null ) ) {
				ui = new Nanoui( user, this, ui_key, "rev-engine.tmpl", this.name, 1200, 400 );
				ui.set_initial_data( data );
				ui.open();
			}
			return;
		}

		// Function from file: reverse_engine.dm
		public bool PrintDesign( dynamic design = null, bool? use_nano = null ) {
			use_nano = use_nano ?? false;

			Obj_Machinery_RND M = null;
			Obj_Machinery_RND BP = null;

			
			if ( this.linked_console != null ) {
				
				foreach (dynamic _a in Lang13.Enumerate( this.linked_console.linked_machines, typeof(Obj_Machinery_RND) )) {
					M = _a;
					

					if ( M is Obj_Machinery_RND_Blueprinter ) {
						BP = M;
						((dynamic)BP).PrintDesign( design, use_nano );
						return true;
					}
				}
			} else {
				this.visible_message( "You need to link this machine to a research console first!" );
			}
			return false;
		}

		// Function from file: reverse_engine.dm
		public bool researchDesign( dynamic design = null ) {
			double researchtime = 0;

			
			if ( this.busy ) {
				return false;
			}

			if ( !( design is Design ) || !this.research_queue.Contains( design ) ) {
				return false;
			}

			if ( this.ready_queue.Contains( design ) ) {
				this.visible_message( new Txt( "<span class='notice'> " ).icon( this ).str( " " ).The( this ).item().str( " beeps:'The " ).item( design.name ).str( " is already researched.'</span>" ).ToString() );
				this.research_queue.Remove( design );
				return false;
			}
			researchtime = this.Tech_Difference( design ) * 150 / ( this.scan_rating + this.cap_rating );
			this.busy = true;
			this.overlays.Add( "" + this.base_state + "_ani" );
			Task13.Sleep( ((int)( researchtime )) );
			this.research_queue.Remove( design );
			this.busy = false;
			this.overlays.Remove( "" + this.base_state + "_ani" );

			if ( !this.ready_queue.Contains( design ) ) {
				this.ready_queue.Add( design );
				this.visible_message( new Txt( "<span class='notice'> " ).icon( this ).str( " " ).The( this ).item().str( " beeps: 'Successfully researched " ).the( design.name ).item().str( ".'</span>" ).ToString() );
				return true;
			}
			return false;
		}

		// Function from file: reverse_engine.dm
		public bool researchQueue(  ) {
			dynamic current_design = null;

			
			if ( !( this.research_queue.len != 0 ) ) {
				return false;
			}

			while (Lang13.Bool( this.research_queue[1] )) {
				
				if ( ( this.stat & 3 ) != 0 ) {
					return false;
				}
				current_design = this.research_queue[1];

				if ( !this.researchDesign( current_design ) ) {
					break;
				}

				if ( !( this.research_queue.len != 0 ) ) {
					break;
				} else {
					current_design = this.research_queue[1];
				}
			}

			if ( !( this.research_queue.len != 0 ) ) {
				this.visible_message( new Txt( "<span class='notice'> " ).icon( this ).str( " " ).The( this ).item().str( " beeps: 'Successfully researched all designs.'</span>" ).ToString() );
			}
			return false;
		}

		// Function from file: reverse_engine.dm
		public double Tech_Difference( dynamic design = null ) {
			ByTable techlist = null;
			double techdifference = 0;
			dynamic checktech = null;
			Tech pointed_tech = null;
			dynamic checktech2 = null;

			techlist = design.req_tech;
			techdifference = 0;

			if ( techlist.len != 0 && this.linked_console != null ) {
				
				foreach (dynamic _b in Lang13.Enumerate( techlist )) {
					checktech = _b;
					

					foreach (dynamic _a in Lang13.Enumerate( GlobalVars.tech_list, typeof(Tech) )) {
						pointed_tech = _a;
						

						if ( pointed_tech.id == checktech ) {
							
							if ( Convert.ToDouble( techlist[checktech] ) > pointed_tech.level ) {
								techdifference += Convert.ToDouble( techlist[checktech] - pointed_tech.level );
							}
						}
					}
				}
			} else if ( techlist.len != 0 ) {
				
				foreach (dynamic _c in Lang13.Enumerate( techlist )) {
					checktech2 = _c;
					
					techdifference += Convert.ToDouble( techlist[checktech2] - 1 );
				}
			}

			if ( techdifference < 0 ) {
				techdifference = 0;
			}
			return techdifference;
		}

		// Function from file: reverse_engine.dm
		public bool AddDesign( Design design = null, ByTable design_list = null, dynamic user = null ) {
			Design MD = null;
			Design MD2 = null;

			
			if ( !( design is Design ) ) {
				design_list.Remove( design );
				return false;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.research_queue, typeof(Design) )) {
				MD = _a;
				

				if ( MD.build_path == design.build_path ) {
					design_list.Remove( design );
					GlobalFuncs.to_chat( user, new Txt( "<span class='notice'>The " ).item( design.name ).str( " is already loaded onto " ).the( this ).item().str( "!</span>" ).ToString() );
					return false;
				}
			}

			foreach (dynamic _b in Lang13.Enumerate( this.ready_queue, typeof(Design) )) {
				MD2 = _b;
				

				if ( MD2.build_path == design.build_path ) {
					design_list.Remove( design );
					GlobalFuncs.to_chat( user, new Txt( "<span class='notice'>The " ).item( design.name ).str( " has already been researched by " ).the( this ).item().str( "!</span>" ).ToString() );
					return false;
				}
			}

			if ( this.research_queue.len >= this.max_queue_len ) {
				GlobalFuncs.to_chat( user, "<span class='notice'>The " + this + "'s research queue is full. Research some designs first before adding more.</span>" );
				return false;
			}

			if ( design_list.Contains( design ) ) {
				this.research_queue.Add( design );
				design_list.Remove( design );
				GlobalFuncs.to_chat( user, "<span class='notice'>The " + design.name + " was successfully loaded onto the " + this + ".</span>" );
				return true;
			}
			return false;
		}

		// Function from file: reverse_engine.dm
		public override dynamic attackby( dynamic a = null, dynamic b = null, dynamic c = null ) {
			dynamic DA = null;
			ByTable name_list = null;
			Design thisdesign = null;
			dynamic design_name = null;
			Design chosen_design = null;
			int i = 0;
			Design loop_design = null;
			dynamic PDA = null;
			Obj_Item_Device_DeviceAnalyser DA2 = null;
			Design loop_design2 = null;

			
			if ( Lang13.Bool( base.attackby( (object)(a), (object)(b), (object)(c) ) ) ) {
				return 1;
			}

			if ( this.busy ) {
				GlobalFuncs.to_chat( b, "<span class='notice'>The " + this + " is currently busy, please wait until the current operation is finished.</span>" );
				return null;
			}

			if ( a is Obj_Item_Device_DeviceAnalyser ) {
				DA = a;

				if ( DA.loaded_designs != null && DA.loaded_designs.len != 0 ) {
					
					if ( DA.loadone ) {
						name_list = new ByTable();

						foreach (dynamic _a in Lang13.Enumerate( DA.loaded_designs, typeof(Design) )) {
							thisdesign = _a;
							
							name_list[thisdesign.name] = thisdesign;
						}
						design_name = Interface13.Input( b, "Select a design to load", "Select Design", "", name_list, InputType.Null | InputType.Any );
						chosen_design = name_list[design_name];
						this.AddDesign( chosen_design, DA.loaded_designs, b );
						return 1;
					} else {
						i = 0;

						foreach (dynamic _b in Lang13.Enumerate( DA.loaded_designs, typeof(Design) )) {
							loop_design = _b;
							

							if ( !this.AddDesign( loop_design, DA.loaded_designs, b ) ) {
								break;
							}
							i++;
						}
						GlobalFuncs.to_chat( b, new Txt( "Sucessfully transferred " ).item( i ).str( " design" ).s().str( "." ).ToString() );
						return 1;
					}
				}
				return null;
			}

			if ( a is Obj_Item_Device_Pda ) {
				PDA = a;

				if ( PDA.dev_analys != null ) {
					DA2 = PDA.dev_analys;

					foreach (dynamic _c in Lang13.Enumerate( DA2.loaded_designs, typeof(Design) )) {
						loop_design2 = _c;
						
						this.AddDesign( loop_design2, DA2.loaded_designs, b );
					}
					return 1;
				}
				return 0;
			}
			return null;
		}

		// Function from file: reverse_engine.dm
		public override dynamic RefreshParts(  ) {
			int i = 0;
			Obj_Item_Weapon_StockParts_ScanningModule S = null;
			Obj_Item_Weapon_StockParts_Capacitor C = null;
			Obj_Item_Weapon_StockParts_Manipulator M = null;

			i = 0;

			foreach (dynamic _a in Lang13.Enumerate( this.component_parts, typeof(Obj_Item_Weapon_StockParts_ScanningModule) )) {
				S = _a;
				
				i++;
				this.scan_rating += S.rating;
			}
			this.scan_rating = this.scan_rating / i;
			i = 0;

			foreach (dynamic _b in Lang13.Enumerate( this.component_parts, typeof(Obj_Item_Weapon_StockParts_Capacitor) )) {
				C = _b;
				
				i++;
				this.cap_rating += C.rating;
			}
			this.cap_rating = this.cap_rating / i;

			foreach (dynamic _c in Lang13.Enumerate( this.component_parts, typeof(Obj_Item_Weapon_StockParts_Manipulator) )) {
				M = _c;
				
				this.max_queue_len = M.rating * 10;
			}
			return null;
		}

	}

}