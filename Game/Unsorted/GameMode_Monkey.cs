// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class GameMode_Monkey : GameMode {

		public int? carriers_to_make = 1;
		public ByTable carriers = new ByTable();
		public int monkeys_to_win = 0;
		public int escaped_monkeys = 0;
		public int players_per_carrier = 30;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.name = "monkey";
			this.config_tag = "monkey";
			this.antag_flag = "monkey";
			this.required_players = 20;
			this.required_enemies = 1;
			this.recommended_enemies = 1;
			this.restricted_jobs = new ByTable(new object [] { "Cyborg", "AI" });
		}

		// Function from file: monkey.dm
		public override bool declare_completion(  ) {
			
			if ( this.check_monkey_victory() ) {
				GlobalFuncs.feedback_set_details( "round_end_result", "win - monkey win" );
				GlobalFuncs.feedback_set( "round_end_result", this.escaped_monkeys );
				Game13.WriteMsg( "<span class='userdanger'>The monkeys have overthrown their captors! Eeek eeeek!!</span>" );
			} else {
				GlobalFuncs.feedback_set_details( "round_end_result", "loss - staff stopped the monkeys" );
				GlobalFuncs.feedback_set( "round_end_result", this.escaped_monkeys );
				Game13.WriteMsg( "<span class='userdanger'>The staff managed to contain the monkey infestation!</span>" );
			}
			return false;
		}

		// Function from file: monkey.dm
		public override bool check_finished(  ) {
			Mind monkey_mind = null;
			Disease_Transformation_JungleFever D = null;
			Mob_Living_Carbon_Human H = null;

			
			if ( GlobalVars.SSshuttle.emergency.mode >= 6 || this.station_was_nuked ) {
				return true;
			}

			if ( !Lang13.Bool( this.round_converted ) ) {
				
				foreach (dynamic _a in Lang13.Enumerate( this.ape_infectees, typeof(Mind) )) {
					monkey_mind = _a;
					
					this.continuous_sanity_checked = true;

					if ( Lang13.Bool( monkey_mind.current ) && Convert.ToInt32( monkey_mind.current.stat ) != 2 ) {
						return false;
					}
				}
				D = new Disease_Transformation_JungleFever();

				foreach (dynamic _b in Lang13.Enumerate( GlobalVars.living_mob_list, typeof(Mob_Living_Carbon_Human) )) {
					H = _b;
					

					if ( H.mind != null && H.stat != 2 ) {
						
						if ( H.HasDisease( D ) ) {
							return false;
						}
					}
				}
			}
			base.check_finished();
			return false;
		}

		// Function from file: monkey.dm
		public override bool post_setup( bool? report = null ) {
			Mind carriermind = null;
			Disease_Transformation_JungleFever D = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.carriers, typeof(Mind) )) {
				carriermind = _a;
				
				this.greet_carrier( carriermind );
				this.ape_infectees.Add( carriermind );
				D = new Disease_Transformation_JungleFever();
				D.visibility_flags = 3;
				D.holder = carriermind.current;
				D.affected_mob = carriermind.current;
				carriermind.current.viruses += D;
			}
			base.post_setup( report );
			return false;
		}

		// Function from file: monkey.dm
		public bool check_monkey_victory(  ) {
			Disease_Transformation_JungleFever D = null;
			Mob_Living_Carbon_Monkey M = null;

			
			if ( GlobalVars.SSshuttle.emergency.mode != 6 ) {
				return false;
			}
			D = new Disease_Transformation_JungleFever();

			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.living_mob_list, typeof(Mob_Living_Carbon_Monkey) )) {
				M = _a;
				

				if ( M.HasDisease( D ) ) {
					
					if ( M.onCentcom() || M.onSyndieBase() ) {
						this.escaped_monkeys++;
					}
				}
			}

			if ( this.escaped_monkeys >= this.monkeys_to_win ) {
				return true;
			} else {
				return false;
			}
		}

		// Function from file: monkey.dm
		public void greet_carrier( Mind carrier = null ) {
			carrier.current.WriteMsg( "<B><span class='notice'>You are the Jungle Fever patient zero!!</B>" );
			carrier.current.WriteMsg( "<b>You have been planted onto this station by the Animal Rights Consortium.</b>" );
			carrier.current.WriteMsg( "<b>Soon the disease will transform you into an ape. Afterwards, you will be able spread the infection to others with a bite.</b>" );
			carrier.current.WriteMsg( "<b>While your infection strain is undetectable by scanners, any other infectees will show up on medical equipment.</b>" );
			carrier.current.WriteMsg( "<b>Your mission will be deemed a success if any of the live infected monkeys reach Centcom.</b>" );
			return;
		}

		// Function from file: monkey.dm
		public override void announce(  ) {
			Game13.WriteMsg( "<B>The current game mode is - Monkey!</B>" );
			Game13.WriteMsg( "<B>One or more crewmembers have been infected with Jungle Fever! Crew: Contain the outbreak. None of the infected monkeys may escape alive to Centcom. Monkeys: Ensure that your kind lives on! Rise up against your captors!</B>" );
			return;
		}

		// Function from file: monkey.dm
		public override bool pre_setup(  ) {
			int? j = null;
			dynamic carrier = null;

			this.carriers_to_make = Num13.MaxInt( ((int)( Num13.Round( this.num_players() / this.players_per_carrier, 1 ) )), 1 );
			j = null;
			j = 0;

			while (( j ??0) < ( this.carriers_to_make ??0)) {
				
				if ( !( this.antag_candidates.len != 0 ) ) {
					break;
				}
				carrier = Rand13.PickFromTable( this.antag_candidates );
				this.carriers.Add( carrier );
				carrier.special_role = "monkey";
				carrier.restricted_roles = this.restricted_jobs;
				GlobalFuncs.log_game( "" + carrier.key + " (ckey) has been selected as a Jungle Fever carrier" );
				this.antag_candidates.Remove( carrier );
				j++;
			}

			if ( !( this.carriers.len != 0 ) ) {
				return false;
			}
			return true;
		}

	}

}