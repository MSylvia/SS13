// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Event_Heist : Event {

		public ByTable raid_objectives = new ByTable();
		public ByTable raiders = new ByTable();
		public int required_candidates = 4;
		public int max_candidates = 6;
		public bool successSpawn = false;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.announceWhen = 600;
			this.oneShot = true;
		}

		public Event_Heist ( Obj_Item_MechaParts_MechaEquipment_Tool_CableLayer tlistener = null, string tprocname = null ) : base( tlistener, tprocname ) {
			
		}

		// Function from file: heist.dm
		public dynamic check_finished(  ) {
			
			if ( !this.is_raider_crew_alive() || GlobalVars.vox_shuttle != null && GlobalVars.vox_shuttle.returned_home ) {
				return 1;
			}
			return Lang13.SuperCall();
		}

		// Function from file: heist.dm
		public dynamic declare_completion(  ) {
			string win_type = null;
			string win_group = null;
			string win_msg = null;
			int success = 0;
			Objective O = null;
			int count = 0;
			Objective objective = null;

			
			if ( !( this.raid_objectives.len != 0 ) ) {
				return Lang13.SuperCall();
			}
			win_type = "Major";
			win_group = "Crew";
			win_msg = "";
			success = this.raid_objectives.len;

			foreach (dynamic _a in Lang13.Enumerate( this.raid_objectives, typeof(Objective) )) {
				O = _a;
				

				if ( !Lang13.Bool( O.check_completion() ) ) {
					success--;
				}
			}

			if ( success == this.raid_objectives.len ) {
				win_type = "Major";
				win_group = "Vox";
			} else if ( success > 2 ) {
				win_type = "Minor";
				win_group = "Vox";
			} else {
				win_type = "Minor";
				win_group = "Crew";
			}

			if ( !this.is_raider_crew_alive() ) {
				win_type = "Major";
				win_group = "Crew";
				win_msg += "<B>The Vox Raiders have been wiped out!</B>";
			} else if ( !this.is_raider_crew_safe() ) {
				
				if ( win_group == "Crew" && win_type == "Minor" ) {
					win_type = "Major";
				}
				win_group = "Crew";
				win_msg += "<B>The Vox Raiders have left someone behind!</B>";
			} else if ( win_group == "Vox" ) {
				
				if ( win_type == "Minor" ) {
					win_type = "Major";
				}
				win_msg += "<B>The Vox Raiders escaped the station!</B>";
			} else {
				win_msg += "<B>The Vox Raiders were repelled!</B>";
			}
			GlobalFuncs.to_chat( typeof(Game13), "<span class='danger'><FONT size = 3>" + win_type + " " + win_group + " victory!</FONT>\n		" + win_msg + "</span>" );
			GlobalFuncs.feedback_set_details( "round_end_result", "heist - " + win_type + " " + win_group );
			count = 1;

			foreach (dynamic _b in Lang13.Enumerate( this.raid_objectives, typeof(Objective) )) {
				objective = _b;
				

				if ( Lang13.Bool( objective.check_completion() ) ) {
					GlobalFuncs.to_chat( typeof(Game13), "<br><B>Objective #" + count + "</B>: " + objective.explanation_text + " <font color='green'><B>Success!</B></font>" );
					GlobalFuncs.feedback_add_details( "traitor_objective", "" + objective.type + "|SUCCESS" );
				} else {
					GlobalFuncs.to_chat( typeof(Game13), "<br><B>Objective #" + count + "</B>: " + objective.explanation_text + " <font color='red'>Fail.</font>" );
					GlobalFuncs.feedback_add_details( "traitor_objective", "" + objective.type + "|FAIL" );
				}
				count++;
			}
			Lang13.SuperCall();
			return null;
		}

		// Function from file: heist.dm
		public void greet_vox( Mind raider = null ) {
			int obj_count = 0;
			Objective objective = null;

			GlobalFuncs.to_chat( raider.current, "<span class='notice'><B>You are a Vox Raider, fresh from the Shoal!</b>\nThe Vox are a race of cunning, sharp-eyed nomadic raiders and traders endemic to Tau Ceti and much of the unexplored galaxy. You and the crew have come to the " + GlobalFuncs.station_name() + " for plunder, trade or both.\nVox are cowardly and will flee from larger groups, but corner one or find them en masse and they are vicious.\nUse :V to voxtalk, :H to talk on your encrypted channel, and <b>don't forget to turn on your nitrogen internals!</b></span>" );
			obj_count = 1;

			foreach (dynamic _a in Lang13.Enumerate( raider.objectives, typeof(Objective) )) {
				objective = _a;
				
				GlobalFuncs.to_chat( raider.current, "<B>Objective #" + obj_count + "</B>: " + objective.explanation_text );
				obj_count++;
			}
			return;
		}

		// Function from file: heist.dm
		public ByTable forge_vox_objectives(  ) {
			Objective_Heist O = null;
			Objective_Steal O2 = null;

			
			if ( Rand13.PercentChance( 25 ) ) {
				this.raid_objectives.Add( new Objective_Heist_Kidnap() );
			}
			this.raid_objectives.Add( new Objective_Steal_Heist() );
			this.raid_objectives.Add( new Objective_Steal_Salvage() );
			this.raid_objectives.Add( new Objective_Heist_InviolateCrew() );
			this.raid_objectives.Add( new Objective_Heist_InviolateDeath() );

			foreach (dynamic _a in Lang13.Enumerate( this.raid_objectives, typeof(Objective_Heist) )) {
				O = _a;
				
				O.choose_target();
			}

			foreach (dynamic _b in Lang13.Enumerate( this.raid_objectives, typeof(Objective_Steal) )) {
				O2 = _b;
				
				O2.find_target();
			}
			return this.raid_objectives;
		}

		// Function from file: heist.dm
		public bool is_raider_crew_alive(  ) {
			Mind raider = null;

			
			if ( this.raiders.len == 0 ) {
				return false;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.raiders, typeof(Mind) )) {
				raider = _a;
				

				if ( !( raider != null ) || !Lang13.Bool( raider.current ) ) {
					continue;
				}

				if ( Lang13.Bool( raider.current ) ) {
					
					if ( raider.current is Mob_Living_Carbon_Human && Convert.ToInt32( raider.current.stat ) != 2 ) {
						return true;
					}
				}
			}
			return false;
		}

		// Function from file: heist.dm
		public bool is_raider_crew_safe(  ) {
			Mind M = null;

			
			if ( this.raiders.len == 0 ) {
				return false;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.raiders, typeof(Mind) )) {
				M = _a;
				

				if ( !( M != null ) || !Lang13.Bool( M.current ) ) {
					continue;
				}

				if ( GlobalFuncs.get_area( M.current ) != Lang13.FindObj( typeof(Zone_Shuttle_Vox_Station) ) ) {
					return false;
				}
			}
			return true;
		}

		// Function from file: heist.dm
		public override bool start(  ) {
			ByTable candidates = null;
			int raider_num = 0;
			dynamic new_raider = null;
			Mind raider = null;
			ByTable raider_spawn = null;
			Obj_Effect_Landmark L = null;
			int index = 0;
			Mind raider2 = null;
			dynamic vox = null;
			Organ_External limb = null;

			
			if ( !base.start() ) {
				return false;
			}
			candidates = GlobalFuncs.get_candidates( "vox raider" );
			raider_num = 0;

			if ( candidates.len < this.required_candidates ) {
				return false;
			} else if ( candidates.len < this.max_candidates ) {
				raider_num = candidates.len;
			} else {
				raider_num = this.max_candidates;
			}

			while (raider_num > 0) {
				new_raider = Rand13.PickFromTable( candidates );
				this.raiders.Add( new_raider );
				candidates.Remove( new_raider );
				raider_num--;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.raiders, typeof(Mind) )) {
				raider = _a;
				
				raider.assigned_role = "MODE";
				raider.special_role = "Vox Raider";
			}
			raider_spawn = new ByTable();

			foreach (dynamic _b in Lang13.Enumerate( GlobalVars.landmarks_list, typeof(Obj_Effect_Landmark) )) {
				L = _b;
				

				if ( L.name == "voxstart" ) {
					raider_spawn.Add( GlobalFuncs.get_turf( L ) );
					GlobalFuncs.qdel( L );
					L = null;
					continue;
				}
			}
			this.raid_objectives = this.forge_vox_objectives();
			index = 1;

			foreach (dynamic _d in Lang13.Enumerate( this.raiders, typeof(Mind) )) {
				raider2 = _d;
				

				if ( index > raider_spawn.len ) {
					index = 1;
				}
				raider2.current.loc = raider_spawn[index];
				index++;
				vox = raider2.current;
				vox.age = Rand13.Int( 12, 20 );
				vox.dna.mutantrace = "vox";
				((Mob_Living_Carbon_Human)vox).set_species( "Vox" );
				((Mob)vox).generate_name();
				vox.flavor_text = "";
				((Mob)vox).add_language( "Vox-pidgin" );
				((Mob)vox).remove_language( "Galactic Common" );
				vox.h_style = "Short Vox Quills";
				vox.f_style = "Shaved";

				foreach (dynamic _c in Lang13.Enumerate( vox.organs, typeof(Organ_External) )) {
					limb = _c;
					
					limb.status &= 65343;
				}
				((Mob_Living_Carbon_Human)vox).equip_vox_raider();
				((Mob)vox).regenerate_icons();
				raider2.objectives = this.raid_objectives;
				this.greet_vox( raider2 );
			}
			GlobalVars.vox_sent = true;
			return false;
		}

		// Function from file: heist.dm
		public override void announce(  ) {
			return;
		}

		// Function from file: heist.dm
		public override void setup(  ) {
			this.announceWhen = Rand13.Int( this.announceWhen, this.announceWhen + 50 );
			GlobalVars.sent_aliens_to_station = true;
			return;
		}

	}

}