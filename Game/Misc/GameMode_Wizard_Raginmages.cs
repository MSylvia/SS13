// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class GameMode_Wizard_Raginmages : GameMode_Wizard {

		public int max_mages = 0;
		public bool making_mage = false;
		public int mages_made = 1;
		public int time_checked = 0;
		public int exhausted_pool = 0;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.name = "Ragin' Mages";
			this.config_tag = "raginmages";
			this.required_players = 1;
			this.required_players_secret = 15;
			this.rage = true;
		}

		// Function from file: raginmages.dm
		public override bool declare_completion( bool? ragin = null ) {
			
			if ( this.finished ) {
				GlobalFuncs.feedback_set_details( "round_end_result", "loss - wizard killed" );
				GlobalFuncs.to_chat( typeof(Game13), "<span class='danger'><FONT size = 3> The crew has managed to hold off the wizard attack! The Space Wizards Federation has been taught a lesson they will not soon forget!</FONT></span>" );
			}
			base.declare_completion( true );
			return false;
		}

		// Function from file: raginmages.dm
		public bool make_more_mages(  ) {
			ByTable candidates = null;
			dynamic theghost = null;
			Mob_Dead_Observer G = null;
			dynamic i = null;
			Mob_Living_Carbon_Human new_character = null;

			
			if ( this.making_mage || GlobalVars.emergency_shuttle.departed ) {
				return false;
			}

			if ( this.mages_made >= this.max_mages ) {
				return false;
			}
			this.making_mage = true;
			this.mages_made++;
			candidates = new ByTable();
			theghost = null;
			Task13.Schedule( Rand13.Int( 200, 600 ), (Task13.Closure)(() => {
				GlobalFuncs.message_admins( "SWF is still pissed, sending another wizard - " + ( this.max_mages - this.mages_made ) + " left." );

				foreach (dynamic _a in Lang13.Enumerate( GlobalFuncs.get_active_candidates( "wizard", null, "Do you wish to be considered for the position of Space Wizard Foundation 'diplomat'?" ), typeof(Mob_Dead_Observer) )) {
					G = _a;
					

					if ( G.client != null && !( G.client.holder != null ) && !Lang13.Bool( GlobalFuncs.jobban_isbanned( G, "wizard" ) ) && !Lang13.Bool( GlobalFuncs.jobban_isbanned( G, "Syndicate" ) ) ) {
						
						if ( G.mind != null && G.mind.isScrying ) {
							
							if ( Convert.ToDouble( G.mind.current.stat ) < 2 || !( G.mind.current is Mob_Living_Carbon ) || G.mind.current is Mob_Living_Carbon_Brain ) {
								continue;
							}
						}
						candidates.Add( G );
					}
				}

				if ( !( candidates.len != 0 ) ) {
					GlobalFuncs.message_admins( "No candidates found, sleeping until another mage check..." );
					this.exhausted_pool++;
					this.making_mage = false;
					this.mages_made--;
					return;
				} else {
					this.exhausted_pool = 0;
					GlobalFuncs.shuffle( candidates );

					foreach (dynamic _b in Lang13.Enumerate( candidates )) {
						i = _b;
						

						if ( !Lang13.Bool( i ) || !Lang13.Bool( i.client ) ) {
							continue;
						}
						theghost = i;
						break;
					}
				}

				if ( Lang13.Bool( theghost ) ) {
					new_character = GlobalFuncs.makeBody( theghost );
					new_character.mind.make_Wizard();
					new_character.dna.ResetSE();
					this.making_mage = false;
					return;
				}
				return;
			}));
			return false;
		}

		// Function from file: raginmages.dm
		public override bool check_finished(  ) {
			int wizards_alive = 0;
			Mind wizard = null;

			wizards_alive = 0;

			foreach (dynamic _a in Lang13.Enumerate( this.wizards, typeof(Mind) )) {
				wizard = _a;
				

				if ( !( wizard.current is Mob_Living_Carbon ) ) {
					continue;
				}

				if ( wizard.current is Mob_Living_Carbon_Brain ) {
					continue;
				}

				if ( Convert.ToInt32( wizard.current.stat ) == 2 ) {
					continue;
				}

				if ( Lang13.Bool( wizard.current.stat ) == true ) {
					
					if ( Convert.ToDouble( wizard.current.health ) < 0 ) {
						GlobalFuncs.to_chat( wizard.current, "<span class='warning'><font size='4'>The Space Wizard Federation is upset with your performance and have terminated your employment.</font></span>" );
						wizard.current.stat = 2;
						continue;
					}
				}
				wizards_alive++;
			}

			if ( wizards_alive != 0 ) {
				
				if ( !( this.time_checked != 0 ) ) {
					this.time_checked = Game13.time;
				}

				if ( Game13.time > this.time_checked + 12000 && this.mages_made < this.max_mages ) {
					this.time_checked = Game13.time;
					this.make_more_mages();
				}
			} else if ( !this.making_mage && ( this.wizards.len >= this.max_mages || this.exhausted_pool >= 5 ) ) {
				this.finished = true;
				return true;
			} else {
				this.make_more_mages();
				return false;
			}
			return base.check_finished();
		}

		// Function from file: raginmages.dm
		public override void greet_wizard( Mind wizard = null, bool? you_are = null ) {
			you_are = you_are ?? true;

			int obj_count = 0;
			Objective objective = null;

			
			if ( you_are == true ) {
				GlobalFuncs.to_chat( wizard.current, "<span class='danger'>You are the Space Wizard!</span>" );
			}
			GlobalFuncs.to_chat( wizard.current, "<B>The Space Wizards Federation has given you the following tasks:</B>" );
			obj_count = 1;
			GlobalFuncs.to_chat( wizard.current, "<b>Objective Alpha</b>: Make sure the station pays for its actions against our diplomats" );

			foreach (dynamic _a in Lang13.Enumerate( wizard.objectives, typeof(Objective) )) {
				objective = _a;
				
				GlobalFuncs.to_chat( wizard.current, "<B>Objective #" + obj_count + "</B>: " + objective.explanation_text );
				obj_count++;
			}
			return;
		}

		// Function from file: raginmages.dm
		public override bool post_setup(  ) {
			int playercount = 0;
			Mob_Living player = null;

			playercount = 0;
			base.post_setup();

			if ( !( this.max_mages != 0 ) ) {
				
				foreach (dynamic _a in Lang13.Enumerate( GlobalVars.mob_list, typeof(Mob_Living) )) {
					player = _a;
					

					if ( player.client != null && player.stat != 2 ) {
						playercount += 1;
					}
					this.max_mages = Num13.Floor( playercount / 5 );
				}
			}
			return false;
		}

	}

}