// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class GameMode_Changeling : GameMode {

		public int prob_int_murder_target = 50;
		public int prob_right_murder_target_l = 25;
		public int prob_right_murder_target_h = 50;
		public int prob_int_item = 50;
		public int prob_right_item_l = 25;
		public int prob_right_item_h = 50;
		public int prob_int_sab_target = 50;
		public int prob_right_sab_target_l = 25;
		public int prob_right_sab_target_h = 50;
		public int prob_right_killer_l = 25;
		public int prob_right_killer_h = 50;
		public int prob_right_objective_l = 25;
		public int prob_right_objective_h = 50;
		public int waittime_l = 600;
		public int waittime_h = 1800;
		public int? changeling_amount = 4;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.name = "changeling";
			this.config_tag = "changeling";
			this.restricted_jobs = new ByTable(new object [] { "AI", "Cyborg", "Mobile MMI" });
			this.protected_jobs = new ByTable(new object [] { "Security Officer", "Warden", "Detective", "Head of Security", "Captain" });
			this.required_players = 1;
			this.required_players_secret = 20;
			this.required_enemies = 1;
			this.recommended_enemies = 4;
		}

		// Function from file: changeling.dm
		public override bool post_setup(  ) {
			Mind changeling = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.changelings, typeof(Mind) )) {
				changeling = _a;
				
				this.grant_changeling_powers( changeling.current );
				changeling.special_role = "Changeling";
				this.forge_changeling_objectives( changeling );
				this.greet_changeling( changeling );
			}

			if ( !this.mixed ) {
				Task13.Schedule( Rand13.Int( GlobalVars.waittime_l, GlobalVars.waittime_h ), (Task13.Closure)(() => {
					
					if ( !this.mixed ) {
						this.send_intercept();
					}
					return;
				}));
				base.post_setup();
			}
			return false;
		}

		// Function from file: changeling.dm
		public override bool pre_setup(  ) {
			ByTable possible_changelings = null;
			Mind player = null;
			dynamic job = null;
			int? i = null;
			dynamic changeling = null;

			
			if ( GlobalVars.ticker.mode is GameMode_Mixed ) {
				this.mixed = true;
			}

			if ( GlobalVars.config.protect_roles_from_antagonist ) {
				this.restricted_jobs.Add( this.protected_jobs );
			}
			possible_changelings = this.get_players_for_role( "changeling" );

			foreach (dynamic _b in Lang13.Enumerate( possible_changelings, typeof(Mind) )) {
				player = _b;
				

				if ( this.mixed && GlobalVars.ticker.mode.modePlayer.Contains( player ) ) {
					possible_changelings.Remove( player );
					continue;
				}

				foreach (dynamic _a in Lang13.Enumerate( this.restricted_jobs )) {
					job = _a;
					

					if ( player.assigned_role == job ) {
						possible_changelings.Remove( player );
					}
				}
			}
			this.changeling_amount = Num13.Floor( this.num_players() / 10 ) + 1;

			if ( this.mixed ) {
				this.changeling_amount = Num13.MinInt( 2, this.changeling_amount ??0 );
			}

			if ( possible_changelings.len > 0 ) {
				i = null;
				i = 0;

				while (( i ??0) < ( this.changeling_amount ??0)) {
					
					if ( !( possible_changelings.len != 0 ) ) {
						break;
					}
					changeling = Rand13.PickFromTable( possible_changelings );

					if ( Lang13.Bool( changeling.special_role ) ) {
						possible_changelings.Remove( changeling );
					} else {
						possible_changelings.Remove( changeling );
						this.changelings.Add( changeling );
						this.modePlayer.Add( this.changelings );
					}
					i++;
				}
				GlobalFuncs.log_admin( "Starting a round of changeling with " + this.changelings.len + " changelings." );
				GlobalFuncs.message_admins( "Starting a round of changeling with " + this.changelings.len + " changelings." );

				if ( this.mixed ) {
					GlobalVars.ticker.mode.modePlayer.Add( this.changelings );
					GlobalVars.ticker.mode.changelings.Add( this.changelings );
				}
				return true;
			} else {
				GlobalFuncs.log_admin( "Failed to set-up a round of changeling. Couldn't find any volunteers to be changeling." );
				GlobalFuncs.message_admins( "Failed to set-up a round of changeling. Couldn't find any volunteers to be changeling." );

				if ( this.mixed ) {
					GlobalVars.ticker.mode.modePlayer.Remove( this.changelings );
					GlobalVars.ticker.mode.traitors.Remove( this.changelings );
				}
				return false;
			}
		}

		// Function from file: changeling.dm
		public override void announce(  ) {
			GlobalFuncs.to_chat( typeof(Game13), "<B>The current game mode is - Changeling!</B>" );
			GlobalFuncs.to_chat( typeof(Game13), "<B>There are alien changelings on the station. Do not let the changelings succeed!</B>" );
			return;
		}

	}

}