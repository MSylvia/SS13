// FILE AUTOGENERATED BY SOMNIUM13.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Mob_Living_SimpleAnimal_Hostile : Mob_Living_SimpleAnimal {

		public dynamic target = null;
		public bool ranged = false;
		public bool rapid = false;
		public dynamic projectiletype = null;
		public string projectilesound = null;
		public dynamic casingtype = null;
		public int move_to_delay = 3;
		public ByTable friends = new ByTable();
		public ByTable emote_taunt = new ByTable();
		public dynamic taunt_chance = 0;
		public string ranged_message = "fires";
		public int ranged_cooldown = 0;
		public int ranged_cooldown_cap = 3;
		public bool check_friendly_fire = false;
		public dynamic retreat_distance = null;
		public dynamic minimum_distance = 1;
		public bool robust_searching = false;
		public int? vision_range = 9;
		public int? aggro_vision_range = 9;
		public int idle_vision_range = 9;
		public int search_objects = 0;
		public dynamic wanted_objects = new ByTable();
		public int stat_attack = 0;
		public bool stat_exclusive = false;
		public int attack_same = 0;
		public int AIStatus = 1;
		public dynamic targets_from = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.faction = new ByTable(new object [] { "hostile" });
			this.stop_automated_movement_when_pulled = false;
			this.environment_smash = 1;
		}

		// Function from file: hostile.dm
		public Mob_Living_SimpleAnimal_Hostile ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;

			if ( !Lang13.Bool( this.targets_from ) ) {
				this.targets_from = this;
			}
			return;
		}

		// Function from file: hostile.dm
		public override void RangedAttack( Ent_Static A = null, string _params = null ) {
			
			if ( this.ranged && this.ranged_cooldown <= 0 ) {
				this.target = A;
				this.OpenFire( A );
			}
			base.RangedAttack( A, _params );
			return;
		}

		// Function from file: hostile.dm
		public override bool death( bool? gibbed = null, bool? toast = null ) {
			this.LoseTarget();
			base.death( gibbed, toast );
			return false;
		}

		// Function from file: hostile.dm
		public override dynamic adjustHealth( dynamic amount = null ) {
			dynamic _default = null;

			_default = base.adjustHealth( (object)(amount) );

			if ( !Lang13.Bool( this.ckey ) && !( this.stat != 0 ) && this.search_objects < 3 && Convert.ToDouble( amount ) > 0 ) {
				
				if ( this.search_objects != 0 ) {
					this.search_objects = 0;
					this.target = null;
				}

				if ( this.AIStatus == 2 ) {
					this.AIStatus = 1;
					this.FindTarget();
				} else if ( this.target != null && Rand13.PercentChance( 40 ) ) {
					this.FindTarget();
				}
			}
			return _default;
		}

		// Function from file: hostile.dm
		public override bool CanAttack( dynamic the_target = null ) {
			dynamic M = null;
			dynamic L = null;
			bool faction_check = false;

			
			if ( !Lang13.Bool( the_target ) ) {
				return false;
			}

			if ( this.see_invisible < Convert.ToDouble( the_target.invisibility ) ) {
				return false;
			}

			if ( this.search_objects < 2 ) {
				
				if ( the_target is Obj_Mecha ) {
					M = the_target;

					if ( Lang13.Bool( M.occupant ) ) {
						
						if ( this.CanAttack( M.occupant ) ) {
							return true;
						}
					}
				}

				if ( the_target is Mob_Living ) {
					L = the_target;
					faction_check = this.faction_check( L );

					if ( this.robust_searching ) {
						
						if ( Convert.ToDouble( L.stat ) > this.stat_attack || Convert.ToInt32( L.stat ) != this.stat_attack && this.stat_exclusive ) {
							return false;
						}

						if ( faction_check && !( this.attack_same != 0 ) || !faction_check && this.attack_same == 2 ) {
							return false;
						}

						if ( this.friends.Contains( L ) ) {
							return false;
						}
					} else {
						
						if ( Lang13.Bool( L.stat ) ) {
							return false;
						}

						if ( faction_check && !( this.attack_same != 0 ) ) {
							return false;
						}
					}
					return true;
				}
			}

			if ( the_target is Obj ) {
				
				if ( Lang13.Bool( this.wanted_objects.Contains( the_target.type ) ) ) {
					return true;
				}
			}
			return false;
		}

		// Function from file: hostile.dm
		public virtual bool AIShouldSleep( ByTable possible_targets = null ) {
			return !Lang13.Bool( this.FindTarget( possible_targets, true ) );
		}

		// Function from file: hostile.dm
		public bool AICanContinue( ByTable possible_targets = null ) {
			bool _default = false;

			
			switch ((int)( this.AIStatus )) {
				case 1:
					_default = true;
					break;
				case 2:
					
					if ( Lang13.Bool( this.FindTarget( possible_targets, true ) ) ) {
						_default = true;
						this.AIStatus = 1;
					} else {
						_default = false;
					}
					break;
			}
			return _default;
		}

		// Function from file: hostile.dm
		public bool FindHidden(  ) {
			Ent_Static A = null;

			
			if ( this.target.loc is Obj_Structure_Closet || this.target.loc is Obj_Machinery_Disposal || this.target.loc is Obj_Machinery_Sleeper ) {
				A = this.target.loc;
				this.Goto( A, this.move_to_delay, this.minimum_distance );

				if ( A.Adjacent( this.targets_from ) ) {
					A.attack_animal( this );
				}
				return true;
			}
			return false;
		}

		// Function from file: hostile.dm
		public virtual bool EscapeConfinement(  ) {
			dynamic A = null;

			
			if ( this.buckled != null ) {
				this.buckled.attack_animal( this );
			}

			if ( !( this.targets_from.loc is Tile ) && this.targets_from.loc != null ) {
				A = GlobalFuncs.get_turf( this.targets_from );
				((Ent_Static)A).attack_animal( this );
			}
			return false;
		}

		// Function from file: hostile.dm
		public virtual void DestroySurroundings(  ) {
			dynamic dir = null;
			Tile T = null;
			dynamic a = null;
			dynamic A = null;

			
			if ( this.environment_smash != 0 ) {
				this.EscapeConfinement();

				foreach (dynamic _b in Lang13.Enumerate( GlobalVars.cardinal )) {
					dir = _b;
					
					T = Map13.GetStep( this.targets_from, Convert.ToInt32( dir ) );

					if ( T is Tile_Simulated_Wall || T is Tile_Simulated_Mineral ) {
						
						if ( T.Adjacent( this.targets_from ) ) {
							T.attack_animal( this );
						}
					}

					foreach (dynamic _a in Lang13.Enumerate( T )) {
						a = _a;
						
						A = a;

						if ( !((Ent_Static)A).Adjacent( this.targets_from ) ) {
							continue;
						}

						if ( A is Obj_Structure_Window || A is Obj_Structure_Closet || A is Obj_Structure_Table || A is Obj_Structure_Grille || A is Obj_Structure_Rack ) {
							((Ent_Static)A).attack_animal( this );
						}
					}
				}
			}
			return;
		}

		// Function from file: hostile.dm
		public virtual void Shoot( dynamic targeted_atom = null ) {
			dynamic startloc = null;
			dynamic casing = null;
			dynamic P = null;

			
			if ( targeted_atom == this.targets_from.loc || targeted_atom == this.targets_from ) {
				return;
			}
			startloc = GlobalFuncs.get_turf( this.targets_from );

			if ( Lang13.Bool( this.casingtype ) ) {
				casing = Lang13.Call( this.casingtype );
				GlobalFuncs.playsound( this, this.projectilesound, 100, 1 );
				((Obj_Item_AmmoCasing)casing).fire( targeted_atom, this, null, null, null, GlobalFuncs.ran_zone() );
				casing.loc = startloc;
			} else if ( Lang13.Bool( this.projectiletype ) ) {
				P = Lang13.Call( this.projectiletype, startloc );
				GlobalFuncs.playsound( this, this.projectilesound, 100, 1 );
				P.current = startloc;
				P.starting = startloc;
				P.firer = this;
				P.yo = Convert.ToDouble( targeted_atom.y - startloc.y );
				P.xo = Convert.ToDouble( targeted_atom.x - startloc.x );

				if ( this.AIStatus == 3 ) {
					this.newtonian_move( Map13.GetDistance( targeted_atom, this.targets_from ) );
				}
				P.original = targeted_atom;
				((Obj_Item_Projectile)P).fire();
			}
			return;
		}

		// Function from file: hostile.dm
		public virtual void OpenFire( dynamic A = null ) {
			dynamic T = null;
			Mob_Living L = null;

			
			if ( this.check_friendly_fire ) {
				
				foreach (dynamic _b in Lang13.Enumerate( GlobalFuncs.getline( this, A ) )) {
					T = _b;
					

					foreach (dynamic _a in Lang13.Enumerate( T, typeof(Mob_Living) )) {
						L = _a;
						

						if ( L == this || L == A ) {
							continue;
						}

						if ( this.faction_check( L ) && !( this.attack_same != 0 ) ) {
							return;
						}
					}
				}
			}
			this.visible_message( "<span class='danger'><b>" + this + "</b> " + this.ranged_message + " at " + A + "!</span>" );

			if ( this.rapid ) {
				Task13.Schedule( 1, (Task13.Closure)(() => {
					this.Shoot( A );
					return;
				}));
				Task13.Schedule( 4, (Task13.Closure)(() => {
					this.Shoot( A );
					return;
				}));
				Task13.Schedule( 6, (Task13.Closure)(() => {
					this.Shoot( A );
					return;
				}));
			} else {
				this.Shoot( A );
			}
			this.ranged_cooldown = this.ranged_cooldown_cap;
			return;
		}

		// Function from file: hostile.dm
		public void summon_backup( int distance = 0 ) {
			Mob_Living_SimpleAnimal_Hostile M = null;
			dynamic L = null;

			this.do_alert_animation( this );
			GlobalFuncs.playsound( this.loc, "sound/machines/chime.ogg", 50, 1, -1 );

			foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInViewExcludeThis( this.targets_from, distance ), typeof(Mob_Living_SimpleAnimal_Hostile) )) {
				M = _a;
				
				L = M.faction & this.faction;

				if ( L.len != 0 ) {
					
					if ( M.AIStatus == 3 ) {
						return;
					} else {
						M.Goto( this, M.move_to_delay, M.minimum_distance );
					}
				}
			}
			return;
		}

		// Function from file: hostile.dm
		public virtual void LoseTarget(  ) {
			this.target = null;
			Map13.Walk( this, 0, 0 );
			this.LoseAggro();
			return;
		}

		// Function from file: hostile.dm
		public virtual void LoseAggro(  ) {
			this.stop_automated_movement = false;
			this.vision_range = this.idle_vision_range;
			this.taunt_chance = Lang13.Initial( this, "taunt_chance" );
			return;
		}

		// Function from file: hostile.dm
		public virtual void Aggro(  ) {
			this.vision_range = this.aggro_vision_range;

			if ( Lang13.Bool( this.target ) && this.emote_taunt.len != 0 && Rand13.PercentChance( Convert.ToInt32( this.taunt_chance ) ) ) {
				this.emote( "me", 1, "" + Rand13.PickFromTable( this.emote_taunt ) + " at " + this.target + "." );
				this.taunt_chance = Num13.MaxInt( Convert.ToInt32( this.taunt_chance - 7 ), 2 );
			}
			return;
		}

		// Function from file: hostile.dm
		public virtual bool AttackingTarget(  ) {
			((Ent_Static)this.target).attack_animal( this );
			return false;
		}

		// Function from file: hostile.dm
		public virtual void Goto( dynamic target = null, int delay = 0, dynamic minimum_distance = null ) {
			Map13.WalkTowards( this, target, Convert.ToInt32( minimum_distance ), delay );
			return;
		}

		// Function from file: hostile.dm
		public virtual bool MoveToTarget( ByTable possible_targets = null ) {
			int target_distance = 0;

			this.stop_automated_movement = true;

			if ( !Lang13.Bool( this.target ) || !this.CanAttack( this.target ) ) {
				this.LoseTarget();
				return false;
			}

			if ( possible_targets.Contains( this.target ) ) {
				target_distance = Map13.GetDistance( this.targets_from, this.target );

				if ( this.ranged ) {
					
					if ( target_distance >= 2 && this.ranged_cooldown <= 0 ) {
						this.OpenFire( this.target );
					}
				}

				if ( !( this.Process_Spacemove() != 0 ) ) {
					Map13.Walk( this, 0, 0 );
					return true;
				}

				if ( this.retreat_distance != null ) {
					
					if ( target_distance <= Convert.ToDouble( this.retreat_distance ) ) {
						Map13.WalkAway( this, this.target, Lang13.IntNullable( this.retreat_distance ), this.move_to_delay );
					} else {
						this.Goto( this.target, this.move_to_delay, this.minimum_distance );
					}
				} else {
					this.Goto( this.target, this.move_to_delay, this.minimum_distance );
				}

				if ( Lang13.Bool( this.target ) ) {
					
					if ( this.targets_from.loc is Tile && ((Ent_Static)this.target).Adjacent( this.targets_from ) ) {
						this.AttackingTarget();
					}
					return true;
				}
				return false;
			}

			if ( this.environment_smash != 0 ) {
				
				if ( this.target.loc != null && Map13.GetDistance( this.targets_from, this.target.loc ) <= ( this.vision_range ??0) ) {
					
					if ( this.environment_smash >= 2 ) {
						this.Goto( this.target, this.move_to_delay, this.minimum_distance );
						this.FindHidden();
						return true;
					} else if ( this.FindHidden() ) {
						return true;
					}
				}
			}
			this.LoseTarget();
			return false;
		}

		// Function from file: hostile.dm
		public virtual bool GiveTarget( dynamic new_target = null ) {
			this.target = new_target;

			if ( this.target != null ) {
				this.Aggro();
				return true;
			}
			return false;
		}

		// Function from file: hostile.dm
		public dynamic PickTarget( dynamic Targets = null ) {
			dynamic pos_targ = null;
			dynamic A = null;
			int target_dist = 0;
			int possible_target_distance = 0;
			dynamic chosen_target = null;

			
			if ( this.target != null ) {
				
				foreach (dynamic _a in Lang13.Enumerate( Targets )) {
					pos_targ = _a;
					
					A = pos_targ;
					target_dist = Map13.GetDistance( this.targets_from, this.target );
					possible_target_distance = Map13.GetDistance( this.targets_from, A );

					if ( target_dist < possible_target_distance ) {
						Targets -= A;
					}
				}
			}

			if ( !( Targets.len != 0 ) ) {
				return null;
			}
			chosen_target = Rand13.PickFromTable( Targets );
			return chosen_target;
		}

		// Function from file: hostile.dm
		public virtual dynamic Found( dynamic A = null ) {
			return null;
		}

		// Function from file: hostile.dm
		public ByTable PossibleThreats(  ) {
			ByTable _default = null;

			dynamic pos_targ = null;
			dynamic A = null;

			_default = new ByTable();

			foreach (dynamic _a in Lang13.Enumerate( this.ListTargets() )) {
				pos_targ = _a;
				
				A = pos_targ;

				if ( Lang13.Bool( this.Found( A ) ) ) {
					_default = new ByTable(new object [] { A });
					break;
				}

				if ( this.CanAttack( A ) ) {
					_default.Add( A );
					continue;
				}
			}
			return _default;
		}

		// Function from file: hostile.dm
		public virtual dynamic FindTarget( ByTable possible_targets = null, bool? HasTargetsList = null ) {
			HasTargetsList = HasTargetsList ?? false;

			dynamic _default = null;

			dynamic pos_targ = null;
			dynamic A = null;
			dynamic Target = null;

			_default = new ByTable();

			if ( !( HasTargetsList == true ) ) {
				possible_targets = this.ListTargets();
			}

			foreach (dynamic _a in Lang13.Enumerate( possible_targets )) {
				pos_targ = _a;
				
				A = pos_targ;

				if ( Lang13.Bool( this.Found( A ) ) ) {
					_default = new ByTable(new object [] { A });
					break;
				}

				if ( this.CanAttack( A ) ) {
					_default += A;
					continue;
				}
			}
			Target = this.PickTarget( _default );
			this.GiveTarget( Target );
			return Target;
		}

		// Function from file: hostile.dm
		public virtual ByTable ListTargets(  ) {
			ByTable _default = null;

			ByTable Mobs = null;
			dynamic M = null;
			ByTable Objects = null;

			_default = new ByTable();

			if ( !( this.search_objects != 0 ) ) {
				Mobs = Map13.FetchHearers( this.targets_from, this.vision_range ) - this;
				_default.Add( Mobs );

				foreach (dynamic _a in Lang13.Enumerate( GlobalVars.mechas_list )) {
					M = _a;
					

					if ( Map13.GetDistance( M, this.targets_from ) <= ( this.vision_range ??0) && GlobalFuncs.can_see( this.targets_from, M, this.vision_range ) ) {
						_default.Add( M );
					}
				}
			} else {
				Objects = Map13.FetchInViewExcludeThis( this.targets_from, this.vision_range );
				_default.Add( Objects );
			}
			return _default;
		}

		// Function from file: hostile.dm
		public override bool handle_automated_action(  ) {
			ByTable possible_targets = null;

			
			if ( this.AIStatus == 3 ) {
				return false;
			}
			possible_targets = this.ListTargets();

			if ( this.environment_smash != 0 ) {
				this.EscapeConfinement();
			}

			if ( this.AICanContinue( possible_targets ) ) {
				this.DestroySurroundings();

				if ( !this.MoveToTarget( possible_targets ) ) {
					
					if ( this.AIShouldSleep( possible_targets ) ) {
						this.AIStatus = 2;
					}
				}
			}
			return true;
		}

		// Function from file: hostile.dm
		public override bool Life(  ) {
			bool _default = false;

			_default = base.Life();

			if ( this.ranged ) {
				this.ranged_cooldown--;
			}

			if ( !_default ) {
				Map13.Walk( this, 0, 0 );
				return false;
			}
			return _default;
		}

		// Function from file: other_mobs.dm
		public override void UnarmedAttack( Ent_Static A = null, bool? proximity_flag = null ) {
			this.target = A;
			this.AttackingTarget();
			return;
		}

	}

}