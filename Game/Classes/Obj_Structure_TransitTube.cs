// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Structure_TransitTube : Obj_Structure {

		public Type tube_construction = typeof(Obj_Structure_CTransitTube);
		public ByTable tube_dirs = null;
		public bool exit_delay = true;
		public int enter_delay = 0;
		public dynamic tube_dir_list = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.anchored = 1;
			this.icon = "icons/obj/atmospherics/pipes/transit_tube.dmi";
			this.icon_state = "E-W";
			this.layer = 3.1;
		}

		// Function from file: transit_tube.dm
		public Obj_Structure_TransitTube ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;

			if ( this.tube_dirs == null ) {
				this.init_dirs();
			}
			return;
		}

		// Function from file: transit_tube.dm
		public ByTable parse_dirs( string text = null ) {
			ByTable split_text = null;
			ByTable directions = null;
			dynamic text_part = null;
			int direction = 0;

			
			if ( GlobalVars.direction_table.Contains( text ) ) {
				return GlobalVars.direction_table[text];
			}
			split_text = GlobalFuncs.text2list( text, "-" );

			if ( split_text[1] == "D" ) {
				GlobalVars.direction_table[text] = new ByTable();
				return null;
			}
			directions = new ByTable();

			foreach (dynamic _a in Lang13.Enumerate( split_text )) {
				text_part = _a;
				
				direction = GlobalFuncs.text2dir_extended( text_part );

				if ( direction > 0 ) {
					directions.Add( direction );
				}
			}
			GlobalVars.direction_table[text] = directions;
			return directions;
		}

		// Function from file: transit_tube.dm
		public void create_automatic_decorative_corner( Tile location = null, dynamic direction = null ) {
			string state = null;
			Obj_Structure_TransitTube tube = null;
			Obj_Structure_TransitTube tube2 = null;

			state = "D-" + GlobalFuncs.dir2text_short( direction );

			foreach (dynamic _a in Lang13.Enumerate( location, typeof(Obj_Structure_TransitTube) )) {
				tube = _a;
				

				if ( tube.icon_state == state ) {
					return;
				}
			}
			tube2 = new Obj_Structure_TransitTube( location );
			tube2.icon_state = state;
			tube2.init_dirs();
			return;
		}

		// Function from file: transit_tube.dm
		public void generate_automatic_corners( ByTable directions = null ) {
			dynamic direction = null;

			
			foreach (dynamic _a in Lang13.Enumerate( directions )) {
				direction = _a;
				

				if ( direction == 5 || direction == 6 || direction == 9 || direction == 10 ) {
					
					if ( Lang13.Bool( direction & 1 ) ) {
						this.create_automatic_decorative_corner( Map13.GetStep( this.loc, ((int)( GlobalVars.NORTH )) ), direction ^ 3 );
					} else {
						this.create_automatic_decorative_corner( Map13.GetStep( this.loc, ((int)( GlobalVars.SOUTH )) ), direction ^ 3 );
					}

					if ( Lang13.Bool( direction & 4 ) ) {
						this.create_automatic_decorative_corner( Map13.GetStep( this.loc, ((int)( GlobalVars.EAST )) ), direction ^ 12 );
					} else {
						this.create_automatic_decorative_corner( Map13.GetStep( this.loc, ((int)( GlobalVars.WEST )) ), direction ^ 12 );
					}
				}
			}
			return;
		}

		// Function from file: transit_tube.dm
		public void select_automatic_icon_state( ByTable directions = null ) {
			
			if ( Lang13.Length( directions ) == 2 ) {
				this.icon_state = "" + GlobalFuncs.dir2text_short( directions[1] ) + "-" + GlobalFuncs.dir2text_short( directions[2] );
			}
			return;
		}

		// Function from file: transit_tube.dm
		public ByTable select_automatic_dirs( ByTable connected = null ) {
			int? i = null;
			int? j = null;
			int d1 = 0;
			dynamic d2 = null;

			
			if ( Lang13.Length( connected ) < 1 ) {
				return new ByTable();
			}
			i = null;
			i = 1;

			while (( i ??0) <= Lang13.Length( connected )) {
				j = null;
				j = ( i ??0) + 1;

				while (( j ??0) <= Lang13.Length( connected )) {
					d1 = Convert.ToInt32( connected[i] );
					d2 = connected[j];

					if ( d1 == Num13.Rotate( d2, 135 ) || d1 == Num13.Rotate( d2, 180 ) || d1 == Num13.Rotate( d2, 225 ) ) {
						return new ByTable(new object [] { d1, d2 });
					}
					j++;
				}
				i++;
			}
			return new ByTable(new object [] { connected[1], Num13.Rotate( connected[1], 180 ) });
		}

		// Function from file: transit_tube.dm
		public void init_dirs_automatic(  ) {
			ByTable connected = null;
			ByTable connected_auto = null;
			dynamic direction = null;
			Tile location = null;
			Obj_Structure_TransitTube tube = null;

			connected = new ByTable();
			connected_auto = new ByTable();

			foreach (dynamic _b in Lang13.Enumerate( GlobalVars.tube_dir_list )) {
				direction = _b;
				
				location = Map13.GetStep( this.loc, Convert.ToInt32( direction ) );

				foreach (dynamic _a in Lang13.Enumerate( location, typeof(Obj_Structure_TransitTube) )) {
					tube = _a;
					

					if ( tube.directions() == null && tube.icon_state == "auto" ) {
						connected_auto.Add( direction );
						break;
					} else if ( tube.directions().Contains( Num13.Rotate( direction, 180 ) ) ) {
						connected.Add( direction );
						break;
					}
				}
			}
			connected.Add( connected_auto );
			this.tube_dirs = this.select_automatic_dirs( connected );

			if ( Lang13.Length( this.tube_dirs ) == 2 && GlobalVars.tube_dir_list.Find( this.tube_dirs[1] ) > GlobalVars.tube_dir_list.Find( this.tube_dirs[2] ) ) {
				this.tube_dirs.Swap( 1, 2 );
			}
			this.generate_automatic_corners( this.tube_dirs );
			this.select_automatic_icon_state( this.tube_dirs );
			return;
		}

		// Function from file: transit_tube.dm
		public virtual void init_dirs(  ) {
			
			if ( this.icon_state == "auto" ) {
				Task13.Schedule( 1, (Task13.Closure)(() => {
					this.init_dirs_automatic();
					return;
				}));
			} else {
				this.tube_dirs = this.parse_dirs( this.icon_state );

				if ( String13.SubStr( this.icon_state, 1, 3 ) == "D-" || String13.Find( this.icon_state, "Pass", 1, 0 ) != 0 ) {
					this.density = false;
				}
			}
			return;
		}

		// Function from file: transit_tube.dm
		[VerbInfo( name: "enter delay" )]
		public int f_enter_delay( Obj_Structure_TransitTubePod pod = null, dynamic to_dir = null ) {
			return this.enter_delay;
		}

		// Function from file: transit_tube.dm
		[VerbInfo( name: "exit delay" )]
		public bool f_exit_delay( Obj_Structure_TransitTubePod pod = null, int to_dir = 0 ) {
			return this.exit_delay;
		}

		// Function from file: transit_tube.dm
		public dynamic get_exit( int in_dir = 0 ) {
			dynamic near_dir = null;
			int in_dir_cw = 0;
			int in_dir_ccw = 0;
			dynamic direction = null;

			near_dir = 0;
			in_dir_cw = Num13.Rotate( in_dir, -45 );
			in_dir_ccw = Num13.Rotate( in_dir, 45 );

			foreach (dynamic _a in Lang13.Enumerate( this.directions() )) {
				direction = _a;
				

				if ( direction == in_dir ) {
					return direction;
				} else if ( direction == in_dir_cw ) {
					near_dir = direction;
				} else if ( direction == in_dir_ccw ) {
					near_dir = direction;
				}
			}
			return near_dir;
		}

		// Function from file: transit_tube.dm
		public bool has_exit( int? in_dir = null ) {
			dynamic direction = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.directions() )) {
				direction = _a;
				

				if ( direction == in_dir ) {
					return true;
				}
			}
			return false;
		}

		// Function from file: transit_tube.dm
		public bool has_entrance( dynamic from_dir = null ) {
			dynamic direction = null;

			from_dir = Num13.Rotate( from_dir, 180 );

			foreach (dynamic _a in Lang13.Enumerate( this.directions() )) {
				direction = _a;
				

				if ( direction == from_dir ) {
					return true;
				}
			}
			return false;
		}

		// Function from file: transit_tube.dm
		public ByTable directions(  ) {
			return this.tube_dirs;
		}

		// Function from file: transit_tube.dm
		public virtual void pod_stopped( Obj_Structure_TransitTubePod pod = null, int from_dir = 0 ) {
			return;
		}

		// Function from file: transit_tube.dm
		public virtual bool should_stop_pod( Obj_Structure_TransitTubePod pod = null, dynamic from_dir = null ) {
			return false;
		}

		// Function from file: transit_tube.dm
		public void destroy_diagonals(  ) {
			Obj_Structure_TransitTube D = null;
			int my_dir = 0;
			bool is_connecting = false;
			Obj_Structure_TransitTube N = null;

			
			foreach (dynamic _b in Lang13.Enumerate( Map13.FetchInRangeExcludeThis( this, 1 ), typeof(Obj_Structure_TransitTube) )) {
				D = _b;
				

				if ( String13.SubStr( D.icon_state, 1, 3 ) == "D-" ) {
					my_dir = GlobalFuncs.text2dir_extended( String13.SubStr( D.icon_state, 3, 5 ) );
					is_connecting = false;

					foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInRangeExcludeThis( D, 1 ), typeof(Obj_Structure_TransitTube) )) {
						N = _a;
						

						if ( ( Map13.GetDistance( D, N ) == Num13.Rotate( my_dir, -45 ) && D.has_exit( Num13.Rotate( my_dir, 90 ) ) || Map13.GetDistance( D, N ) == Num13.Rotate( my_dir, 45 ) && D.has_exit( Num13.Rotate( my_dir, -90 ) ) ) && D != this ) {
							is_connecting = true;
							break;
						}
					}

					if ( !is_connecting ) {
						GlobalFuncs.qdel( D );
					}
				}
			}
			return;
		}

		// Function from file: transit_tube.dm
		public override dynamic attackby( dynamic A = null, dynamic user = null, string _params = null, bool? silent = null, bool? replace_spent = null ) {
			Obj_Structure_TransitTubePod pod = null;
			dynamic R = null;
			Obj_Structure_TransitTubePod pod2 = null;

			
			if ( A is Obj_Item_Weapon_Wrench ) {
				
				if ( String13.SubStr( this.icon_state, 1, 3 ) != "D-" ) {
					
					foreach (dynamic _a in Lang13.Enumerate( this.loc, typeof(Obj_Structure_TransitTubePod) )) {
						pod = _a;
						
						user.WriteMsg( "<span class='warning'>Remove the pod first!</span>" );
						return null;
					}
					((Ent_Static)user).visible_message( new Txt().item( user ).str( " starts to deattach " ).the( this ).item().str( "." ).ToString(), "<span class='notice'>You start to deattach the " + this.name + "...</span>" );
					GlobalFuncs.playsound( this.loc, "sound/items/ratchet.ogg", 50, 1 );

					if ( GlobalFuncs.do_after( user, 35 / A.toolspeed, null, this ) ) {
						user.WriteMsg( "<span class='notice'>You deattach the " + this.name + ".</span>" );
						R = Lang13.Call( this.tube_construction, this.loc );
						R.icon_state = this.icon_state;
						this.transfer_fingerprints_to( R );
						((Ent_Static)R).add_fingerprint( user );
						this.destroy_diagonals();
						GlobalFuncs.qdel( this );
					}
				}
			}

			if ( A is Obj_Item_Weapon_Crowbar ) {
				
				foreach (dynamic _b in Lang13.Enumerate( this.loc, typeof(Obj_Structure_TransitTubePod) )) {
					pod2 = _b;
					
					pod2.attackby( A, user );
				}
			}
			return null;
		}

		// Function from file: transit_tube.dm
		public override bool ex_act( double? severity = null, dynamic target = null ) {
			Ent_Static oldloc = null;
			Ent_Dynamic AM = null;

			
			if ( 3 - ( severity ??0) >= 0 ) {
				oldloc = this.loc;
				base.ex_act( ( severity ??0) + 1, (object)(target) );

				foreach (dynamic _a in Lang13.Enumerate( this.contents, typeof(Ent_Dynamic) )) {
					AM = _a;
					
					AM.loc = oldloc;
				}
			}
			return false;
		}

		// Function from file: transit_tube.dm
		public override bool CanPass( dynamic mover = null, dynamic target = null, double? height = null, bool? air_group = null ) {
			
			if ( mover is Ent_Dynamic && ((Ent_Dynamic)mover).checkpass( 2 ) != 0 ) {
				return true;
			}
			return !this.density;
		}

	}

}