// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Machinery_AmShielding : Obj_Machinery {

		public Obj_Machinery_Power_AmControlUnit control_unit = null;
		public bool processing = false;
		public double stability = 100;
		public bool efficiency = true;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.anchored = 1;
			this.use_power = 0;
			this.icon = "icons/obj/machines/antimatter.dmi";
			this.icon_state = "shield";
			this.dir = 1;
		}

		// Function from file: shielding.dm
		public Obj_Machinery_AmShielding ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			Task13.Schedule( 10, (Task13.Closure)(() => {
				this.controllerscan();
				return;
			}));
			return;
		}

		// Function from file: shielding.dm
		public override dynamic attackby( dynamic A = null, dynamic user = null, string _params = null, bool? silent = null, bool? replace_spent = null ) {
			
			if ( Convert.ToDouble( A.force ) > 10 ) {
				this.stability -= Convert.ToDouble( A.force / 2 );
				this.check_stability();
			}
			base.attackby( (object)(A), (object)(user), _params, silent, replace_spent );
			return null;
		}

		// Function from file: shielding.dm
		public override bool? update_icon( dynamic new_state = null, dynamic new_icon = null, int? new_px = null, int? new_py = null ) {
			dynamic direction = null;
			dynamic machine = null;

			this.overlays.Cut();

			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.alldirs )) {
				direction = _a;
				
				machine = Lang13.FindIn( typeof(Obj_Machinery), Map13.GetStep( this.loc, Convert.ToInt32( direction ) ) );

				if ( machine is Obj_Machinery_AmShielding && machine.control_unit == this.control_unit || machine is Obj_Machinery_Power_AmControlUnit && machine == this.control_unit ) {
					this.overlays.Add( "shield_" + direction );
				}
			}

			if ( this.core_check() ) {
				this.overlays.Add( "core" );

				if ( !this.processing ) {
					this.setup_core();
				}
			} else if ( this.processing ) {
				this.shutdown_core();
			}
			return null;
		}

		// Function from file: shielding.dm
		public override dynamic bullet_act( dynamic P = null, dynamic def_zone = null ) {
			
			if ( P.flag != "bullet" ) {
				this.stability -= Convert.ToDouble( P.force / 2 );
			}
			return 0;
		}

		// Function from file: shielding.dm
		public override bool ex_act( double? severity = null, dynamic target = null ) {
			this.stability -= 80 - ( severity ??0) * 20;
			this.check_stability();
			return false;
		}

		// Function from file: shielding.dm
		public override bool blob_act( dynamic severity = null ) {
			this.stability -= 20;

			if ( Rand13.PercentChance( ((int)( 100 - this.stability )) ) ) {
				
				if ( Rand13.PercentChance( 10 ) ) {
					new Obj_Effect_Blob_Node( this.loc, 150 );
				} else {
					new Obj_Effect_Blob( this.loc );
				}
				GlobalFuncs.qdel( this );
				return false;
			}
			this.check_stability();
			return false;
		}

		// Function from file: shielding.dm
		public override double emp_act( int severity = 0 ) {
			return 0;
		}

		// Function from file: shielding.dm
		public override int? process( dynamic seconds = null ) {
			int? _default = null;

			
			if ( !this.processing ) {
				_default = 26;
			}
			return _default;
		}

		// Function from file: shielding.dm
		public override bool CanPass( dynamic mover = null, dynamic target = null, double? height = null, bool? air_group = null ) {
			height = height ?? 0;

			
			if ( height == 0 ) {
				return true;
			}
			return false;
		}

		// Function from file: shielding.dm
		public override dynamic Destroy(  ) {
			
			if ( this.control_unit != null ) {
				this.control_unit.remove_shielding( this );
			}

			if ( this.processing ) {
				this.shutdown_core();
			}
			this.visible_message( "<span class='danger'>The " + this.name + " melts!</span>" );
			return base.Destroy();
		}

		// Function from file: shielding.dm
		public void recalc_efficiency( dynamic new_efficiency = null ) {
			
			if ( !( this.control_unit != null ) || !this.processing ) {
				return;
			}

			if ( this.stability < 50 ) {
				new_efficiency /= 2;
			}
			this.control_unit.reported_core_efficiency += Convert.ToDouble( new_efficiency - this.efficiency );
			this.efficiency = Lang13.Bool( new_efficiency );
			return;
		}

		// Function from file: shielding.dm
		public void check_stability( bool? injecting_fuel = null ) {
			injecting_fuel = injecting_fuel ?? false;

			
			if ( this.stability > 0 ) {
				return;
			}

			if ( injecting_fuel == true && this.control_unit != null ) {
				this.control_unit.exploding = true;
			}

			if ( this != null ) {
				GlobalFuncs.qdel( this );
			}
			return;
		}

		// Function from file: shielding.dm
		public void shutdown_core(  ) {
			this.processing = false;

			if ( !( this.control_unit != null ) ) {
				return;
			}
			this.control_unit.linked_cores.Remove( this );
			this.control_unit.reported_core_efficiency -= this.efficiency ?1:0;
			return;
		}

		// Function from file: shielding.dm
		public void setup_core(  ) {
			this.processing = true;
			GlobalVars.machines.Or( this );
			GlobalVars.SSmachine.processing.Or( this );

			if ( !( this.control_unit != null ) ) {
				return;
			}
			this.control_unit.linked_cores.Add( this );
			this.control_unit.reported_core_efficiency += this.efficiency ?1:0;
			return;
		}

		// Function from file: shielding.dm
		public bool core_check(  ) {
			dynamic direction = null;
			dynamic machine = null;

			
			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.alldirs )) {
				direction = _a;
				
				machine = Lang13.FindIn( typeof(Obj_Machinery), Map13.GetStep( this.loc, Convert.ToInt32( direction ) ) );

				if ( !Lang13.Bool( machine ) ) {
					return false;
				}

				if ( !( machine is Obj_Machinery_AmShielding ) && !( machine is Obj_Machinery_Power_AmControlUnit ) ) {
					return false;
				}
			}
			return true;
		}

		// Function from file: shielding.dm
		public bool link_control( Obj_Machinery_Power_AmControlUnit AMC = null ) {
			
			if ( !( AMC is Obj_Machinery_Power_AmControlUnit ) ) {
				return false;
			}

			if ( this.control_unit != null && this.control_unit != AMC ) {
				return false;
			}
			this.control_unit = AMC;
			this.control_unit.add_shielding( this, true );
			return true;
		}

		// Function from file: shielding.dm
		public void controllerscan( bool? priorscan = null ) {
			priorscan = priorscan ?? false;

			Obj_Machinery_AmShielding AMS = null;
			Obj_Machinery_AmShielding AMS2 = null;
			dynamic direction = null;
			Obj_Machinery_Power_AmControlUnit AMC = null;

			
			if ( !( this.loc is Tile ) ) {
				GlobalFuncs.qdel( this );
				return;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.loc.contents, typeof(Obj_Machinery_AmShielding) )) {
				AMS = _a;
				

				if ( AMS == this ) {
					continue;
				}
				GlobalFuncs.qdel( this );
				return;
			}

			foreach (dynamic _b in Lang13.Enumerate( GlobalFuncs.cardinalrange( this ), typeof(Obj_Machinery_AmShielding) )) {
				AMS2 = _b;
				

				if ( AMS2 != null && AMS2.control_unit != null && this.link_control( AMS2.control_unit ) ) {
					break;
				}
			}

			if ( !( this.control_unit != null ) ) {
				
				foreach (dynamic _c in Lang13.Enumerate( GlobalVars.cardinal )) {
					direction = _c;
					
				}

				foreach (dynamic _d in Lang13.Enumerate( GlobalFuncs.cardinalrange( this ), typeof(Obj_Machinery_Power_AmControlUnit) )) {
					AMC = _d;
					

					if ( AMC.add_shielding( this ) ) {
						break;
					}
				}
			}

			if ( !( this.control_unit != null ) ) {
				
				if ( !( priorscan == true ) ) {
					Task13.Schedule( 20, (Task13.Closure)(() => {
						this.controllerscan( true );
						return;
					}));
					return;
				}
				GlobalFuncs.qdel( this );
			}
			return;
		}

	}

}