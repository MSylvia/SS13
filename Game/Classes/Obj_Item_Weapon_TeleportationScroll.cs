// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Item_Weapon_TeleportationScroll : Obj_Item_Weapon {

		public int uses = 4;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.w_class = 2;
			this.item_state = "paper";
			this.throw_speed = 3;
			this.origin_tech = "bluespace=4";
			this.burn_state = 0;
			this.icon = "icons/obj/wizard.dmi";
			this.icon_state = "scroll";
		}

		public Obj_Item_Weapon_TeleportationScroll ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: scrolls.dm
		public void teleportscroll( Mob user = null ) {
			dynamic A = null;
			Base_Data thearea = null;
			EffectSystem_SmokeSpread smoke = null;
			ByTable L = null;
			dynamic T = null;
			bool clear = false;
			Obj O = null;
			ByTable tempL = null;
			dynamic attempt = null;
			bool success = false;

			A = Interface13.Input( user, "Area to jump to", "BOOYEA", A, GlobalVars.teleportlocs, InputType.Any );
			thearea = GlobalVars.teleportlocs[A];

			if ( !( user != null ) || user.stat != 0 || user.restrained() || this.uses <= 0 ) {
				return;
			}

			if ( !( user == this.loc || Map13.GetDistance( this, user ) <= 1 && this.loc is Tile ) ) {
				return;
			}
			smoke = new EffectSystem_SmokeSpread();
			smoke.set_up( 2, user.loc );
			smoke.attach( user );
			smoke.start();
			L = new ByTable();

			foreach (dynamic _b in Lang13.Enumerate( GlobalFuncs.get_area_turfs( thearea.type ) )) {
				T = _b;
				

				if ( !T.density ) {
					clear = true;

					foreach (dynamic _a in Lang13.Enumerate( T, typeof(Obj) )) {
						O = _a;
						

						if ( O.density ) {
							clear = false;
							break;
						}
					}

					if ( clear ) {
						L.Add( T );
					}
				}
			}

			if ( !( L.len != 0 ) ) {
				user.WriteMsg( "The spell matrix was unable to locate a suitable teleport destination for an unknown reason. Sorry." );
				return;
			}

			if ( user != null && user.buckled != null ) {
				user.buckled.unbuckle_mob();
			}
			tempL = L.Copy();
			attempt = null;
			success = false;

			while (tempL.len != 0) {
				attempt = Rand13.PickFromTable( tempL );
				user.Move( attempt );

				if ( GlobalFuncs.get_turf( user ) == attempt ) {
					success = true;
					break;
				} else {
					tempL.Remove( attempt );
				}
			}

			if ( !success ) {
				user.loc = Rand13.PickFromTable( L );
			}
			smoke.start();
			this.uses -= 1;
			return;
		}

		// Function from file: scrolls.dm
		public override dynamic Topic( string href = null, ByTable href_list = null, dynamic hsrc = null ) {
			Mob H = null;

			base.Topic( href, href_list, (object)(hsrc) );

			if ( Task13.User.stat != 0 || Task13.User.restrained() || this.loc != Task13.User ) {
				return null;
			}
			H = Task13.User;

			if ( !( H is Mob_Living_Carbon_Human ) ) {
				return 1;
			}

			if ( Task13.User == this.loc || Map13.GetDistance( this, Task13.User ) <= 1 && this.loc is Tile ) {
				Task13.User.set_machine( this );

				if ( Lang13.Bool( href_list["spell_teleport"] ) ) {
					
					if ( this.uses >= 1 ) {
						this.teleportscroll( H );
					}
				}
			}

			if ( H != null ) {
				this.attack_self( H );
			}
			return null;
		}

		// Function from file: scrolls.dm
		public override dynamic attack_self( dynamic user = null, dynamic flag = null, bool? emp = null ) {
			string dat = null;

			((Mob)user).set_machine( this );
			dat = "<B>Teleportation Scroll:</B><BR>";
			dat += "Number of uses: " + this.uses + "<BR>";
			dat += "<HR>";
			dat += "<B>Four uses, use them wisely:</B><BR>";
			dat += new Txt( "<A href='byond://?src=" ).Ref( this ).str( ";spell_teleport=1'>Teleport</A><BR>" ).ToString();
			dat += "Kind regards,<br>Wizards Federation<br><br>P.S. Don't forget to bring your gear, you'll need it to cast most spells.<HR>";
			Interface13.Browse( user, dat, "window=scroll" );
			GlobalFuncs.onclose( user, "scroll" );
			return null;
		}

	}

}