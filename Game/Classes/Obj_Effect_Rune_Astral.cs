// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Effect_Rune_Astral : Obj_Effect_Rune {

		public dynamic affecting = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.color = "#7e1717";
			this.cultist_name = "Astral Communion";
			this.cultist_desc = "Severs the link between one's spirit and body. This effect is taxing and one's physical body will take damage while this is active.";
			this.invocation = "Fwe'sh mah erl nyag r'ya!";
			this.icon_state = "6";
		}

		public Obj_Effect_Rune_Astral ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: runes.dm
		public override void invoke( dynamic user = null ) {
			dynamic T = null;
			Mob_Dead_Observer G = null;
			Mob_Dead_Observer G2 = null;

			
			if ( this.rune_in_use ) {
				user.WriteMsg( "<span class='cultitalic'>" + this + " cannot support more than one body!</span>" );
				this.fail_invoke();
				GlobalFuncs.log_game( "Astral Communion rune failed - more than one user" );
				return;
			}
			T = GlobalFuncs.get_turf( this );

			if ( T.contents.Contains( !Lang13.Bool( user ) ) ) {
				user.WriteMsg( "<span class='cultitalic'>You must be standing on top of " + this + "!</span>" );
				this.fail_invoke();
				GlobalFuncs.log_game( "Astral Communion rune failed - user not standing on rune" );
				return;
			}
			this.rune_in_use = true;
			this.affecting = user;
			user.color = "#7e1717";
			((Ent_Static)user).visible_message( "<span class='warning'>" + user + " freezes statue-still, glowing an unearthly red.</span>", "<span class='cult'>You see what lies beyond. All is revealed. While this is a wondrous experience, your physical form will waste away in this state. Hurry...</span>" );
			((Mob)user).ghostize( true );

			while (Lang13.Bool( user )) {
				
				if ( !Lang13.Bool( this.affecting ) ) {
					this.visible_message( "<span class='warning'>" + this + " pulses gently before falling dark.</span>" );
					this.affecting = null;
					this.rune_in_use = false;
					return;
				}
				this.affecting.apply_damage( 1, "brute" );

				if ( !T.contents.Contains( user ) ) {
					((Ent_Static)user).visible_message( "<span class='warning'>A spectral tendril wraps around " + user + " and pulls them back to the rune!</span>" );
					this.Beam( user, "drainbeam", "icons/effects/effects.dmi", 2 );
					((Ent_Dynamic)user).forceMove( GlobalFuncs.get_turf( this ) );
				}

				if ( Lang13.Bool( user.key ) ) {
					((Ent_Static)user).visible_message( "<span class='warning'>" + user + " slowly relaxes, the glow around them dimming.</span>", "<span class='danger'>You are re-united with your physical form. " + this + " releases its hold over you.</span>" );
					user.color = Lang13.Initial( user, "color" );
					((Mob)user).Weaken( 3 );
					this.rune_in_use = false;
					this.affecting = null;
					return;
				}

				if ( Lang13.Bool( user.stat ) == true ) {
					
					if ( Rand13.PercentChance( 10 ) ) {
						G = ((Mob)user).get_ghost();

						if ( G != null ) {
							G.WriteMsg( "<span class='cultitalic'>You feel the link between you and your body weakening... you must hurry!</span>" );
						}
					}
				}

				if ( Convert.ToInt32( user.stat ) == 2 ) {
					user.color = Lang13.Initial( user, "color" );
					this.rune_in_use = false;
					this.affecting = null;
					G2 = ((Mob)user).get_ghost();

					if ( G2 != null ) {
						G2.WriteMsg( "<span class='cultitalic'><b>You suddenly feel your physical form pass on. " + this + "'s exertion has killed you!</b></span>" );
					}
					return;
				}
				Task13.Sleep( 10 );
			}
			this.rune_in_use = false;
			return;
		}

		// Function from file: runes.dm
		public override double examine( dynamic user = null ) {
			base.examine( (object)(user) );

			if ( Lang13.Bool( this.affecting ) ) {
				user.WriteMsg( "<span class='cultitalic'>A translucent field encases " + user + " above the rune!</span>" );
			}
			return 0;
		}

	}

}