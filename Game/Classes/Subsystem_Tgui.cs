// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Subsystem_Tgui : Subsystem {

		public ByTable open_uis = new ByTable();
		public ByTable processing_uis = new ByTable();
		public string basehtml = null;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.name = "tgui";
			this.wait = 10;
			this.priority = 16;
			this.display = 6;
			this.can_fire = true;
		}

		// Function from file: tgui.dm
		public Subsystem_Tgui (  ) {
			this.basehtml = File13.Read( "tgui/tgui.html" );

			if ( GlobalVars.SStgui != this ) {
				
				if ( GlobalVars.SStgui is Subsystem_Tgui ) {
					this.Recover();
					GlobalFuncs.qdel( GlobalVars.SStgui );
				}
				GlobalVars.SStgui = this;
			}
			return;
		}

		// Function from file: subsystem.dm
		public bool on_transfer( dynamic source = null, dynamic target = null ) {
			Tgui ui = null;

			
			if ( !Lang13.Bool( source ) || source.open_uis == null || !( source.open_uis is ByTable ) || this.open_uis.len == 0 ) {
				return false;
			}

			if ( target.open_uis == null || !( target.open_uis is ByTable ) ) {
				target.open_uis = new ByTable();
			}

			foreach (dynamic _a in Lang13.Enumerate( source.open_uis, typeof(Tgui) )) {
				ui = _a;
				
				ui.user = target;
				target.open_uis.Add( ui );
			}
			source.open_uis.Cut();
			return true;
		}

		// Function from file: subsystem.dm
		public int on_logout( Mob user = null ) {
			return this.close_user_uis( user );
		}

		// Function from file: subsystem.dm
		public bool on_close( Tgui ui = null ) {
			string src_object_key = null;
			dynamic uis = null;

			src_object_key = new Txt().Ref( ui.src_object ).ToString();

			if ( this.open_uis[src_object_key] == null || !( this.open_uis[src_object_key] is ByTable ) ) {
				return false;
			} else if ( this.open_uis[src_object_key][ui.ui_key] == null || !( this.open_uis[src_object_key][ui.ui_key] is ByTable ) ) {
				return false;
			}
			this.processing_uis.Remove( ui );

			if ( Lang13.Bool( ui.user ) ) {
				ui.user.open_uis.Remove( ui );
			}
			uis = this.open_uis[src_object_key][ui.ui_key];
			uis.Remove( ui );
			return true;
		}

		// Function from file: subsystem.dm
		public void on_open( Tgui ui = null ) {
			string src_object_key = null;
			dynamic uis = null;

			src_object_key = new Txt().Ref( ui.src_object ).ToString();

			if ( this.open_uis[src_object_key] == null || !( this.open_uis[src_object_key] is ByTable ) ) {
				this.open_uis[src_object_key] = new ByTable().Set( ui.ui_key, new ByTable() );
			} else if ( this.open_uis[src_object_key][ui.ui_key] == null || !( this.open_uis[src_object_key][ui.ui_key] is ByTable ) ) {
				this.open_uis[src_object_key][ui.ui_key] = new ByTable();
			}
			ui.user.open_uis |= ui;
			uis = this.open_uis[src_object_key][ui.ui_key];
			uis |= ui;
			this.processing_uis.Or( ui );
			return;
		}

		// Function from file: subsystem.dm
		public int close_user_uis( Mob user = null, Obj src_object = null, string ui_key = null ) {
			int close_count = 0;
			Tgui ui = null;

			
			if ( user.open_uis == null || !( user.open_uis is ByTable ) || this.open_uis.len == 0 ) {
				return 0;
			}
			close_count = 0;

			foreach (dynamic _a in Lang13.Enumerate( user.open_uis, typeof(Tgui) )) {
				ui = _a;
				

				if ( ( src_object == null || !( src_object == null ) && ui.src_object == src_object ) && ( ui_key == null || !( ui_key == null ) && ui.ui_key == ui_key ) ) {
					ui.close();
					close_count++;
				}
			}
			return close_count;
		}

		// Function from file: subsystem.dm
		public int update_user_uis( dynamic user = null, Obj src_object = null, string ui_key = null ) {
			int update_count = 0;
			Tgui ui = null;

			
			if ( user.open_uis == null || !( user.open_uis is ByTable ) || this.open_uis.len == 0 ) {
				return 0;
			}
			update_count = 0;

			foreach (dynamic _a in Lang13.Enumerate( user.open_uis, typeof(Tgui) )) {
				ui = _a;
				

				if ( ( src_object == null || !( src_object == null ) && ui.src_object == src_object ) && ( ui_key == null || !( ui_key == null ) && ui.ui_key == ui_key ) ) {
					ui.process();
					update_count++;
				}
			}
			return update_count;
		}

		// Function from file: subsystem.dm
		public int close_uis( Obj src_object = null ) {
			string src_object_key = null;
			int close_count = 0;
			dynamic ui_key = null;
			Tgui ui = null;

			src_object_key = new Txt().Ref( src_object ).ToString();

			if ( this.open_uis[src_object_key] == null || !( this.open_uis[src_object_key] is ByTable ) ) {
				return 0;
			}
			close_count = 0;

			foreach (dynamic _b in Lang13.Enumerate( this.open_uis[src_object_key] )) {
				ui_key = _b;
				

				foreach (dynamic _a in Lang13.Enumerate( this.open_uis[src_object_key][ui_key], typeof(Tgui) )) {
					ui = _a;
					

					if ( ui != null && ui.src_object != null && Lang13.Bool( ui.user ) && ui.src_object.ui_host() != null ) {
						ui.close();
						close_count++;
					}
				}
			}
			return close_count;
		}

		// Function from file: subsystem.dm
		public int update_uis( Obj src_object = null ) {
			string src_object_key = null;
			int update_count = 0;
			dynamic ui_key = null;
			Tgui ui = null;

			src_object_key = new Txt().Ref( src_object ).ToString();

			if ( this.open_uis[src_object_key] == null || !( this.open_uis[src_object_key] is ByTable ) ) {
				return 0;
			}
			update_count = 0;

			foreach (dynamic _b in Lang13.Enumerate( this.open_uis[src_object_key] )) {
				ui_key = _b;
				

				foreach (dynamic _a in Lang13.Enumerate( this.open_uis[src_object_key][ui_key], typeof(Tgui) )) {
					ui = _a;
					

					if ( ui != null && ui.src_object != null && Lang13.Bool( ui.user ) && ui.src_object.ui_host() != null ) {
						ui.process();
						update_count++;
					}
				}
			}
			return update_count;
		}

		// Function from file: subsystem.dm
		public Tgui get_open_ui( dynamic user = null, Obj src_object = null, string ui_key = null ) {
			string src_object_key = null;
			Tgui ui = null;

			src_object_key = new Txt().Ref( src_object ).ToString();

			if ( this.open_uis[src_object_key] == null || !( this.open_uis[src_object_key] is ByTable ) ) {
				return null;
			} else if ( this.open_uis[src_object_key][ui_key] == null || !( this.open_uis[src_object_key][ui_key] is ByTable ) ) {
				return null;
			}

			foreach (dynamic _a in Lang13.Enumerate( this.open_uis[src_object_key][ui_key], typeof(Tgui) )) {
				ui = _a;
				

				if ( ui.user == user ) {
					return ui;
				}
			}
			return null;
		}

		// Function from file: subsystem.dm
		public Tgui try_update_ui( dynamic user = null, Obj src_object = null, string ui_key = null, Tgui ui = null, bool? force_open = null ) {
			force_open = force_open ?? false;
			ui = ui ?? this.get_open_ui( user, src_object, ui_key );

			ByTable data = null;

			
			if ( !( ui == null ) ) {
				data = src_object.get_ui_data( user );

				if ( !( force_open == true ) ) {
					ui.push_data( data );
				} else {
					ui.reinitialize( null, data );
				}
				return ui;
			} else {
				return null;
			}
		}

		// Function from file: tgui.dm
		public override void fire(  ) {
			dynamic thing = null;
			dynamic ui = null;

			
			foreach (dynamic _a in Lang13.Enumerate( this.processing_uis )) {
				thing = _a;
				
				ui = thing;

				if ( Lang13.Bool( ui ) && Lang13.Bool( ui.user ) && ui.src_object != null ) {
					((Game_Data)ui).process();
					continue;
				}
				this.processing_uis.Remove( ui );
			}
			return;
		}

		// Function from file: tgui.dm
		public override void stat_entry( string msg = null ) {
			base.stat_entry( "P:" + this.processing_uis.len );
			return;
		}

	}

}