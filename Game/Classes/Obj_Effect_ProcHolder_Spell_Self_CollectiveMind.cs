// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Effect_ProcHolder_Spell_Self_CollectiveMind : Obj_Effect_ProcHolder_Spell_Self {

		public bool blind_smoke_acquired = false;
		public bool screech_acquired = false;
		public bool drainLifeAcquired = false;
		public bool reviveThrallAcquired = false;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.panel = "Shadowling Abilities";
			this.charge_max = 300;
			this.human_req = 1;
			this.clothes_req = 0;
			this.action_icon_state = "collective_mind";
		}

		public Obj_Effect_ProcHolder_Spell_Self_CollectiveMind ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: shadowling_abilities.dm
		public override bool cast( dynamic targets = null, dynamic thearea = null, dynamic user = null ) {
			int thralls = 0;
			int victory_threshold = 0;
			dynamic M = null;
			dynamic CM = null;

			
			if ( !this.shadowling_check( targets ) ) {
				this.revert_cast();
				return false;
			}
			thralls = 0;
			victory_threshold = 15;
			targets.WriteMsg( "<span class='shadowling'><b>You focus your telepathic energies abound, harnessing and drawing together the strength of your thralls.</b></span>" );

			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.living_mob_list )) {
				M = _a;
				

				if ( GlobalFuncs.is_thrall( M ) ) {
					thralls++;
					M.WriteMsg( "<span class='shadowling'>You feel hooks sink into your mind and pull.</span>" );
				}
			}

			if ( !GlobalFuncs.do_after( targets, 30, null, targets ) ) {
				targets.WriteMsg( "<span class='warning'>Your concentration has been broken. The mental hooks you have sent out now retract into your mind.</span>" );
				return false;
			}

			if ( thralls >= 3 && !this.screech_acquired ) {
				this.screech_acquired = true;
				targets.WriteMsg( "<span class='shadowling'><i>The power of your thralls has granted you the <b>Sonic Screech</b> ability. This ability will shatter nearby windows and deafen enemies, plus stunning silicon lifeforms.</span>" );
				targets.mind.AddSpell( new Obj_Effect_ProcHolder_Spell_AoeTurf_UnearthlyScreech( null ) );
			}

			if ( thralls >= 5 && !this.blind_smoke_acquired ) {
				this.blind_smoke_acquired = true;
				targets.WriteMsg( "<span class='shadowling'><i>The power of your thralls has granted you the <b>Blinding Smoke</b> ability. It will create a choking cloud that will blind any non-thralls who enter. </i></span>" );
				targets.mind.AddSpell( new Obj_Effect_ProcHolder_Spell_Self_BlindnessSmoke( null ) );
			}

			if ( thralls >= 7 && !this.drainLifeAcquired ) {
				this.drainLifeAcquired = true;
				targets.WriteMsg( "<span class='shadowling'><i>The power of your thralls has granted you the <b>Drain Life</b> ability. You can now drain the health of nearby humans to heal yourself.</i></span>" );
				targets.mind.AddSpell( new Obj_Effect_ProcHolder_Spell_AoeTurf_DrainLife( null ) );
			}

			if ( thralls >= 9 && !this.reviveThrallAcquired ) {
				this.reviveThrallAcquired = true;
				targets.WriteMsg( "<span class='shadowling'><i>The power of your thralls has granted you the <b>Black Recuperation</b> ability. This will, after a short time, bring a dead thrall completely back to life with no bodily defects.</i></span>" );
				targets.mind.AddSpell( new Obj_Effect_ProcHolder_Spell_Targeted_ReviveThrall( null ) );
			}

			if ( thralls < victory_threshold ) {
				targets.WriteMsg( "<span class='shadowling'>You do not have the power to ascend. You require " + victory_threshold + " thralls, but only " + thralls + " living thralls are present.</span>" );
			} else if ( thralls >= victory_threshold ) {
				targets.WriteMsg( "<span class='shadowling'><b>You are now powerful enough to ascend. Use the Ascendance ability when you are ready. <i>This will kill all of your thralls.</i></span>" );
				targets.WriteMsg( "<span class='shadowling'><b>You may find Ascendance in the Shadowling Evolution tab.</b></span>" );

				foreach (dynamic _b in Lang13.Enumerate( GlobalVars.living_mob_list )) {
					M = _b;
					

					if ( GlobalFuncs.is_shadow( M ) ) {
						CM = null;

						if ( M.mind.spell_list.Contains( CM ) ) {
							M.mind.spell_list.Remove( CM );
							GlobalFuncs.qdel( CM );
						}
						((Mind)M.mind).remove_spell( typeof(Obj_Effect_ProcHolder_Spell_Self_ShadowlingHatch) );
						M.mind.AddSpell( new Obj_Effect_ProcHolder_Spell_Self_ShadowlingAscend( null ) );

						if ( M == targets ) {
							M.WriteMsg( "<span class='shadowling'><i>You project this power to the rest of the shadowlings.</i></span>" );
						} else {
							M.WriteMsg( "<span class='shadowling'><b>" + targets.real_name + " has coalesced the strength of the thralls. You can draw upon it at any time to ascend. (Shadowling Evolution Tab)</b></span>" );
						}
					}
				}
			}
			return false;
		}

	}

}