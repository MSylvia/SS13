// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Mob_Living_SimpleAnimal_Bot_Secbot : Mob_Living_SimpleAnimal_Bot {

		public dynamic target = null;
		public string oldtarget_name = null;
		public int threatlevel = 0;
		public Ent_Static target_lastloc = null;
		public int last_found = 0;
		public bool declare_arrests = true;
		public bool idcheck = false;
		public bool weaponscheck = false;
		public bool check_records = true;
		public bool arrest_type = false;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.health = 25;
			this.maxHealth = 25;
			this.damage_coeff = new ByTable().Set( "brute", 0.5 ).Set( "fire", 061 ).Set( "tox", 0 ).Set( "clone", 0 ).Set( "stamina", 0 ).Set( "oxy", 0 );
			this.pass_flags = 16;
			this.radio_key = typeof(Obj_Item_Device_Encryptionkey_HeadsetSec);
			this.radio_channel = "Security";
			this.bot_type = 1;
			this.model = "Securitron";
			this.bot_core_type = typeof(Obj_Machinery_BotCore_Secbot);
			this.window_id = "autosec";
			this.window_name = "Automatic Security Unit v1.6";
			this.icon_state = "secbot0";
			this.layer = 5;
		}

		// Function from file: secbot.dm
		public Mob_Living_SimpleAnimal_Bot_Secbot ( dynamic loc = null ) : base( (object)(loc) ) {
			Job_Detective J = null;
			AtomHud secsensor = null;

			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			this.icon_state = "secbot" + this.on;
			Task13.Schedule( 3, (Task13.Closure)(() => {
				J = new Job_Detective();
				this.access_card.access += J.get_access();
				this.prev_access = this.access_card.access;
				return;
			}));
			secsensor = GlobalVars.huds[2];
			secsensor.add_hud_to( this );
			return;
		}

		// Function from file: secbot.dm
		public override dynamic Crossed( Ent_Dynamic O = null, dynamic X = null ) {
			Ent_Dynamic C = null;

			
			if ( O is Mob && Lang13.Bool( this.target ) ) {
				C = O;

				if ( !( C is Mob_Living_Carbon ) || !( C != null ) || Map13.GetDistance( this, this.target ) <= 1 ) {
					return null;
				}
				C.visible_message( "<span class='warning'>" + Rand13.Pick(new object [] { "" + C + " dives out of " + this + "'s way!", "" + C + " stumbles over " + this + "!", "" + C + " jumps out of " + this + "'s path!", "" + C + " trips over " + this + " and falls!", "" + C + " topples over " + this + "!", "" + C + " leaps out of " + this + "'s way!" }) + "</span>" );
				((dynamic)C).Weaken( 2 );
				return null;
			}
			base.Crossed( O, (object)(X) );
			return null;
		}

		// Function from file: secbot.dm
		public override bool attack_alien( dynamic user = null ) {
			base.attack_alien( (object)(user) );

			if ( !( this.target is Mob_Living_Carbon_Alien ) ) {
				this.target = user;
				this.v_mode = 1;
			}
			return false;
		}

		// Function from file: secbot.dm
		public override void explode(  ) {
			dynamic Tsec = null;
			Obj_Item_Weapon_SecbotAssembly Sa = null;
			EffectSystem_SparkSpread s = null;

			Map13.WalkTowards( this, 0, 0, 0 );
			this.visible_message( "<span class='boldannounce'>" + this + " blows apart!</span>" );
			Tsec = GlobalFuncs.get_turf( this );
			Sa = new Obj_Item_Weapon_SecbotAssembly( Tsec );
			Sa.build_step = 1;
			Sa.overlays.Add( "hs_hole" );
			Sa.created_name = this.name;
			new Obj_Item_Device_Assembly_ProxSensor( Tsec );
			new Obj_Item_Weapon_Melee_Baton( Tsec );

			if ( Rand13.PercentChance( 50 ) ) {
				new Obj_Item_RobotParts_LArm( Tsec );
			}
			s = new EffectSystem_SparkSpread();
			s.set_up( 3, 1, this );
			s.start();
			new Obj_Effect_Decal_Cleanable_Oil( this.loc );
			base.explode();
			return;
		}

		// Function from file: secbot.dm
		public override bool handle_automated_action(  ) {
			int olddist = 0;

			
			if ( !base.handle_automated_action() ) {
				return false;
			}

			switch ((int)( this.v_mode )) {
				case 0:
					Map13.WalkTowards( this, 0, 0, 0 );
					this.look_for_perp();

					if ( !( this.v_mode != 0 ) && this.auto_patrol ) {
						this.v_mode = 4;
					}
					break;
				case 1:
					
					if ( this.frustration >= 8 ) {
						Map13.WalkTowards( this, 0, 0, 0 );
						this.back_to_idle();
						return false;
					}

					if ( Lang13.Bool( this.target ) ) {
						
						if ( this.Adjacent( this.target ) && this.target.loc is Tile ) {
							this.stun_attack( this.target );
							this.v_mode = 2;
							this.anchored = 1;
							this.target_lastloc = this.target.loc;
							return false;
						} else {
							olddist = Map13.GetDistance( this, this.target );
							Map13.WalkTowards( this, this.target, 1, 4 );

							if ( Map13.GetDistance( this, this.target ) >= olddist ) {
								this.frustration++;
							} else {
								this.frustration = 0;
							}
						}
					} else {
						this.back_to_idle();
					}
					break;
				case 2:
					
					if ( !this.Adjacent( this.target ) || !( this.target.loc is Tile ) || this.target.weakened < 2 ) {
						this.back_to_hunt();
						return false;
					}

					if ( this.target is Mob_Living_Carbon && ((Mob_Living_Carbon)this.target).canBeHandcuffed() ) {
						
						if ( !this.arrest_type ) {
							
							if ( !Lang13.Bool( this.target.handcuffed ) ) {
								this.cuff( this.target );
							} else {
								this.back_to_idle();
								return false;
							}
						}
					} else {
						this.back_to_idle();
						return false;
					}
					break;
				case 3:
					
					if ( !Lang13.Bool( this.target ) ) {
						this.anchored = 0;
						this.v_mode = 0;
						this.last_found = Game13.time;
						this.frustration = 0;
						return false;
					}

					if ( Lang13.Bool( this.target.handcuffed ) ) {
						this.back_to_idle();
						return false;
					}

					if ( !this.Adjacent( this.target ) || !( this.target.loc is Tile ) || this.target.loc != this.target_lastloc && this.target.weakened < 2 ) {
						this.back_to_hunt();
						return false;
					} else {
						this.v_mode = 2;
						this.anchored = 0;
					}
					break;
				case 4:
					this.look_for_perp();
					this.start_patrol();
					break;
				case 5:
					this.look_for_perp();
					this.bot_patrol();
					break;
			}
			return false;
		}

		// Function from file: secbot.dm
		public override void UnarmedAttack( dynamic A = null, bool? proximity_flag = null ) {
			dynamic C = null;

			
			if ( !this.on ) {
				return;
			}

			if ( A is Mob_Living_Carbon ) {
				C = A;

				if ( !( C.stunned != 0 ) || this.arrest_type ) {
					this.stun_attack( A );
				} else if ( ((Mob_Living_Carbon)C).canBeHandcuffed() && !Lang13.Bool( C.handcuffed ) ) {
					this.cuff( A );
				}
			} else {
				base.UnarmedAttack( (object)(A), proximity_flag );
			}
			return;
		}

		// Function from file: secbot.dm
		public override dynamic bullet_act( dynamic P = null, dynamic def_zone = null ) {
			
			if ( P is Obj_Item_Projectile_Beam || P is Obj_Item_Projectile_Bullet ) {
				
				if ( P.damage_type == "fire" || P.damage_type == "brute" ) {
					
					if ( !P.nodamage && Convert.ToDouble( P.damage ) < Convert.ToDouble( this.health ) ) {
						this.retaliate( P.firer );
					}
				}
			}
			base.bullet_act( (object)(P), (object)(def_zone) );
			return null;
		}

		// Function from file: secbot.dm
		public override void Emag( dynamic user = null ) {
			base.Emag( (object)(user) );

			if ( this.emagged == 2 ) {
				
				if ( Lang13.Bool( user ) ) {
					user.WriteMsg( "<span class='danger'>You short out " + this + "'s target assessment circuits.</span>" );
					this.oldtarget_name = user.name;
				}
				this.audible_message( "<span class='danger'>" + this + " buzzes oddly!</span>" );
				this.declare_arrests = false;
				this.icon_state = "secbot" + this.on;
			}
			return;
		}

		// Function from file: secbot.dm
		public override dynamic attackby( dynamic A = null, dynamic user = null, string _params = null, bool? silent = null, bool? replace_spent = null ) {
			base.attackby( (object)(A), (object)(user), _params, silent, replace_spent );

			if ( A is Obj_Item_Weapon_Weldingtool && user.a_intent != "harm" ) {
				return null;
			}

			if ( !( A is Obj_Item_Weapon_Screwdriver ) && Lang13.Bool( A.force ) && !Lang13.Bool( this.target ) && A.damtype != "stamina" ) {
				this.retaliate( user );
			}
			return null;
		}

		// Function from file: secbot.dm
		public override dynamic attack_hand( dynamic a = null, bool? b = null, bool? c = null ) {
			
			if ( a.a_intent == "harm" ) {
				this.retaliate( a );
			}
			return base.attack_hand( (object)(a), b, c );
		}

		// Function from file: secbot.dm
		public bool check_for_weapons( Obj_Item slot_item = null ) {
			
			if ( slot_item != null && slot_item.needs_permit ) {
				return true;
			}
			return false;
		}

		// Function from file: secbot.dm
		public void look_for_perp(  ) {
			Mob_Living_Carbon C = null;

			this.anchored = 0;

			foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInView( this, 7 ), typeof(Mob_Living_Carbon) )) {
				C = _a;
				

				if ( C.stat != 0 || Lang13.Bool( C.handcuffed ) ) {
					continue;
				}

				if ( C.name == this.oldtarget_name && Game13.time < this.last_found + 100 ) {
					continue;
				}
				this.threatlevel = C.assess_threat( this );

				if ( !( this.threatlevel != 0 ) ) {
					continue;
				} else if ( this.threatlevel >= 4 ) {
					this.target = C;
					this.oldtarget_name = C.name;
					this.f_speak( "Level " + this.threatlevel + " infraction alert!" );
					GlobalFuncs.playsound( this.loc, Rand13.Pick(new object [] { "sound/voice/bcriminal.ogg", "sound/voice/bjustice.ogg", "sound/voice/bfreeze.ogg" }), 50, 0 );
					this.visible_message( "<b>" + this + "</b> points at " + C.name + "!" );
					this.v_mode = 1;
					Task13.Schedule( 0, (Task13.Closure)(() => {
						this.handle_automated_action();
						return;
					}));
					break;
				} else {
					continue;
				}
			}
			return;
		}

		// Function from file: secbot.dm
		public void back_to_hunt(  ) {
			this.anchored = 0;
			this.frustration = 0;
			this.v_mode = 1;
			Task13.Schedule( 0, (Task13.Closure)(() => {
				this.handle_automated_action();
				return;
			}));
			return;
		}

		// Function from file: secbot.dm
		public void back_to_idle(  ) {
			this.anchored = 0;
			this.v_mode = 0;
			this.target = null;
			this.last_found = Game13.time;
			this.frustration = 0;
			Task13.Schedule( 0, (Task13.Closure)(() => {
				this.handle_automated_action();
				return;
			}));
			return;
		}

		// Function from file: secbot.dm
		public void stun_attack( dynamic C = null ) {
			dynamic threat = null;
			dynamic H = null;
			dynamic location = null;

			GlobalFuncs.playsound( this.loc, "sound/weapons/Egloves.ogg", 50, 1, -1 );
			this.icon_state = "secbot-c";
			Task13.Schedule( 2, (Task13.Closure)(() => {
				this.icon_state = "secbot" + this.on;
				return;
			}));
			threat = 5;

			if ( C is Mob_Living_Carbon_Human ) {
				C.stuttering = 5;
				((Mob)C).Stun( 5 );
				((Mob)C).Weaken( 5 );
				H = C;
				threat = ((Mob)H).assess_threat( this );
			} else {
				((Mob)C).Weaken( 5 );
				C.stuttering = 5;
				((Mob)C).Stun( 5 );
			}
			GlobalFuncs.add_logs( this, C, "stunned" );

			if ( this.declare_arrests ) {
				location = GlobalFuncs.get_area( this );
				this.f_speak( "" + ( this.arrest_type ? "Detaining" : "Arresting" ) + " level " + threat + " scumbag <b>" + C + "</b> in " + location + ".", this.radio_channel );
			}
			((Ent_Static)C).visible_message( "<span class='danger'>" + this + " has stunned " + C + "!</span>", "<span class='userdanger'>" + this + " has stunned you!</span>" );
			return;
		}

		// Function from file: secbot.dm
		public void cuff( dynamic C = null ) {
			this.v_mode = 3;
			GlobalFuncs.playsound( this.loc, "sound/weapons/cablecuff.ogg", 30, 1, -2 );
			((Ent_Static)C).visible_message( "<span class='danger'>" + this + " is trying to put zipties on " + C + "!</span>", "<span class='userdanger'>" + this + " is trying to put zipties on you!</span>" );
			Task13.Schedule( 60, (Task13.Closure)(() => {
				
				if ( !this.Adjacent( C ) || !( C.loc is Tile ) ) {
					return;
				}

				if ( !Lang13.Bool( C.handcuffed ) ) {
					C.handcuffed = new Obj_Item_Weapon_Restraints_Handcuffs_Cable_Zipties_Used( C );
					((Mob)C).update_inv_handcuffed(  );
					GlobalFuncs.playsound( this.loc, Rand13.Pick(new object [] { "sound/voice/bgod.ogg", "sound/voice/biamthelaw.ogg", "sound/voice/bsecureday.ogg", "sound/voice/bradio.ogg", "sound/voice/binsult.ogg", "sound/voice/bcreep.ogg" }), 50, 0 );
					this.back_to_idle();
				}
				return;
			}));
			return;
		}

		// Function from file: secbot.dm
		public void retaliate( dynamic H = null ) {
			this.threatlevel = ((Mob)H).assess_threat( this );
			this.threatlevel += 6;

			if ( this.threatlevel >= 4 ) {
				this.target = H;
				this.v_mode = 1;
			}
			return;
		}

		// Function from file: secbot.dm
		public override dynamic Topic( string href = null, ByTable href_list = null, dynamic hsrc = null ) {
			
			if ( Lang13.Bool( base.Topic( href, href_list, (object)(hsrc) ) ) ) {
				return 1;
			}

			dynamic _a = href_list["operation"]; // Was a switch-case, sorry for the mess.
			if ( _a=="idcheck" ) {
				this.idcheck = !this.idcheck;
				this.update_controls();
			} else if ( _a=="weaponscheck" ) {
				this.weaponscheck = !this.weaponscheck;
				this.update_controls();
			} else if ( _a=="ignorerec" ) {
				this.check_records = !this.check_records;
				this.update_controls();
			} else if ( _a=="switchmode" ) {
				this.arrest_type = !this.arrest_type;
				this.update_controls();
			} else if ( _a=="declarearrests" ) {
				this.declare_arrests = !this.declare_arrests;
				this.update_controls();
			}
			return null;
		}

		// Function from file: secbot.dm
		public override string get_controls( dynamic M = null ) {
			dynamic dat = null;

			dat += this.hack( M );
			dat += "\n<TT><B>Securitron v1.6 controls</B></TT><BR><BR>\nStatus: " + new Txt( "<A href='?src=" ).Ref( this ).str( ";power=1'>" ).item( ( this.on ? "On" : "Off" ) ).str( "</A>" ).ToString() + "<BR>\nBehaviour controls are " + ( this.locked ? "locked" : "unlocked" ) + "<BR>\nMaintenance panel panel is " + ( this.open ? "opened" : "closed" );

			if ( !this.locked || M is Mob_Living_Silicon || GlobalFuncs.IsAdminGhost( M ) ) {
				dat += "<BR>\nArrest Unidentifiable Persons: " + new Txt( "<A href='?src=" ).Ref( this ).str( ";operation=idcheck'>" ).item( ( this.idcheck ? "Yes" : "No" ) ).str( "</A>" ).ToString() + "<BR>\nArrest for Unauthorized Weapons: " + new Txt( "<A href='?src=" ).Ref( this ).str( ";operation=weaponscheck'>" ).item( ( this.weaponscheck ? "Yes" : "No" ) ).str( "</A>" ).ToString() + "<BR>\nArrest for Warrant: " + new Txt( "<A href='?src=" ).Ref( this ).str( ";operation=ignorerec'>" ).item( ( this.check_records ? "Yes" : "No" ) ).str( "</A>" ).ToString() + "<BR>\nOperating Mode: " + new Txt( "<A href='?src=" ).Ref( this ).str( ";operation=switchmode'>" ).item( ( this.arrest_type ? "Detain" : "Arrest" ) ).str( "</A>" ).ToString() + "<BR>\nReport Arrests" + new Txt( "<A href='?src=" ).Ref( this ).str( ";operation=declarearrests'>" ).item( ( this.declare_arrests ? "Yes" : "No" ) ).str( "</A>" ).ToString() + "<BR>\nAuto Patrol: " + new Txt( "<A href='?src=" ).Ref( this ).str( ";operation=patrol'>" ).item( ( this.auto_patrol ? "On" : "Off" ) ).str( "</A>" ).ToString();
			}
			return dat;
		}

		// Function from file: secbot.dm
		public override void set_custom_texts(  ) {
			this.text_hack = "You overload " + this.name + "'s target identification system.";
			this.text_dehack = "You reboot " + this.name + " and restore the target identification.";
			this.text_dehack_fail = "" + this.name + " refuses to accept your authority!";
			return;
		}

		// Function from file: secbot.dm
		public override void bot_reset(  ) {
			base.bot_reset();
			this.target = null;
			this.oldtarget_name = null;
			this.anchored = 0;
			Map13.WalkTowards( this, 0, 0, 0 );
			this.last_found = Game13.time;
			return;
		}

		// Function from file: secbot.dm
		public override void turn_off(  ) {
			base.turn_off();
			this.icon_state = "secbot" + this.on;
			return;
		}

		// Function from file: secbot.dm
		public override bool turn_on(  ) {
			base.turn_on();
			this.icon_state = "secbot" + this.on;
			return false;
		}

	}

}