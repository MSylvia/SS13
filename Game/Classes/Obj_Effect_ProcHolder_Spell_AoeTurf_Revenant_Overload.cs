// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Effect_ProcHolder_Spell_AoeTurf_Revenant_Overload : Obj_Effect_ProcHolder_Spell_AoeTurf_Revenant {

		public int shock_range = 2;
		public int shock_damage = 20;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.charge_max = 200;
			this.range = 5;
			this.stun = 30;
			this.cast_amount = 40;
			this.action_icon_state = "overload_lights";
		}

		public Obj_Effect_ProcHolder_Spell_AoeTurf_Revenant_Overload ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: revenant_abilities.dm
		public override bool cast( dynamic targets = null, dynamic thearea = null, dynamic user = null ) {
			thearea = thearea ?? Task13.User;

			dynamic T = null;
			Obj_Machinery_Light L = null;
			EffectSystem_SparkSpread s = null;
			Mob_Living_Carbon_Human M = null;
			EffectSystem_SparkSpread z = null;

			
			if ( this.attempt_cast( thearea ) ) {
				
				foreach (dynamic _c in Lang13.Enumerate( targets )) {
					T = _c;
					
					Task13.Schedule( 0, (Task13.Closure)(() => {
						
						foreach (dynamic _b in Lang13.Enumerate( T.contents, typeof(Obj_Machinery_Light) )) {
							L = _b;
							
							Task13.Schedule( 0, (Task13.Closure)(() => {
								
								if ( !L.on ) {
									return;
								}
								L.visible_message( new Txt( "<span class='warning'><b>" ).The( L ).item().str( " suddenly flares brightly and begins to spark!</span>" ).ToString() );
								s = new EffectSystem_SparkSpread();
								s.set_up( 4, 0, L );
								s.start();
								GlobalFuncs.PoolOrNew( typeof(Obj_Effect_Overlay_Temp_Revenant), L.loc );
								Task13.Sleep( 20 );

								if ( !L.on ) {
									return;
								}
								Icon13.Flick( "" + L.base_state + "2", L );

								foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInView( L, this.shock_range ), typeof(Mob_Living_Carbon_Human) )) {
									M = _a;
									

									if ( M == thearea ) {
										continue;
									}
									L.Beam( M, "purple_lightning", "icons/effects/effects.dmi", 5 );
									M.electrocute_act( this.shock_damage, "" + L.name, null, true );
									z = new EffectSystem_SparkSpread();
									z.set_up( 4, 0, M );
									z.start();
									GlobalFuncs.playsound( M, "sound/machines/defib_zap.ogg", 50, 1, -1 );
								}
								return;
							}));
						}
						return;
					}));
				}
			}
			return false;
		}

	}

}