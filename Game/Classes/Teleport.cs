// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Teleport : Game_Data {

		public Ent_Dynamic teleatom = null;
		public Ent_Static destination = null;
		public int precision = 0;
		public bool effectin = false;
		public bool effectout = false;
		public string soundin = null;
		public string soundout = null;
		public bool force_teleport = true;

		// Function from file: teleport.dm
		public bool teleport(  ) {
			
			if ( this.teleportChecks() ) {
				return this.doTeleport();
			}
			return false;
		}

		// Function from file: teleport.dm
		public bool doTeleport(  ) {
			dynamic destturf = null;
			dynamic curturf = null;
			dynamic destarea = null;
			ByTable posturfs = null;
			dynamic center = null;
			dynamic T = null;
			Ent_Dynamic L = null;

			curturf = GlobalFuncs.get_turf( this.teleatom );
			destarea = GlobalFuncs.get_area( this.destination );

			if ( this.precision != 0 ) {
				posturfs = new ByTable();
				center = GlobalFuncs.get_turf( this.destination );

				if ( !Lang13.Bool( center ) ) {
					center = this.destination;
				}

				foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInRange( center, this.precision ) )) {
					T = _a;
					
					posturfs.Add( T );
				}
				destturf = GlobalFuncs.safepick( posturfs );
			} else {
				destturf = GlobalFuncs.get_turf( this.destination );
			}

			if ( !Lang13.Bool( destturf ) || !Lang13.Bool( curturf ) ) {
				return false;
			}
			this.playSpecials( curturf, this.effectin, this.soundin );

			if ( this.force_teleport ) {
				this.teleatom.forceMove( destturf );
				this.playSpecials( destturf, this.effectout, this.soundout );
			} else if ( this.teleatom.Move( destturf ) ) {
				this.playSpecials( destturf, this.effectout, this.soundout );
			}

			if ( this.teleatom is Mob_Living ) {
				L = this.teleatom;

				if ( Lang13.Bool( ((dynamic)L).buckled ) ) {
					((Ent_Dynamic)((dynamic)L).buckled).unbuckle_mob();
				}

				if ( Lang13.Bool( L.buckled_mob ) ) {
					L.unbuckle_mob( true );
				}
			}
			((Base_Static)destarea).Entered( this.teleatom );
			return true;
		}

		// Function from file: teleport.dm
		public void playSpecials( dynamic location = null, dynamic effect = null, string sound = null ) {
			
			if ( Lang13.Bool( location ) ) {
				
				if ( Lang13.Bool( effect ) ) {
					Task13.Schedule( 0, (Task13.Closure)(() => {
						Task13.Source = null;
						((EffectSystem)effect).attach( location );
						((EffectSystem)effect).start();
						return;
					}));
				}

				if ( Lang13.Bool( sound ) ) {
					Task13.Schedule( 0, (Task13.Closure)(() => {
						Task13.Source = null;
						GlobalFuncs.playsound( location, sound, 60, 1 );
						return;
					}));
				}
			}
			return;
		}

		// Function from file: teleport.dm
		public bool teleportChecks(  ) {
			return true;
		}

		// Function from file: teleport.dm
		public bool setSounds( dynamic asoundin = null, dynamic asoundout = null ) {
			this.soundin = ( asoundin is File ? asoundin : null );
			this.soundout = ( asoundout is File ? asoundout : null );
			return true;
		}

		// Function from file: teleport.dm
		public bool setForceTeleport( dynamic afteleport = null ) {
			this.force_teleport = Lang13.Bool( afteleport );
			return true;
		}

		// Function from file: teleport.dm
		public virtual bool setEffects( dynamic aeffectin = null, dynamic aeffectout = null ) {
			this.effectin = Lang13.Bool( ( aeffectin is EffectSystem ? aeffectin : null ) );
			this.effectout = Lang13.Bool( ( aeffectout is EffectSystem ? aeffectout : null ) );
			return true;
		}

		// Function from file: teleport.dm
		public bool setTeleatom( dynamic ateleatom = null ) {
			
			if ( ateleatom is Obj_Effect && !( ateleatom is Obj_Effect_Dummy_Chameleon ) ) {
				GlobalFuncs.qdel( ateleatom );
				return false;
			}

			if ( ateleatom is Ent_Dynamic ) {
				this.teleatom = ateleatom;
				return true;
			}
			return false;
		}

		// Function from file: teleport.dm
		public bool setDestination( dynamic adestination = null ) {
			
			if ( adestination is Ent_Static ) {
				this.destination = adestination;
				return true;
			}
			return false;
		}

		// Function from file: teleport.dm
		public virtual bool setPrecision( dynamic aprecision = null ) {
			
			if ( Lang13.Bool( Lang13.IsNumber( aprecision ) ) ) {
				this.precision = Convert.ToInt32( aprecision );
				return true;
			}
			return false;
		}

		// Function from file: teleport.dm
		public bool initTeleport( dynamic ateleatom = null, dynamic adestination = null, dynamic aprecision = null, dynamic afteleport = null, dynamic aeffectin = null, dynamic aeffectout = null, dynamic asoundin = null, dynamic asoundout = null ) {
			
			if ( !this.setTeleatom( ateleatom ) ) {
				return false;
			}

			if ( !this.setDestination( adestination ) ) {
				return false;
			}

			if ( !this.setPrecision( aprecision ) ) {
				return false;
			}
			this.setEffects( aeffectin, aeffectout );
			this.setForceTeleport( afteleport );
			this.setSounds( asoundin, asoundout );
			return true;
		}

		// Function from file: teleport.dm
		public virtual bool start( dynamic ateleatom = null, dynamic adestination = null, dynamic aprecision = null, dynamic afteleport = null, dynamic aeffectin = null, dynamic aeffectout = null, dynamic asoundin = null, dynamic asoundout = null, params object[] _ ) {
			ByTable _args = new ByTable( new object[] { ateleatom, adestination, aprecision, afteleport, aeffectin, aeffectout, asoundin, asoundout } ).Extend(_);

			
			if ( _args[3] == null ) {
				_args[3] = 0;
			}

			if ( _args[4] == null ) {
				_args[4] = 1;
			}

			if ( _args[5] == null ) {
				_args[5] = null;
			}

			if ( _args[6] == null ) {
				_args[6] = null;
			}

			if ( _args[7] == null ) {
				_args[7] = null;
			}

			if ( _args[8] == null ) {
				_args[8] = null;
			}

			if ( !Lang13.Bool( _args.Apply( Lang13.BindFunc( this, "initTeleport" ) ) ) ) {
				return false;
			}
			return true;
		}

	}

}