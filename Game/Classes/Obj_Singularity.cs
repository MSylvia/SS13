// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Singularity : Obj {

		public int? current_size = 1;
		public int? allowed_size = 1;
		public bool contained = true;
		public double? energy = 100;
		public bool dissipate = true;
		public int dissipate_delay = 10;
		public int dissipate_track = 0;
		public int dissipate_strength = 1;
		public bool move_self = true;
		public int? grav_pull = 4;
		public int? consume_range = 0;
		public int event_chance = 15;
		public dynamic target = null;
		public int? last_failed_movement = 0;
		public int last_warning = 0;
		public bool consumedSupermatter = false;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.luminosity = 6;
			this.anchored = 1;
			this.unacidable = true;
			this.burn_state = -2;
			this.icon = "icons/obj/singularity.dmi";
			this.icon_state = "singularity_s1";
			this.layer = 6;
		}

		// Function from file: singularity.dm
		public Obj_Singularity ( dynamic loc = null, int? starting_energy = null, bool? temp = null ) : base( (object)(loc) ) {
			starting_energy = starting_energy ?? 50;
			temp = temp ?? false;

			Obj_Machinery_Power_SingularityBeacon singubeacon = null;

			this.admin_investigate_setup();
			this.energy = starting_energy;
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			GlobalVars.SSobj.processing.Or( this );
			GlobalVars.poi_list.Or( this );

			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.machines, typeof(Obj_Machinery_Power_SingularityBeacon) )) {
				singubeacon = _a;
				

				if ( singubeacon.active ) {
					this.target = singubeacon;
					break;
				}
			}
			return;
		}

		// Function from file: singularity.dm
		public override double singularity_act( int? current_size = null, Obj_Singularity S = null ) {
			double gain = 0;
			int dist = 0;

			gain = ( this.energy ??0) / 2;
			dist = Num13.MaxInt( ( this.current_size ??0) - 2, 1 );
			GlobalFuncs.explosion( this.loc, dist, dist * 2, dist * 4 );
			GlobalFuncs.qdel( this );
			return gain;
		}

		// Function from file: singularity.dm
		public void pulse(  ) {
			Obj_Machinery_Power_RadCollector R = null;

			
			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.rad_collectors, typeof(Obj_Machinery_Power_RadCollector) )) {
				R = _a;
				

				if ( Map13.GetDistance( R, this ) <= 15 ) {
					R.receive_pulse( this.energy );
				}
			}
			return;
		}

		// Function from file: singularity.dm
		public void emp_area(  ) {
			GlobalFuncs.empulse( this, 8, 10 );
			return;
		}

		// Function from file: singularity.dm
		public virtual void mezzer(  ) {
			Mob_Living_Carbon M = null;
			Mob_Living_Carbon H = null;
			Obj_Item_Clothing_Glasses MS = null;

			
			foreach (dynamic _a in Lang13.Enumerate( Map13.FetchViewersExcludeThis( this, 8 ), typeof(Mob_Living_Carbon) )) {
				M = _a;
				

				if ( M is Mob_Living_Carbon_Brain ) {
					continue;
				}

				if ( M.stat == 0 ) {
					
					if ( M is Mob_Living_Carbon_Human ) {
						H = M;

						if ( ((dynamic)H).glasses is Obj_Item_Clothing_Glasses_Meson ) {
							MS = ((dynamic)H).glasses;

							if ( MS.vision_flags == GlobalVars.SEE_TURFS ) {
								H.WriteMsg( "<span class='notice'>You look directly into the " + this.name + ", good thing you had your protective eyewear on!</span>" );
								return;
							}
						}
					}
				}
				M.apply_effect( 3, "stun" );
				M.visible_message( "<span class='danger'>" + M + " stares blankly at the " + this.name + "!</span>", "<span class='userdanger'>You look directly into the " + this.name + " and feel weak.</span>" );
			}
			return;
		}

		// Function from file: singularity.dm
		public void combust_mobs(  ) {
			Mob_Living_Carbon C = null;

			
			foreach (dynamic _a in Lang13.Enumerate( GlobalFuncs.ultra_range( 20, this, true ), typeof(Mob_Living_Carbon) )) {
				C = _a;
				
				C.visible_message( "<span class='warning'>" + C + "'s skin bursts into flame!</span>", "<span class='userdanger'>You feel an inner fire as your skin bursts into flames!</span>" );
				C.adjust_fire_stacks( 5 );
				C.IgniteMob();
			}
			return;
		}

		// Function from file: singularity.dm
		public void toxmob(  ) {
			int toxrange = 0;
			double radiation = 0;
			double radiationmin = 0;
			Mob_Living M = null;

			toxrange = 10;
			radiation = 15;
			radiationmin = 3;

			if ( ( this.energy ??0) > 200 ) {
				radiation += Num13.Round( ( ( this.energy ??0) - 150 ) / 10, 1 );
				radiationmin = Num13.Round( radiation / 5, 1 );
			}

			foreach (dynamic _a in Lang13.Enumerate( Map13.FetchInView( this.loc, toxrange ), typeof(Mob_Living) )) {
				M = _a;
				
				M.rad_act( Rand13.Int( ((int)( radiationmin )), ((int)( radiation )) ) );
			}
			return;
		}

		// Function from file: singularity.dm
		[VerbInfo( name: "event" )]
		public bool f_event(  ) {
			dynamic numb = null;

			numb = Rand13.Pick(new object [] { 1, 2, 3, 4, 5, 6 });

			dynamic _a = numb; // Was a switch-case, sorry for the mess.
			if ( _a==1 ) {
				this.emp_area();
			} else if ( _a==2 || _a==3 ) {
				this.toxmob();
			} else if ( _a==4 ) {
				this.mezzer();
			} else if ( _a==5 || _a==6 ) {
				
				if ( ( this.current_size ??0) < 11 ) {
					return false;
				}
				this.combust_mobs();
			} else {
				return false;
			}
			return true;
		}

		// Function from file: singularity.dm
		public bool can_move( dynamic T = null ) {
			dynamic G = null;
			dynamic S = null;

			
			if ( !Lang13.Bool( T ) ) {
				return false;
			}

			if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Machinery_Field_Containment), T ) ) || Lang13.Bool( Lang13.FindIn( typeof(Obj_Machinery_Shieldwall), T ) ) ) {
				return false;
			} else if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Machinery_Field_Generator), T ) ) ) {
				G = Lang13.FindIn( typeof(Obj_Machinery_Field_Generator), T );

				if ( Lang13.Bool( G ) && Lang13.Bool( G.active ) ) {
					return false;
				}
			} else if ( Lang13.Bool( Lang13.FindIn( typeof(Obj_Machinery_Shieldwallgen), T ) ) ) {
				S = Lang13.FindIn( typeof(Obj_Machinery_Shieldwallgen), T );

				if ( Lang13.Bool( S ) && Lang13.Bool( S.active ) ) {
					return false;
				}
			}
			return true;
		}

		// Function from file: singularity.dm
		public bool check_turfs_in( int? direction = null, int? step = null ) {
			direction = direction ?? 0;
			step = step ?? 0;

			int? steps = null;
			ByTable turfs = null;
			Ent_Static T = null;
			double i = 0;
			int dir2 = 0;
			int dir3 = 0;
			Ent_Static T2 = null;
			double j = 0;
			double k = 0;
			dynamic T3 = null;

			
			if ( !Lang13.Bool( direction ) ) {
				return false;
			}
			steps = 0;

			if ( !Lang13.Bool( step ) ) {
				
				switch ((int?)( this.current_size )) {
					case 1:
						steps = 1;
						break;
					case 3:
						steps = 3;
						break;
					case 5:
						steps = 3;
						break;
					case 7:
						steps = 4;
						break;
					case 9:
						steps = 5;
						break;
				}
			} else {
				steps = step;
			}
			turfs = new ByTable();
			T = this.loc;

			foreach (dynamic _b in Lang13.IterateRange( 1, steps )) {
				i = _b;
				
				T = Map13.GetStep( T, direction ??0 );
			}

			if ( !( T is Tile ) ) {
				return false;
			}
			turfs.Add( T );
			dir2 = 0;
			dir3 = 0;

			switch ((int?)( direction )) {
				case 1:
					dir2 = 4;
					dir3 = 8;
					break;
				case 4:
					dir2 = 1;
					dir3 = 2;
					break;
			}
			T2 = T;

			foreach (dynamic _d in Lang13.IterateRange( 1, ( steps ??0) - 1 )) {
				j = _d;
				
				T2 = Map13.GetStep( T2, dir2 );

				if ( !( T2 is Tile ) ) {
					return false;
				}
				turfs.Add( T2 );
			}

			foreach (dynamic _e in Lang13.IterateRange( 1, ( steps ??0) - 1 )) {
				k = _e;
				
				T = Map13.GetStep( T, dir3 );

				if ( !( T is Tile ) ) {
					return false;
				}
				turfs.Add( T );
			}

			foreach (dynamic _f in Lang13.Enumerate( turfs )) {
				T3 = _f;
				

				if ( T3 == null ) {
					continue;
				}

				if ( !this.can_move( T3 ) ) {
					return false;
				}
			}
			return true;
		}

		// Function from file: singularity.dm
		public bool move( bool? force_move = null ) {
			force_move = force_move ?? false;

			dynamic movement_dir = null;

			
			if ( !this.move_self ) {
				return false;
			}
			movement_dir = Rand13.PickFromTable( GlobalVars.alldirs - this.last_failed_movement );

			if ( force_move == true ) {
				movement_dir = force_move;
			}

			if ( Lang13.Bool( this.target ) && Rand13.PercentChance( 60 ) ) {
				movement_dir = Map13.GetDistance( this, this.target );
			}
			Map13.Step( this, Convert.ToInt32( movement_dir ) );
			return false;
		}

		// Function from file: singularity.dm
		public virtual bool consume( dynamic A = null ) {
			double gain = 0;

			gain = ((Ent_Static)A).singularity_act( this.current_size, this );
			this.energy += gain;

			if ( A is Obj_Machinery_Power_SupermatterShard && !this.consumedSupermatter ) {
				this.desc = "" + Lang13.Initial( this, "desc" ) + " It glows fiercely with inner fire.";
				this.name = "supermatter-charged " + Lang13.Initial( this, "name" );
				this.consumedSupermatter = true;
				this.luminosity = 10;
			}
			return false;
		}

		// Function from file: singularity.dm
		public virtual void eat(  ) {
			ByTable L = null;
			Ent_Static X = null;
			int? dist = null;
			Obj_Singularity S = null;

			L = ( ( this.grav_pull ??0) > 8 ? GlobalFuncs.ultra_range( this.grav_pull, this, true ) : Map13.FetchInRangeExcludeThis( this, this.grav_pull ) );

			foreach (dynamic _a in Lang13.Enumerate( L, typeof(Ent_Static) )) {
				X = _a;
				
				dist = Map13.GetDistance( X, this );
				S = this;

				if ( ( dist ??0) > ( this.consume_range ??0) ) {
					X.singularity_pull( S, this.current_size );
				} else if ( ( dist ??0) <= ( this.consume_range ??0) ) {
					this.consume( X );
				}
			}
			return;
		}

		// Function from file: singularity.dm
		public bool check_energy(  ) {
			
			if ( ( this.energy ??0) <= 0 ) {
				this.investigate_log( "collapsed.", "singulo" );
				GlobalFuncs.qdel( this );
				return false;
			}

			dynamic _a = this.energy; // Was a switch-case, sorry for the mess.
			if ( 1<=_a&&_a<=199 ) {
				this.allowed_size = 1;
			} else if ( 200<=_a&&_a<=499 ) {
				this.allowed_size = 3;
			} else if ( 500<=_a&&_a<=999 ) {
				this.allowed_size = 5;
			} else if ( 1000<=_a&&_a<=1999 ) {
				this.allowed_size = 7;
			} else if ( 2000<=_a&&_a<=Double.PositiveInfinity ) {
				
				if ( ( this.energy ??0) >= 3000 && this.consumedSupermatter ) {
					this.allowed_size = 11;
				} else {
					this.allowed_size = 9;
				}
			}

			if ( this.current_size != this.allowed_size ) {
				this.expand();
			}
			return true;
		}

		// Function from file: singularity.dm
		public bool expand( int? force_size = null ) {
			force_size = force_size ?? 0;

			int? temp_allowed_size = null;

			temp_allowed_size = this.allowed_size;

			if ( Lang13.Bool( force_size ) ) {
				temp_allowed_size = force_size;
			}

			if ( ( temp_allowed_size ??0) >= 11 && !this.consumedSupermatter ) {
				temp_allowed_size = 9;
			}

			switch ((int?)( temp_allowed_size )) {
				case 1:
					this.current_size = 1;
					this.icon = "icons/obj/singularity.dmi";
					this.icon_state = "singularity_s1";
					this.pixel_x = 0;
					this.pixel_y = 0;
					this.grav_pull = 4;
					this.consume_range = 0;
					this.dissipate_delay = 10;
					this.dissipate_track = 0;
					this.dissipate_strength = 1;
					break;
				case 3:
					this.current_size = 3;
					this.icon = "icons/effects/96x96.dmi";
					this.icon_state = "singularity_s3";
					this.pixel_x = -32;
					this.pixel_y = -32;
					this.grav_pull = 6;
					this.consume_range = 1;
					this.dissipate_delay = 5;
					this.dissipate_track = 0;
					this.dissipate_strength = 5;
					break;
				case 5:
					
					if ( this.check_turfs_in( 1, 2 ) && this.check_turfs_in( 2, 2 ) && this.check_turfs_in( 4, 2 ) && this.check_turfs_in( 8, 2 ) ) {
						this.current_size = 5;
						this.icon = "icons/effects/160x160.dmi";
						this.icon_state = "singularity_s5";
						this.pixel_x = -64;
						this.pixel_y = -64;
						this.grav_pull = 8;
						this.consume_range = 2;
						this.dissipate_delay = 4;
						this.dissipate_track = 0;
						this.dissipate_strength = 20;
					}
					break;
				case 7:
					
					if ( this.check_turfs_in( 1, 3 ) && this.check_turfs_in( 2, 3 ) && this.check_turfs_in( 4, 3 ) && this.check_turfs_in( 8, 3 ) ) {
						this.current_size = 7;
						this.icon = "icons/effects/224x224.dmi";
						this.icon_state = "singularity_s7";
						this.pixel_x = -96;
						this.pixel_y = -96;
						this.grav_pull = 10;
						this.consume_range = 3;
						this.dissipate_delay = 10;
						this.dissipate_track = 0;
						this.dissipate_strength = 10;
					}
					break;
				case 9:
					this.current_size = 9;
					this.icon = "icons/effects/288x288.dmi";
					this.icon_state = "singularity_s9";
					this.pixel_x = -128;
					this.pixel_y = -128;
					this.grav_pull = 10;
					this.consume_range = 4;
					this.dissipate = false;
					break;
				case 11:
					this.current_size = 11;
					this.icon = "icons/effects/352x352.dmi";
					this.icon_state = "singularity_s11";
					this.pixel_x = -160;
					this.pixel_y = -160;
					this.grav_pull = 15;
					this.consume_range = 5;
					this.dissipate = false;
					break;
			}

			if ( this.current_size == this.allowed_size ) {
				this.investigate_log( "<font color='red'>grew to size " + this.current_size + "</font>", "singulo" );
				return true;
			} else if ( ( this.current_size ??0) < ( --temp_allowed_size ??0) ) {
				this.expand( temp_allowed_size );
			} else {
				return false;
			}
			return false;
		}

		// Function from file: singularity.dm
		[VerbInfo( name: "dissipate" )]
		public void f_dissipate(  ) {
			
			if ( !this.dissipate ) {
				return;
			}

			if ( this.dissipate_track >= this.dissipate_delay ) {
				this.energy -= this.dissipate_strength;
				this.dissipate_track = 0;
			} else {
				this.dissipate_track++;
			}
			return;
		}

		// Function from file: singularity.dm
		public virtual void admin_investigate_setup(  ) {
			dynamic count = null;

			this.last_warning = Game13.time;
			count = Lang13.FindIn( typeof(Obj_Machinery_Field_Containment), GlobalFuncs.ultra_range( 30, this, true ) );

			if ( !Lang13.Bool( count ) ) {
				GlobalFuncs.message_admins( "A singulo has been created without containment fields active (" + this.x + "," + this.y + "," + this.z + ")" );
			}
			this.investigate_log( "was created. " + ( Lang13.Bool( count ) ? "" : "<font color='red'>No containment fields were active</font>" ), "singulo" );
			return;
		}

		// Function from file: singularity.dm
		public override dynamic attack_ai( dynamic user = null ) {
			return null;
		}

		// Function from file: singularity.dm
		public override int? process( dynamic seconds = null ) {
			
			if ( ( this.current_size ??0) >= 3 ) {
				this.move();
				this.pulse();

				if ( Rand13.PercentChance( this.event_chance ) ) {
					this.f_event();
				}
			}
			this.eat();
			this.f_dissipate();
			this.check_energy();
			return null;
		}

		// Function from file: singularity.dm
		public override bool Bumped( dynamic AM = null ) {
			this.consume( AM );
			return false;
		}

		// Function from file: singularity.dm
		public override dynamic Bump( Ent_Dynamic A = null, dynamic yes = null ) {
			this.consume( A );
			return null;
		}

		// Function from file: singularity.dm
		public override dynamic bullet_act( dynamic P = null, dynamic def_zone = null ) {
			return 0;
		}

		// Function from file: singularity.dm
		public override bool ex_act( double? severity = null, dynamic target = null ) {
			
			switch ((double?)( severity )) {
				case 1:
					
					if ( ( this.current_size ??0) <= 3 ) {
						this.investigate_log( "has been destroyed by a heavy explosion.", "singulo" );
						GlobalFuncs.qdel( this );
						return false;
					} else {
						this.energy -= Num13.Round( ( ( this.energy ??0) + 1 ) / 2, 1 );
					}
					break;
				case 2:
					this.energy -= Num13.Round( ( ( this.energy ??0) + 1 ) / 3, 1 );
					break;
				case 3:
					this.energy -= Num13.Round( ( ( this.energy ??0) + 1 ) / 4, 1 );
					break;
			}
			return false;
		}

		// Function from file: singularity.dm
		public override bool blob_act( dynamic severity = null ) {
			return false;
		}

		// Function from file: singularity.dm
		public override int Process_Spacemove( dynamic movement_dir = null ) {
			return 0;
		}

		// Function from file: singularity.dm
		public override dynamic attack_hand( dynamic a = null, bool? b = null, bool? c = null ) {
			this.consume( a );
			return 1;
		}

		// Function from file: singularity.dm
		public override bool Move( dynamic NewLoc = null, int? Dir = null, int step_x = 0, int step_y = 0 ) {
			
			if ( ( this.current_size ??0) >= 9 || this.check_turfs_in( Dir ) ) {
				this.last_failed_movement = 0;
				return base.Move( (object)(NewLoc), Dir, step_x, step_y );
			} else {
				this.last_failed_movement = Dir;
				return false;
			}
		}

		// Function from file: singularity.dm
		public override dynamic Destroy(  ) {
			GlobalVars.SSobj.processing.Remove( this );
			GlobalVars.poi_list.Remove( this );
			return base.Destroy();
		}

	}

}