// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Tile_Simulated : Tile {

		public int? wet = 0;
		public Image wet_overlay = null;
		public double thermite = 0;
		public bool to_be_destroyed = false;
		public bool max_fire_temperature_sustained = false;
		public ExcitedGroup excited_group = null;
		public bool excited = false;
		public bool recently_active = false;
		public GasMixture air = null;
		public int archived_cycle = 0;
		public int current_cycle = 0;
		public dynamic active_hotspot = null;
		public double temperature_archived = 0;
		public string atmos_overlay_type = "";

		protected override void __FieldInit() {
			base.__FieldInit();

			this.oxygen = 21.83659553527832;
			this.nitrogen = 82.14720153808594;
		}

		// Function from file: LINDA_turf_tile.dm
		public Tile_Simulated ( dynamic loc = null ) : base( (object)(loc) ) {
			// Warning: Super call was HERE! If anything above HERE is needed by the super call, it might break!;
			this.levelupdate();

			if ( this.smooth != 0 ) {
				GlobalFuncs.smooth_icon( this );
			}
			this.visibilityChanged();

			if ( !this.blocks_air ) {
				this.air = new GasMixture();
				this.air.oxygen = this.oxygen;
				this.air.carbon_dioxide = this.carbon_dioxide ?1:0;
				this.air.nitrogen = this.nitrogen;
				this.air.toxins = this.toxins ?1:0;
				this.air.temperature = this.temperature;
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public override dynamic remove_air( dynamic amount = null ) {
			GasMixture removed = null;

			
			if ( this.air != null ) {
				removed = null;
				removed = this.air.remove( amount );
				this.update_visuals();
				return removed;
			} else {
				return base.remove_air( (object)(amount) );
			}
		}

		// Function from file: LINDA_turf_tile.dm
		public override GasMixture return_air(  ) {
			
			if ( this.air != null ) {
				return this.air;
			} else {
				return base.return_air();
			}
		}

		// Function from file: LINDA_turf_tile.dm
		public override bool? assume_air( dynamic giver = null ) {
			GasMixture receiver = null;

			
			if ( !Lang13.Bool( giver ) ) {
				return false;
			}
			receiver = this.air;

			if ( receiver is GasMixture ) {
				this.air.merge( giver );
				this.update_visuals();
				return true;
			} else {
				return base.assume_air( (object)(giver) );
			}
		}

		// Function from file: LINDA_turf_tile.dm
		public override dynamic Destroy(  ) {
			this.visibilityChanged();

			if ( Lang13.Bool( this.active_hotspot ) ) {
				GlobalFuncs.qdel( this.active_hotspot );
			}
			return base.Destroy();
		}

		// Function from file: LINDA_fire.dm
		public override bool hotspot_expose( dynamic exposed_temperature = null, int exposed_volume = 0, bool? soh = null ) {
			GasMixture air_contents = null;
			bool igniting = false;

			air_contents = this.return_air();

			if ( !( air_contents != null ) ) {
				return false;
			}

			if ( Lang13.Bool( this.active_hotspot ) ) {
				
				if ( soh == true ) {
					
					if ( ( air_contents.toxins ??0) > 0.5 && ( air_contents.oxygen ??0) > 0.5 ) {
						
						if ( Convert.ToDouble( this.active_hotspot.temperature ) < Convert.ToDouble( exposed_temperature ) ) {
							this.active_hotspot.temperature = exposed_temperature;
						}

						if ( Convert.ToDouble( this.active_hotspot.volume ) < exposed_volume ) {
							this.active_hotspot.volume = exposed_volume;
						}
					}
				}
				return true;
			}
			igniting = false;

			if ( Convert.ToDouble( exposed_temperature ) > 373.41 && ( air_contents.toxins ??0) > 0.5 ) {
				igniting = true;
			}

			if ( igniting ) {
				
				if ( ( air_contents.oxygen ??0) < 0.5 || ( air_contents.toxins ??0) < 0.5 ) {
					return false;
				}
				this.active_hotspot = GlobalFuncs.PoolOrNew( typeof(Obj_Effect_Hotspot), this );
				this.active_hotspot.temperature = exposed_temperature;
				this.active_hotspot.volume = exposed_volume;
				this.active_hotspot.just_spawned = this.current_cycle < GlobalVars.SSair.times_fired;
				GlobalVars.SSair.add_to_active( this, false );
			}
			return igniting;
		}

		// Function from file: simulated.dm
		public override dynamic ChangeTurf( dynamic path = null ) {
			dynamic _default = null;

			_default = base.ChangeTurf( (object)(path) );
			GlobalFuncs.smooth_icon_neighbors( this );
			return _default;
		}

		// Function from file: simulated.dm
		public override dynamic Entered( Ent_Dynamic Obj = null, Ent_Static oldloc = null ) {
			Ent_Dynamic M = null;

			base.Entered( Obj, oldloc );

			if ( Obj is Mob_Living_Carbon ) {
				M = Obj;

				switch ((int?)( this.wet )) {
					case 1:
						
						if ( !Lang13.Bool( ((dynamic)M).slip( 3, 1, null, GlobalVars.NO_SLIP_WHEN_WALKING ) ) ) {
							M.inertia_dir = 0;
						}
						return null;
						break;
					case 2:
						((dynamic)M).slip( 0, 7, null, 6 );
						return null;
						break;
					case 3:
						((dynamic)M).slip( 0, 4, null, 3 );
						return null;
						break;
				}
			}
			return null;
		}

		// Function from file: LINDA_turf_tile.dm
		public void radiate_to_spess(  ) {
			double delta_temperature = 0;
			double heat = 0;

			
			if ( this.temperature > 273.41 ) {
				delta_temperature = this.temperature_archived - 2.7;

				if ( this.heat_capacity > 0 && Math.Abs( delta_temperature ) > 0.5 ) {
					heat = this.thermal_conductivity * delta_temperature * ( this.heat_capacity * 700000 / ( this.heat_capacity + 700000 ) );
					this.temperature -= heat / this.heat_capacity;
				}
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public bool consider_superconductivity( bool? starting = null ) {
			
			if ( !( this.thermal_conductivity != 0 ) ) {
				return false;
			}

			if ( this.air != null ) {
				
				if ( Convert.ToDouble( this.air.temperature ) < ( starting == true ? 493.41 : 303.41 ) ) {
					return false;
				}

				if ( this.air.heat_capacity() < 0.5199189782142639 ) {
					return false;
				}
			} else if ( this.temperature < ( starting == true ? 493.41 : 303.41 ) ) {
				return false;
			}
			GlobalVars.SSair.active_super_conductivity.Or( this );
			return true;
		}

		// Function from file: LINDA_turf_tile.dm
		public bool super_conduct(  ) {
			double conductivity_directions = 0;
			dynamic direction = null;
			dynamic direction2 = null;
			Tile neighbor = null;
			Tile T = null;

			conductivity_directions = 0;

			if ( this.blocks_air ) {
				conductivity_directions = 15;

				if ( this.archived_cycle < GlobalVars.SSair.times_fired ) {
					this.archive();
				}
			} else {
				
				foreach (dynamic _a in Lang13.Enumerate( GlobalVars.cardinal )) {
					direction = _a;
					

					if ( !( ( this.atmos_adjacent_turfs & Convert.ToInt32( direction ) ) != 0 ) && !( ( this.atmos_supeconductivity & Convert.ToInt32( direction ) ) != 0 ) ) {
						conductivity_directions += Convert.ToDouble( direction );
					}
				}
			}

			if ( conductivity_directions > 0 ) {
				
				foreach (dynamic _b in Lang13.Enumerate( GlobalVars.cardinal )) {
					direction2 = _b;
					

					if ( ( ((int)( conductivity_directions )) & Convert.ToInt32( direction2 ) ) != 0 ) {
						neighbor = Map13.GetStep( this, Convert.ToInt32( direction2 ) );

						if ( !( neighbor.thermal_conductivity != 0 ) ) {
							continue;
						}

						if ( neighbor is Tile_Simulated ) {
							T = neighbor;

							if ( Convert.ToDouble( ((dynamic)T).archived_cycle ) < GlobalVars.SSair.times_fired ) {
								((dynamic)T).archive();
							}

							if ( Lang13.Bool( ((dynamic)T).air ) ) {
								
								if ( this.air != null ) {
									this.air.temperature_share( ((dynamic)T).air, 0.1 );
								} else {
									((GasMixture)((dynamic)T).air).temperature_turf_share( this, T.thermal_conductivity );
								}
								GlobalVars.SSair.add_to_active( T, false );
							} else {
								
								if ( this.air != null ) {
									this.air.temperature_turf_share( T, T.thermal_conductivity );
								} else {
									this.share_temperature_mutual_solid( T, T.thermal_conductivity );
								}
								T.temperature_expose( null, T.temperature, null );
							}
							((Tile_Simulated)T).consider_superconductivity();
						} else if ( this.air != null ) {
							this.air.temperature_mimic( neighbor, neighbor.thermal_conductivity );
						} else {
							this.mimic_temperature_solid( neighbor, neighbor.thermal_conductivity );
						}
					}
				}
			}
			this.radiate_to_spess();

			if ( this.air != null ) {
				this.air.temperature_turf_share( this, this.thermal_conductivity );

				if ( Convert.ToDouble( this.air.temperature ) < 303.41 ) {
					GlobalVars.SSair.active_super_conductivity.Remove( this );
					return false;
				}
			} else if ( this.temperature < 303.41 ) {
				GlobalVars.SSair.active_super_conductivity.Remove( this );
				return false;
			}
			return false;
		}

		// Function from file: LINDA_turf_tile.dm
		public void last_share_check(  ) {
			
			if ( this.air.last_share > 0.5199189782142639 ) {
				this.excited_group.reset_cooldowns();
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void share_air( Tile T = null ) {
			dynamic difference = null;

			
			if ( Convert.ToDouble( ((dynamic)T).current_cycle ) < this.current_cycle ) {
				difference = this.air.share( ((dynamic)T).air, this.atmos_adjacent_turfs_amount );

				if ( Lang13.Bool( difference ) ) {
					
					if ( Convert.ToDouble( difference ) > 0 ) {
						this.consider_pressure_difference( T, difference );
					} else {
						T.consider_pressure_difference( this, difference );
					}
				}
				this.last_share_check();
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public string tile_graphic(  ) {
			dynamic sleeping_agent = null;

			
			if ( ( this.air.toxins ??0) > 0.5 ) {
				return "plasma";
			}
			sleeping_agent = Lang13.FindIn( typeof(Gas_SleepingAgent), this.air.trace_gases );

			if ( Lang13.Bool( sleeping_agent ) && ( sleeping_agent.moles ??0) > 1 ) {
				return "sleeping_agent";
			}
			return null;
		}

		// Function from file: LINDA_turf_tile.dm
		public Obj_Effect_Overlay get_atmos_overlay_by_name( string name = null ) {
			
			switch ((string)( name )) {
				case "plasma":
					return GlobalVars.SSair.plasma_overlay;
					break;
				case "sleeping_agent":
					return GlobalVars.SSair.sleeptoxin_overlay;
					break;
			}
			return null;
		}

		// Function from file: LINDA_turf_tile.dm
		public void update_visuals(  ) {
			string new_overlay_type = null;
			Obj_Effect_Overlay atmos_overlay = null;

			new_overlay_type = this.tile_graphic();

			if ( new_overlay_type == this.atmos_overlay_type ) {
				return;
			}
			atmos_overlay = this.get_atmos_overlay_by_name( this.atmos_overlay_type );

			if ( atmos_overlay != null ) {
				this.overlays.Remove( atmos_overlay );
			}
			atmos_overlay = this.get_atmos_overlay_by_name( new_overlay_type );

			if ( atmos_overlay != null ) {
				this.overlays.Add( atmos_overlay );
			}
			this.atmos_overlay_type = new_overlay_type;
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void archive(  ) {
			
			if ( this.air != null ) {
				this.air.archive();
			}
			this.temperature_archived = this.temperature;
			this.archived_cycle = GlobalVars.SSair.times_fired;
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void process_cell(  ) {
			bool remove = false;
			dynamic direction = null;
			Tile enemy_tile = null;
			Tile enemy_simulated = null;
			ExcitedGroup EG = null;
			ExcitedGroup EG2 = null;
			dynamic difference = null;
			Ent_Dynamic item = null;

			
			if ( this.archived_cycle < GlobalVars.SSair.times_fired ) {
				this.archive();
			}
			this.current_cycle = GlobalVars.SSair.times_fired;
			remove = true;

			foreach (dynamic _a in Lang13.Enumerate( GlobalVars.cardinal )) {
				direction = _a;
				

				if ( !( ( this.atmos_adjacent_turfs & Convert.ToInt32( direction ) ) != 0 ) ) {
					continue;
				}
				enemy_tile = Map13.GetStep( this, Convert.ToInt32( direction ) );

				if ( enemy_tile is Tile_Simulated ) {
					enemy_simulated = enemy_tile;

					if ( this.current_cycle > Convert.ToDouble( ((dynamic)enemy_simulated).current_cycle ) ) {
						((Tile_Simulated)enemy_simulated).archive();
					}

					if ( Lang13.Bool( ((dynamic)enemy_simulated).excited ) ) {
						
						if ( this.excited_group != null ) {
							
							if ( Lang13.Bool( ((dynamic)enemy_simulated).excited_group ) ) {
								
								if ( this.excited_group != ((dynamic)enemy_simulated).excited_group ) {
									this.excited_group.merge_groups( ((dynamic)enemy_simulated).excited_group );
								}
								this.share_air( enemy_simulated );
							} else if ( this.recently_active && Lang13.Bool( ((dynamic)enemy_simulated).recently_active ) == true || !this.air.compare( ((dynamic)enemy_simulated).air ) ) {
								this.excited_group.add_turf( enemy_simulated );
								this.share_air( enemy_simulated );
							}
						} else if ( Lang13.Bool( ((dynamic)enemy_simulated).excited_group ) ) {
							
							if ( this.recently_active && Lang13.Bool( ((dynamic)enemy_simulated).recently_active ) == true || !this.air.compare( ((dynamic)enemy_simulated).air ) ) {
								((ExcitedGroup)((dynamic)enemy_simulated).excited_group).add_turf( this );
								this.share_air( enemy_simulated );
							}
						} else if ( this.recently_active && Lang13.Bool( ((dynamic)enemy_simulated).recently_active ) == true || !this.air.compare( ((dynamic)enemy_simulated).air ) ) {
							EG = new ExcitedGroup();
							EG.add_turf( this );
							EG.add_turf( enemy_simulated );
							this.share_air( enemy_simulated );
						}
					} else if ( !this.air.compare( ((dynamic)enemy_simulated).air ) ) {
						GlobalVars.SSair.add_to_active( enemy_simulated );

						if ( this.excited_group != null ) {
							this.excited_group.add_turf( enemy_simulated );
						} else {
							EG2 = new ExcitedGroup();
							EG2.add_turf( this );
							EG2.add_turf( enemy_simulated );
						}
						this.share_air( enemy_simulated );
					}
				} else if ( !this.air.check_turf( enemy_tile, this.atmos_adjacent_turfs_amount ) ) {
					difference = this.air.mimic( enemy_tile, this.atmos_adjacent_turfs_amount );

					if ( Lang13.Bool( difference ) ) {
						
						if ( Convert.ToDouble( difference ) > 0 ) {
							this.consider_pressure_difference( enemy_tile, difference );
						} else {
							enemy_tile.consider_pressure_difference( this, difference );
						}
					}
					remove = false;

					if ( this.excited_group != null ) {
						this.last_share_check();
					}
				}
			}
			this.air.react();
			this.update_visuals();

			if ( Convert.ToDouble( this.air.temperature ) > 373.41 ) {
				this.hotspot_expose( this.air.temperature, 2500 );

				foreach (dynamic _b in Lang13.Enumerate( this, typeof(Ent_Dynamic) )) {
					item = _b;
					
					item.temperature_expose( this.air, this.air.temperature, 2500 );
				}
				this.temperature_expose( this.air, this.air.temperature, 2500 );

				if ( Convert.ToDouble( this.air.temperature ) > 493.41 ) {
					
					if ( this.consider_superconductivity( true ) ) {
						remove = false;
					}
				}
			}

			if ( !( this.excited_group != null ) && remove ) {
				GlobalVars.SSair.remove_from_active( this );
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void share_temperature_mutual_solid( Tile sharer = null, double conduction_coefficient = 0 ) {
			double delta_temperature = 0;
			double heat = 0;

			delta_temperature = this.temperature_archived - Convert.ToDouble( ((dynamic)sharer).temperature_archived );

			if ( Math.Abs( delta_temperature ) > 0.5 && this.heat_capacity != 0 && sharer.heat_capacity != 0 ) {
				heat = conduction_coefficient * delta_temperature * ( this.heat_capacity * sharer.heat_capacity / ( this.heat_capacity + sharer.heat_capacity ) );
				this.temperature -= heat / this.heat_capacity;
				sharer.temperature += heat / sharer.heat_capacity;
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void mimic_temperature_solid( Tile model = null, double conduction_coefficient = 0 ) {
			double delta_temperature = 0;
			double heat = 0;

			delta_temperature = this.temperature_archived - model.temperature;

			if ( this.heat_capacity > 0 && Math.Abs( delta_temperature ) > 0.5 ) {
				heat = conduction_coefficient * delta_temperature * ( this.heat_capacity * model.heat_capacity / ( this.heat_capacity + model.heat_capacity ) );
				this.temperature -= heat / this.heat_capacity;
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void copy_air( GasMixture copy = null ) {
			
			if ( this.air != null && copy != null ) {
				this.air.copy_from( copy );
			}
			return;
		}

		// Function from file: LINDA_turf_tile.dm
		public void copy_air_with_tile( Base_Data T = null ) {
			
			if ( T is Tile_Simulated && Lang13.Bool( ((dynamic)T).air ) && this.air != null ) {
				this.air.copy_from( ((dynamic)T).air );
			}
			return;
		}

		// Function from file: LINDA_system.dm
		public void atmos_spawn_air( int flag = 0, double? amount = null ) {
			GasMixture G = null;
			Gas_SleepingAgent T = null;

			
			if ( !Lang13.Bool( this.text ) || !Lang13.Bool( amount ) || !( this.air != null ) ) {
				return;
			}
			G = new GasMixture();

			if ( ( flag & 2 ) != 0 ) {
				G.temperature = 293.41;
			}

			if ( ( flag & 1 ) != 0 ) {
				G.temperature += 1000;
			}

			if ( ( flag & 4 ) != 0 ) {
				G.toxins += amount ??0;
			}

			if ( ( flag & 8 ) != 0 ) {
				G.oxygen += amount ??0;
			}

			if ( ( flag & 16 ) != 0 ) {
				G.carbon_dioxide += amount ??0;
			}

			if ( ( flag & 32 ) != 0 ) {
				G.nitrogen += amount ??0;
			}

			if ( ( flag & 64 ) != 0 ) {
				T = new Gas_SleepingAgent();
				T.moles += amount ??0;
				G.trace_gases.Add( T );
			}

			if ( ( flag & 256 ) != 0 ) {
				G.oxygen += ( amount ??0) * 21.83659553527832;
				G.nitrogen += ( amount ??0) * 82.14720153808594;
			}
			this.air.merge( G );
			GlobalVars.SSair.add_to_active( this, false );
			return;
		}

		// Function from file: turf.dm
		public void Assimilate_Air(  ) {
			double aoxy = 0;
			double anitro = 0;
			double aco = 0;
			double atox = 0;
			double atemp = 0;
			int turf_count = 0;
			dynamic direction = null;
			Tile T = null;
			Tile S = null;

			
			if ( this.air != null ) {
				aoxy = 0;
				anitro = 0;
				aco = 0;
				atox = 0;
				atemp = 0;
				turf_count = 0;

				foreach (dynamic _a in Lang13.Enumerate( GlobalVars.cardinal )) {
					direction = _a;
					
					T = Map13.GetStep( this, Convert.ToInt32( direction ) );

					if ( T is Tile_Space ) {
						turf_count++;
						continue;
					} else if ( T is Tile_Simulated_Floor ) {
						S = T;

						if ( Lang13.Bool( ((dynamic)S).air ) ) {
							aoxy += Convert.ToDouble( ((dynamic)S).air.oxygen );
							anitro += Convert.ToDouble( ((dynamic)S).air.nitrogen );
							aco += Convert.ToDouble( ((dynamic)S).air.carbon_dioxide );
							atox += Convert.ToDouble( ((dynamic)S).air.toxins );
							atemp += Convert.ToDouble( ((dynamic)S).air.temperature );
						}
						turf_count++;
					}
				}
				this.air.oxygen = aoxy / Num13.MaxInt( turf_count, 1 );
				this.air.nitrogen = anitro / Num13.MaxInt( turf_count, 1 );
				this.air.carbon_dioxide = aco / Num13.MaxInt( turf_count, 1 );
				this.air.toxins = atox / Num13.MaxInt( turf_count, 1 );
				this.air.temperature = atemp / Num13.MaxInt( turf_count, 1 );
				GlobalVars.SSair.add_to_active( this );
			}
			return;
		}

		// Function from file: simulated.dm
		public void MakeDry( int? wet_setting = null ) {
			wet_setting = wet_setting ?? 1;

			
			if ( ( this.wet ??0) > ( wet_setting ??0) ) {
				return;
			}
			this.wet = 0;

			if ( this.wet_overlay != null ) {
				this.overlays.Remove( this.wet_overlay );
			}
			return;
		}

		// Function from file: simulated.dm
		public virtual void MakeSlippery( int? wet_setting = null ) {
			wet_setting = wet_setting ?? 1;

			Tile_Simulated F = null;

			
			if ( ( this.wet ??0) >= ( wet_setting ??0) ) {
				return;
			}
			this.wet = wet_setting;

			if ( wet_setting != 0 ) {
				
				if ( this.wet_overlay != null ) {
					this.overlays.Remove( this.wet_overlay );
					this.wet_overlay = null;
				}
				F = this;

				if ( F is Tile_Simulated_Floor ) {
					this.wet_overlay = new Image( "icons/effects/water.dmi", this, "wet_floor_static" );
				} else {
					this.wet_overlay = new Image( "icons/effects/water.dmi", this, "wet_static" );
				}
				this.overlays.Add( this.wet_overlay );
			}
			Task13.Schedule( Rand13.Int( 790, 820 ), (Task13.Closure)(() => {
				
				if ( !( this is Tile_Simulated ) ) {
					return;
				}
				this.MakeDry( wet_setting );
				return;
			}));
			return;
		}

		// Function from file: simulated.dm
		public virtual void burn_tile(  ) {
			return;
		}

		// Function from file: atoms.dm
		public override bool add_blood( dynamic M = null ) {
			dynamic B = null;

			
			if ( !base.add_blood( (object)(M) ) ) {
				return false;
			}
			B = Lang13.FindIn( typeof(Obj_Effect_Decal_Cleanable_Blood), this.contents );

			if ( !Lang13.Bool( B ) ) {
				GlobalFuncs.blood_splatter( this, ((Mob_Living_Carbon)M).get_blood( M.vessel ), true );
				B = Lang13.FindIn( typeof(Obj_Effect_Decal_Cleanable_Blood), this.contents );
			}
			((Ent_Static)B).add_blood_list( M );
			return true;
		}

	}

}