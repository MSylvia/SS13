// FILE AUTOGENERATED BY SOM13. DO NOT EDIT YET.

using System;
using Somnium.Engine.ByImpl;

namespace Somnium.Game {
	class Obj_Effect_ProcHolder_Spell_AoeTurf_Veil : Obj_Effect_ProcHolder_Spell_AoeTurf {

		public ByTable blacklisted_lights = new ByTable(new object [] { typeof(Obj_Item_Device_Flashlight_Flare), typeof(Obj_Item_Device_Flashlight_Slime) });
		public bool admin_override = false;

		protected override void __FieldInit() {
			base.__FieldInit();

			this.panel = "Shadowling Abilities";
			this.charge_max = 150;
			this.human_req = 1;
			this.clothes_req = 0;
			this.range = 5;
			this.action_icon_state = "veil";
		}

		public Obj_Effect_ProcHolder_Spell_AoeTurf_Veil ( dynamic loc = null ) : base( (object)(loc) ) {
			
		}

		// Function from file: shadowling_abilities.dm
		public override bool cast( dynamic targets = null, dynamic thearea = null, dynamic user = null ) {
			thearea = thearea ?? Task13.User;

			dynamic T = null;
			Obj_Item F = null;
			Obj_Machinery_Light L = null;
			Obj_Machinery_Computer C = null;
			Obj_Effect_Glowshroom G = null;
			Mob_Living H = null;
			Mob_Living_Silicon_Robot borgie = null;

			
			if ( !this.shadowling_check( thearea ) && !this.admin_override ) {
				this.revert_cast();
				return false;
			}
			thearea.WriteMsg( "<span class='shadowling'>You silently disable all nearby lights.</span>" );

			foreach (dynamic _g in Lang13.Enumerate( targets )) {
				T = _g;
				

				foreach (dynamic _a in Lang13.Enumerate( T.contents, typeof(Obj_Item) )) {
					F = _a;
					
					this.extinguishItem( F );
				}

				foreach (dynamic _b in Lang13.Enumerate( T.contents, typeof(Obj_Machinery_Light) )) {
					L = _b;
					
					L.on = false;
					L.visible_message( "<span class='warning'>" + L + " flickers and falls dark.</span>" );
					L.update( false );
				}

				foreach (dynamic _c in Lang13.Enumerate( T.contents, typeof(Obj_Machinery_Computer) )) {
					C = _c;
					
					C.SetLuminosity( 0 );
					C.visible_message( "<span class='warning'>" + C + " grows dim, its screen barely readable.</span>" );
				}

				foreach (dynamic _d in Lang13.Enumerate( Map13.FetchInRangeExcludeThis( thearea, 7 ), typeof(Obj_Effect_Glowshroom) )) {
					G = _d;
					
					G.visible_message( "<span class='warning'>" + G + " withers away!</span>" );
					GlobalFuncs.qdel( G );
				}

				foreach (dynamic _e in Lang13.Enumerate( T.contents, typeof(Mob_Living) )) {
					H = _e;
					
					this.extinguishMob( H );
				}

				foreach (dynamic _f in Lang13.Enumerate( T.contents, typeof(Mob_Living_Silicon_Robot) )) {
					borgie = _f;
					
					borgie.update_headlamp( true );
				}
			}
			return false;
		}

		// Function from file: shadowling_abilities.dm
		public void extinguishMob( Mob_Living H = null ) {
			double blacklistLuminosity = 0;
			Obj_Item F = null;

			blacklistLuminosity = 0;

			foreach (dynamic _a in Lang13.Enumerate( H, typeof(Obj_Item) )) {
				F = _a;
				
				blacklistLuminosity += this.extinguishItem( F );
			}
			H.SetLuminosity( blacklistLuminosity );
			return;
		}

		// Function from file: shadowling_abilities.dm
		public double extinguishItem( Obj_Item I = null ) {
			Obj_Item F = null;
			Obj_Item P = null;

			
			if ( I is Obj_Item_Device_Flashlight ) {
				F = I;

				if ( Lang13.Bool( ((dynamic)F).on ) ) {
					
					if ( GlobalFuncs.is_type_in_list( I, this.blacklisted_lights ) ) {
						I.visible_message( "<span class='danger'>" + I + " dims slightly before scattering the shadows around it.</span>" );
						return Convert.ToDouble( ((dynamic)F).brightness_on );
					}
					((dynamic)F).on = 0;
					((dynamic)F).update_brightness();
				}
			} else if ( I is Obj_Item_Device_Pda ) {
				P = I;
				((dynamic)P).fon = 0;
			}
			I.SetLuminosity( 0 );
			return I.luminosity;
		}

	}

}